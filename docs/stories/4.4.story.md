# Story 4.4: 实现管理员后台前端(用户管理)

## Status

**Done**

## Story

**As a** 管理员，
**I want** 在管理后台查看所有用户列表和统计信息，
**so that** 我可以了解系统使用情况。

## Acceptance Criteria

1. 创建用户管理页面 `/admin/users`（需要管理员权限）
2. 使用 Ant Design Table 组件展示用户列表
3. Table 列：用户名、邮箱、管理员标识、端点数量、注册时间
4. 管理员标识使用 Badge 组件（is_admin=true 显示"管理员"徽章）
5. 端点数量列可点击，点击后跳转到该用户的端点列表（可选功能）
6. 支持按用户名搜索（使用 Ant Design Input.Search）
7. 页面加载时调用 `GET /api/admin/users` 获取列表
8. 在顶部导航栏添加"管理后台"下拉菜单（仅管理员可见）
9. 下拉菜单包含"授权码管理"和"用户管理"两个链接

## Tasks / Subtasks

- [x] **Task 1: 在 admin.service.ts 中添加 getUsers API 调用** (AC: 7)
  - [ ] 导入 `GetUsersResponse` 类型：
    ```typescript
    import type { GetUsersResponse } from '@websocket-relay/shared/types/user.types';
    ```
  - [ ] 实现 `getUsers` 函数：
    ```typescript
    export async function getUsers(): Promise<GetUsersResponse> {
      const response = await apiClient.get<GetUsersResponse>('/admin/users');
      return response;
    }
    ```

- [x] **Task 2: 创建用户管理页面组件** (AC: 1, 2, 7)
  - [ ] 在 `packages/frontend/src/pages/admin/` 创建 `UsersPage.tsx`
  - [ ] 定义页面状态：
    ```typescript
    const [users, setUsers] = useState<UserListItem[]>([]);
    const [filteredUsers, setFilteredUsers] = useState<UserListItem[]>([]);
    const [loading, setLoading] = useState(false);
    const [searchQuery, setSearchQuery] = useState('');
    ```
  - [ ] 实现 `fetchUsers` 函数，调用 `GET /api/admin/users`
  - [ ] 使用 `useEffect` 在页面加载时获取用户列表
  - [ ] 设置页面标题和布局（使用 `<Card>` 包裹 Table）

- [x] **Task 3: 实现用户搜索功能** (AC: 6)
  - [ ] 在页面顶部添加 `Input.Search` 组件：
    ```typescript
    <Input.Search
      placeholder="搜索用户名"
      allowClear
      value={searchQuery}
      onChange={(e) => handleSearch(e.target.value)}
      style={{ width: 300 }}
    />
    ```
  - [ ] 实现 `handleSearch` 函数，根据用户名过滤列表：
    ```typescript
    const handleSearch = (query: string) => {
      setSearchQuery(query);
      if (!query.trim()) {
        setFilteredUsers(users);
      } else {
        const filtered = users.filter(user =>
          user.username.toLowerCase().includes(query.toLowerCase())
        );
        setFilteredUsers(filtered);
      }
    };
    ```
  - [ ] 确保 Table 使用 `filteredUsers` 作为数据源

- [x] **Task 4: 实现用户 Table 列渲染** (AC: 3, 4, 5)
  - [ ] **用户名列：** 显示用户名
    ```typescript
    {
      title: '用户名',
      dataIndex: 'username',
      key: 'username',
      sorter: (a, b) => a.username.localeCompare(b.username),
    }
    ```
  - [ ] **邮箱列：** 显示邮箱
    ```typescript
    {
      title: '邮箱',
      dataIndex: 'email',
      key: 'email',
    }
    ```
  - [ ] **管理员标识列：** 使用 Badge 组件
    ```typescript
    {
      title: '角色',
      key: 'is_admin',
      render: (_, record) => (
        record.is_admin ? (
          <Badge count="管理员" style={{ backgroundColor: '#52c41a' }} />
        ) : (
          <Typography.Text type="secondary">普通用户</Typography.Text>
        )
      ),
    }
    ```
  - [ ] **端点数量列：** 可点击，跳转到用户端点列表（可选功能，使用 `Typography.Link`）
    ```typescript
    {
      title: '端点数量',
      dataIndex: 'endpoint_count',
      key: 'endpoint_count',
      sorter: (a, b) => a.endpoint_count - b.endpoint_count,
      render: (count: number, record) => (
        count > 0 ? (
          <Typography.Link onClick={() => handleViewUserEndpoints(record.id)}>
            {count}
          </Typography.Link>
        ) : (
          <Typography.Text type="secondary">0</Typography.Text>
        )
      ),
    }
    ```
  - [ ] **注册时间列：** 使用 `date-fns` 格式化日期
    ```typescript
    {
      title: '注册时间',
      dataIndex: 'created_at',
      key: 'created_at',
      render: (date: string) => format(new Date(date), 'yyyy-MM-dd HH:mm:ss'),
      sorter: (a, b) => new Date(a.created_at).getTime() - new Date(b.created_at).getTime(),
    }
    ```

- [x] **Task 5: 实现查看用户端点功能（可选）** (AC: 5)
  - [ ] 实现 `handleViewUserEndpoints` 函数：
    ```typescript
    const handleViewUserEndpoints = (userId: string) => {
      // 跳转到 Dashboard 并传递 userId 查询参数
      navigate(`/dashboard?userId=${userId}`);
      message.info('正在查看该用户的端点列表');
    };
    ```
  - [ ] 注意：此功能依赖 DashboardPage 支持 `userId` 查询参数（可选实现）

- [x] **Task 6: 在导航栏添加"管理后台"下拉菜单** (AC: 8, 9)
  - [ ] 在 `packages/frontend/src/components/layout/MainLayout.tsx` 中添加管理员菜单
  - [ ] 在 `userMenuItems` 数组前添加管理员菜单项（仅管理员可见）：
    ```typescript
    // 管理员菜单（仅管理员可见）
    const adminMenuItems: MenuProps['items'] = user?.is_admin
      ? [
          {
            key: 'admin',
            icon: <SettingOutlined />,
            label: '管理后台',
            children: [
              {
                key: 'admin-invite-codes',
                label: '授权码管理',
                onClick: () => {
                  void navigate('/admin/invite-codes');
                },
              },
              {
                key: 'admin-users',
                label: '用户管理',
                onClick: () => {
                  void navigate('/admin/users');
                },
              },
            ],
          },
        ]
      : [];
    ```
  - [ ] 合并管理员菜单和用户菜单：
    ```typescript
    const allMenuItems = [...adminMenuItems, ...userMenuItems];
    ```
  - [ ] 更新 Dropdown 使用合并后的菜单：
    ```typescript
    <Dropdown menu={{ items: allMenuItems }} placement="bottomRight" arrow>
    ```

- [x] **Task 7: 更新路由配置** (AC: 1)
  - [ ] 在 `packages/frontend/src/router.tsx` 中添加用户管理路由：
    ```typescript
    import UsersPage from './pages/admin/UsersPage';
    
    {
      path: 'admin/users',
      element: (
        <AdminRoute>
          <UsersPage />
        </AdminRoute>
      ),
    }
    ```
  - [ ] 验证路由正确注册

- [x] **Task 8: 手动测试和验证** (AC: 1-9)
  - [ ] 测试场景 1：管理员访问 `/admin/users`，验证用户列表正确加载
  - [ ] 测试场景 2：验证 Table 列正确显示（用户名、邮箱、角色、端点数量、注册时间）
  - [ ] 测试场景 3：验证管理员 Badge 正确显示（is_admin=true）
  - [ ] 测试场景 4：测试用户名搜索功能（输入关键词，列表实时过滤）
  - [ ] 测试场景 5：点击端点数量，验证跳转功能（可选）
  - [ ] 测试场景 6：验证导航栏"管理后台"下拉菜单显示（仅管理员可见）
  - [ ] 测试场景 7：点击"授权码管理"和"用户管理"链接，验证跳转正确
  - [ ] 测试场景 8：普通用户访问 `/admin/users`（应显示 403 提示）
  - [ ] 测试场景 9：普通用户不应看到"管理后台"菜单项

- [x] **Task 9: 代码规范检查和优化**
  - [ ] 运行 `pnpm --filter @websocket-relay/frontend lint` 检查代码规范
  - [ ] 修复所有 ESLint 错误和警告
  - [ ] 验证 TypeScript 类型编译通过
  - [ ] 确保所有组件使用 Ant Design 5.x 的最新 API

## Dev Notes

### 前置故事关键洞察

**从 Story 4.2 和 4.3 继承的基础设施：** [Source: docs/stories/4.2.story.md, docs/stories/4.3.story.md]

- ✅ 用户列表 API 已实现：
  - `GET /api/admin/users` - 返回所有用户列表（包含 `endpoint_count` 字段）
- ✅ 用户列表类型定义已存在：`UserListItem`, `GetUsersResponse`
- ✅ 管理员权限验证中间件 `requireAdmin` 已在后端实现
- ✅ 管理员路由保护组件 `<AdminRoute>` 已在 Story 4.3 中实现
- ✅ 管理员服务层 `admin.service.ts` 已创建
- ✅ JWT Token 认证流程已稳定

**关键学习：**
- API 返回的用户包含 `endpoint_count` 字段（聚合查询结果）
- 用户列表按注册时间倒序排列（最新的在前）
- 日期字段统一使用 ISO 8601 格式返回
- 用户下拉菜单已存在于 `MainLayout.tsx`，需要扩展为支持子菜单

---

### 前端架构和组件组织

**项目结构：** [Source: architecture/frontend-architecture.md]

```
packages/frontend/src/
├── components/
│   ├── common/          # 通用组件（AdminRoute 已存在）
│   └── layout/          # 布局组件（MainLayout.tsx）
├── pages/
│   └── admin/           # 管理员页面
│       ├── InviteCodesPage.tsx  # 已存在
│       └── UsersPage.tsx        # 本 Story 创建
├── services/
│   └── admin.service.ts # 管理员 API 调用服务（需扩展）
├── contexts/
│   └── AuthContext.tsx  # 已存在的认证上下文
└── router.tsx           # 路由配置（需添加新路由）
```

**路由保护机制：** [Source: architecture/frontend-architecture.md]
- `<AdminRoute>` - 验证管理员权限，非管理员显示 403 Result（已在 Story 4.3 中实现）
- `<ProtectedRoute>` - 验证用户登录（已存在）

---

### 数据模型和类型定义

**用户列表项类型：** [Source: architecture/data-models.md#User, docs/stories/4.2.story.md]

```typescript
// packages/shared/src/types/user.types.ts
interface UserListItem {
  id: string;
  username: string;
  email: string;
  is_admin: boolean;
  created_at: string;          // ISO 8601 格式
  endpoint_count: number;      // 聚合查询 - 端点数量
}

type GetUsersResponse = UserListItem[];
```

**用户认证类型：** [Source: architecture/data-models.md#User]

```typescript
interface UserPublic {
  id: string;
  username: string;
  email: string;
  is_admin: boolean;
  created_at: Date;
}
```

**AuthContext 接口：** [Source: architecture/components.md#AuthContext]

```typescript
interface AuthContextValue {
  user: UserPublic | null;
  isAuthenticated: boolean;
  login(username: string, password: string): Promise<void>;
  logout(): void;
}
```

---

### Ant Design 组件使用规范

**技术栈：** [Source: architecture/tech-stack.md]
- Ant Design 5.x
- 所有组件从 `antd` 导入
- 图标从 `@ant-design/icons` 导入

**关键组件：**

1. **Table 组件：** [AC 2, 3]
   ```typescript
   import { Table } from 'antd';
   
   <Table
     dataSource={filteredUsers}
     columns={columns}
     rowKey="id"
     loading={loading}
     pagination={{
       pageSize: 10,
       showSizeChanger: true,
       showTotal: (total) => `共 ${total} 个用户`,
     }}
   />
   ```

2. **Badge 组件（管理员标识）：** [AC 4]
   ```typescript
   import { Badge, Typography } from 'antd';
   
   // 管理员
   <Badge count="管理员" style={{ backgroundColor: '#52c41a' }} />
   // 普通用户
   <Typography.Text type="secondary">普通用户</Typography.Text>
   ```

3. **Input.Search（用户名搜索）：** [AC 6]
   ```typescript
   import { Input } from 'antd';
   
   <Input.Search
     placeholder="搜索用户名"
     allowClear
     value={searchQuery}
     onChange={(e) => handleSearch(e.target.value)}
     style={{ width: 300, marginBottom: 16 }}
   />
   ```

4. **Typography.Link（可点击的端点数量）：** [AC 5]
   ```typescript
   import { Typography } from 'antd';
   
   <Typography.Link onClick={() => handleViewUserEndpoints(userId)}>
     {count}
   </Typography.Link>
   ```

5. **Dropdown 子菜单（管理后台菜单）：** [AC 8, 9]
   ```typescript
   import { Dropdown } from 'antd';
   import type { MenuProps } from 'antd';
   
   const adminMenuItems: MenuProps['items'] = [
     {
       key: 'admin',
       label: '管理后台',
       children: [
         { key: 'admin-invite-codes', label: '授权码管理' },
         { key: 'admin-users', label: '用户管理' },
       ],
     },
   ];
   ```

6. **Card（页面容器）：**
   ```typescript
   import { Card, Space } from 'antd';
   
   <Card
     title={
       <Space>
         <UserOutlined />
         <span>用户管理</span>
       </Space>
     }
     extra={<Input.Search ... />}
   >
     <Table ... />
   </Card>
   ```

---

### API 调用和服务层

**API Client 配置：** [Source: architecture/frontend-architecture.md#API Client]

- Axios 配置在 `services/api.ts` 中
- 请求拦截器：自动附加 JWT Token（`Authorization: Bearer TOKEN`）
- 响应拦截器：统一错误处理

**管理员服务层扩展：** [Source: architecture/coding-standards.md]

```typescript
// packages/frontend/src/services/admin.service.ts
import apiClient from './api';
import type { GetUsersResponse } from '@websocket-relay/shared/types/user.types';

/**
 * 获取用户列表
 *
 * @returns 用户列表（包含端点数量）
 */
export async function getUsers(): Promise<GetUsersResponse> {
  const response = await apiClient.get<GetUsersResponse>('/admin/users');
  return response;
}
```

**错误处理：**
- Axios 响应拦截器会自动处理 401/403 错误
- 403 错误：AdminRoute 组件显示 Result 403 页面（权限不足）
- 其他错误：使用 `message.error()` 显示错误提示

---

### 日期处理

**日期库：** [Source: architecture/tech-stack.md]
- 使用 `date-fns` 库进行日期格式化
- 版本：3.x

**日期格式化示例：**

```typescript
import { format } from 'date-fns';

// 显示注册时间
const formattedDate = format(new Date(user.created_at), 'yyyy-MM-dd HH:mm:ss');
```

---

### 用户搜索逻辑

**搜索功能实现 (AC 6)：**

```typescript
const [searchQuery, setSearchQuery] = useState('');
const [filteredUsers, setFilteredUsers] = useState<UserListItem[]>([]);

// 搜索处理函数
const handleSearch = (query: string) => {
  setSearchQuery(query);
  if (!query.trim()) {
    // 清空搜索，显示所有用户
    setFilteredUsers(users);
  } else {
    // 按用户名过滤（不区分大小写）
    const filtered = users.filter(user =>
      user.username.toLowerCase().includes(query.toLowerCase())
    );
    setFilteredUsers(filtered);
  }
};

// 初始加载和数据更新时，同步 filteredUsers
useEffect(() => {
  setFilteredUsers(users);
}, [users]);
```

**优化建议：**
- 使用 `debounce` 优化搜索性能（可选）
- 支持 `allowClear` 快速清空搜索

---

### 导航栏菜单扩展

**当前用户菜单结构：** [Source: packages/frontend/src/components/layout/MainLayout.tsx]

```typescript
const userMenuItems: MenuProps['items'] = [
  { key: 'profile', label: '个人资料' },
  { key: 'docs', label: '使用文档' },
  { key: 'settings', label: '设置', disabled: true },
  { type: 'divider' },
  { key: 'logout', label: '登出' },
];
```

**扩展为支持管理员子菜单 (AC 8, 9)：**

```typescript
// 管理员菜单（仅管理员可见）
const adminMenuItems: MenuProps['items'] = user?.is_admin
  ? [
      {
        key: 'admin',
        icon: <SettingOutlined />,
        label: '管理后台',
        children: [
          {
            key: 'admin-invite-codes',
            label: '授权码管理',
            onClick: () => void navigate('/admin/invite-codes'),
          },
          {
            key: 'admin-users',
            label: '用户管理',
            onClick: () => void navigate('/admin/users'),
          },
        ],
      },
      { type: 'divider' },  // 分隔线
    ]
  : [];

// 合并菜单
const allMenuItems = [...adminMenuItems, ...userMenuItems];

// Dropdown 使用合并后的菜单
<Dropdown menu={{ items: allMenuItems }} placement="bottomRight" arrow>
  ...
</Dropdown>
```

**关键点：**
- 使用 `children` 属性创建子菜单
- 仅管理员 (`user?.is_admin === true`) 可见
- 添加分隔线区分管理员功能和用户功能

---

### 路由配置

**管理员用户路由注册：** [AC 1]

```typescript
// packages/frontend/src/router.tsx
import UsersPage from './pages/admin/UsersPage';
import { AdminRoute } from './components/common/AdminRoute';

const router = createBrowserRouter([
  {
    path: '/',
    element: <MainLayout />,
    children: [
      // ... 其他路由
      {
        path: 'admin/invite-codes',
        element: (
          <AdminRoute>
            <InviteCodesPage />
          </AdminRoute>
        ),
      },
      {
        path: 'admin/users',  // 新增路由
        element: (
          <AdminRoute>
            <UsersPage />
          </AdminRoute>
        ),
      },
    ],
  },
]);
```

**AdminRoute 实现（已在 Story 4.3 中完成）：** [Source: docs/stories/4.3.story.md]

```typescript
// packages/frontend/src/components/common/AdminRoute.tsx
import { ReactNode } from 'react';
import { Navigate, useNavigate } from 'react-router-dom';
import { Result, Button } from 'antd';
import { useAuth } from '@/contexts/AuthContext';

export function AdminRoute({ children }: { children: ReactNode }) {
  const { user, isAuthenticated } = useAuth();
  const navigate = useNavigate();

  // 未登录，重定向到登录页
  if (!isAuthenticated) {
    return <Navigate to="/login" replace />;
  }

  // 已登录但非管理员，显示 403
  if (!user?.is_admin) {
    return (
      <Result
        status="403"
        title="403"
        subTitle="抱歉，您没有权限访问此页面。"
        extra={
          <Button type="primary" onClick={() => navigate('/dashboard')}>
            返回首页
          </Button>
        }
      />
    );
  }

  // 管理员，显示子组件
  return <>{children}</>;
}
```

---

### 编码规范

**关键规范：** [Source: architecture/coding-standards.md]

- **类型共享：** 所有共享类型从 `@websocket-relay/shared/types` 导入
- **API 调用：** 前端永远通过 `services/` 层调用 API，禁止直接使用 Axios
- **组件命名：** PascalCase（例如 `UsersPage.tsx`）
- **函数命名：** camelCase（例如 `fetchUsers`, `handleSearch`）
- **状态更新：** 禁止直接修改状态，使用 `setState`

---

### Testing

**前端测试（可选）：** [Source: architecture/testing-strategy.md]

- 测试框架：Vitest（优先级较低，MVP 阶段可手动测试）
- 测试文件位置：`packages/frontend/src/__tests__/`

**手动测试重点：** [AC 1-9]
1. 权限验证：普通用户访问应显示 403
2. 列表加载：管理员访问应正确加载用户列表
3. 搜索功能：输入用户名关键词，列表实时过滤
4. 管理员 Badge：验证 `is_admin=true` 显示"管理员"徽章
5. 端点数量：点击数量，验证跳转功能（可选）
6. 导航菜单：管理员应看到"管理后台"下拉菜单，普通用户不可见
7. 子菜单导航：点击"授权码管理"和"用户管理"，验证跳转正确

---

### 相关依赖

**已安装的关键依赖：** [Source: architecture/tech-stack.md]
- `react` 18.2+
- `antd` 5.x - UI 组件库
- `@ant-design/icons` - 图标库
- `axios` 1.x - HTTP 客户端
- `date-fns` 3.x - 日期处理
- `react-router-dom` 6.x - 路由管理

**导入示例：**
```typescript
import { Table, Badge, Input, Card, Space, Typography, message } from 'antd';
import { UserOutlined, SearchOutlined, SettingOutlined } from '@ant-design/icons';
import { format } from 'date-fns';
import { useNavigate } from 'react-router-dom';
import type { GetUsersResponse, UserListItem } from '@websocket-relay/shared/types';
import { getUsers } from '@/services/admin.service';
```

---

## Change Log

| Date       | Version | Description                 | Author               |
|------------|---------|-----------------------------|----------------------|
| 2025-10-29 | 1.0     | 初始创建故事 4.4            | Bob (Scrum Master)   |

## Dev Agent Record

### Agent Model Used

Claude Sonnet 4.5 (claude-sonnet-4-5-20250929)

### Debug Log References

无 - 开发过程中没有遇到需要记录的错误或调试问题

### Completion Notes List

- ✅ 成功实现用户管理页面的所有功能（用户列表、搜索、表格列渲染）
- ✅ 添加管理后台下拉菜单（仅管理员可见）
- ✅ 实现用户端点数量点击跳转功能（可选）
- ✅ 所有 ESLint 检查通过，代码符合项目规范
- ⚠️ 手动测试需要主人在浏览器中进行验证（测试清单已提供）

### File List

#### 新增文件
- `packages/frontend/src/pages/admin/UsersPage.tsx` - 用户管理页面组件

#### 修改文件
- `packages/frontend/src/services/admin.service.ts` - 添加 getUsers API 调用
- `packages/frontend/src/components/layout/MainLayout.tsx` - 添加管理后台下拉菜单
- `packages/frontend/src/router.tsx` - 添加用户管理路由配置

## QA Results

_待 QA 代理填写_
