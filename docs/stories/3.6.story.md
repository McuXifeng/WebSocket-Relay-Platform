# Story 3.6: 实现获取端点实时统计数据 API

## Status

**Ready for Review**

## Story

**As a** 后端开发者,
**I want** 实现获取端点实时统计数据的 API,
**so that** 前端可以展示当前连接数和消息统计。

## Acceptance Criteria

1. 实现 `GET /api/endpoints/:id/stats` API(需要 JWT 认证)
2. 验证端点属于当前登录用户
3. 从 EndpointStats 表查询统计数据
4. 返回 `{ current_connections, total_connections, total_messages, last_active_at }`
5. 如果 EndpointStats 记录不存在,返回默认值:`{ current_connections: 0, total_connections: 0, total_messages: 0, last_active_at: null }`
6. 如果端点不存在或无权访问,返回 403/404 错误
7. 使用 Postman 测试 API,验证返回数据正确

## Tasks / Subtasks

- [x] **Task 1: 在 shared 包中定义统计数据类型** (AC: 4, 5)
  - [x] 在 `packages/shared/src/types/` 创建或更新端点类型文件
  - [x] 定义 `EndpointStatsResponse` 接口,包含字段:`current_connections`, `total_connections`, `total_messages`, `last_active_at`
  - [x] 导出类型供前后端共享使用
  - [x] 在 `packages/shared/src/types/index.ts` 中统一导出

- [x] **Task 2: 创建统计查询服务函数** (AC: 3, 5)
  - [x] 在 `packages/backend/src/services/stats.service.ts` 中新增 `getEndpointStats(endpointId: string)` 函数
  - [x] 查询 `EndpointStats` 表,使用 Prisma 的 `findUnique` 方法
  - [x] 包含 `endpoint` 关联查询以获取 `last_active_at` 字段
  - [x] 如果统计记录不存在,返回默认值对象:`{ current_connections: 0, total_connections: 0, total_messages: 0, last_active_at: null }`
  - [x] 函数返回类型使用 `packages/shared` 中定义的 `EndpointStatsResponse` 类型

- [x] **Task 3: 创建统计数据 Controller** (AC: 1, 2, 6)
  - [x] 在 `packages/backend/src/controllers/endpoint.controller.ts` 中新增 `getEndpointStats` 函数
  - [x] 从 `req.user.userId` 获取当前用户 ID(JWT 认证提供)
  - [x] 从 `req.params.id` 获取端点 ID(数据库主键)
  - [x] 调用 `endpoint.service.getEndpointById()` 验证端点存在且属于当前用户(复用现有逻辑)
  - [x] 调用 `stats.service.getEndpointStats()` 获取统计数据
  - [x] 返回 200 响应,数据格式:`{ data: { current_connections, total_connections, total_messages, last_active_at } }`
  - [x] 错误通过 `next(error)` 传递给错误处理中间件

- [x] **Task 4: 添加 API 路由** (AC: 1)
  - [x] 在 `packages/backend/src/routes/endpoint.route.ts` 中新增路由
  - [x] 路由路径:`GET /:id/stats`
  - [x] 应用 `authenticateToken` 中间件保护路由
  - [x] 绑定到 `endpointController.getEndpointStats` 处理函数

- [x] **Task 5: 编写单元测试** (AC: 3, 5)
  - [x] 在 `packages/backend/tests/unit/services/` 中创建或更新 `stats.service.test.ts`
  - [x] 测试 `getEndpointStats()` 返回正确的统计数据
  - [x] 测试统计记录不存在时返回默认值
  - [x] 使用 Jest 和 Prisma Mock

- [x] **Task 6: 编写集成测试** (AC: 1, 2, 6, 7)
  - [x] 在 `packages/backend/tests/integration/` 创建 `endpoint-stats.api.test.ts`
  - [x] 测试有效请求返回统计数据 (200)
  - [x] 测试端点不存在返回 404
  - [x] 测试无权访问返回 403
  - [x] 测试未认证请求返回 401
  - [x] 测试统计记录不存在时返回默认值
  - [x] 使用 `supertest` 进行 API 测试

- [x] **Task 7: 手动测试验证** (AC: 7)
  - [x] 启动后端服务:`pnpm --filter @websocket-relay/backend dev`
  - [x] 使用 Postman 或 curl 测试 API
  - [x] 测试场景 1:获取有统计数据的端点
  - [x] 测试场景 2:获取无统计数据的端点(验证默认值)
  - [x] 测试场景 3:无权访问的端点(403)
  - [x] 测试场景 4:不存在的端点 ID(404)

- [x] **Task 8: 代码规范检查**
  - [x] 运行 `pnpm lint` 检查代码风格
  - [x] 运行 `pnpm format` 格式化代码
  - [x] 确保新增代码无 lint 错误

## Dev Notes

### Previous Story Insights

**从 Story 3.5 中学到的关键经验:**

1. **EndpointStats 数据模型已创建**:
   - `EndpointStats` 模型已在 Story 3.5 中成功创建并迁移
   - 包含字段:`id`, `endpoint_id`, `current_connections`, `total_connections`, `total_messages`, `updated_at`
   - One-to-One 关系:`EndpointStats` → `Endpoint` (通过 `endpoint_id` 外键)

2. **统计更新服务已实现**:
   - `stats.service.ts` 已存在,包含 `updateEndpointStats()` 函数
   - 使用 Prisma `upsert` 操作确保记录存在
   - 统计数据在连接建立、断开和消息发送时自动更新

3. **Endpoint 的 last_active_at 字段**:
   - `Endpoint` 表的 `last_active_at` 字段在消息发送时更新
   - 需要在查询统计时一并返回此字段

4. **错误处理模式**:
   - 使用 `AppError` 类抛出业务错误
   - 错误通过 `next(error)` 传递给统一错误处理中间件
   - Controller 层不直接返回错误响应

[Previous Story: docs/stories/3.5.story.md]

---

### Data Models

**EndpointStats 数据模型:**

根据 data-models.md 和 Story 3.5,`EndpointStats` 模型定义如下:

```typescript
interface EndpointStats {
  id: string;                    // UUID 主键
  endpoint_id: string;           // 关联的端点数据库 ID (外键到 Endpoint.id)
  current_connections: number;   // 当前在线连接数
  total_connections: number;     // 累计连接总数
  total_messages: number;        // 累计消息总数
  updated_at: Date;              // 最后更新时间(自动更新)
}
```

**Endpoint 相关字段:**

```typescript
interface Endpoint {
  id: string;              // UUID 主键
  endpoint_id: string;     // 8-12 位随机 ID
  name: string;
  user_id: string;
  created_at: Date;
  last_active_at: Date | null;  // 最后活跃时间
}
```

**API 响应类型定义 (需要在 shared 中创建):**

```typescript
interface EndpointStatsResponse {
  current_connections: number;
  total_connections: number;
  total_messages: number;
  last_active_at: Date | null;
}
```

**关系定义:**
- One-to-One: `EndpointStats` → `Endpoint` (通过 `endpoint_id` 外键)
- 级联删除:删除 `Endpoint` 时自动删除对应的 `EndpointStats` 记录

[Source: docs/architecture/data-models.md#EndpointStats, docs/stories/3.5.story.md]

---

### API Specifications

**路由定义:**

```
GET /api/endpoints/:id/stats
```

**参数:**
- `id` (路径参数): 端点数据库 UUID (不是 endpoint_id)

**请求头:**
```
Authorization: Bearer <JWT_TOKEN>
```

**成功响应 (200 OK):**

```json
{
  "data": {
    "current_connections": 2,
    "total_connections": 15,
    "total_messages": 48,
    "last_active_at": "2025-10-28T08:45:30.000Z"
  }
}
```

**默认值响应 (200 OK,统计记录不存在时):**

```json
{
  "data": {
    "current_connections": 0,
    "total_connections": 0,
    "total_messages": 0,
    "last_active_at": null
  }
}
```

**错误响应:**

- **401 Unauthorized**: 未提供 JWT Token 或 Token 无效
  ```json
  {
    "error": {
      "code": "UNAUTHORIZED",
      "message": "用户认证信息无效",
      "status": 401
    }
  }
  ```

- **404 Not Found**: 端点不存在
  ```json
  {
    "error": {
      "code": "ENDPOINT_NOT_FOUND",
      "message": "端点不存在",
      "status": 404
    }
  }
  ```

- **403 Forbidden**: 端点不属于当前用户
  ```json
  {
    "error": {
      "code": "FORBIDDEN",
      "message": "无权访问此端点",
      "status": 403
    }
  }
  ```

[Source: 参考现有 endpoint.controller.ts 和 backend-architecture.md]

---

### Service Layer Implementation

**stats.service.ts 新增函数:**

```typescript
/**
 * 查询端点统计数据
 *
 * @param endpointId - 端点数据库 UUID (Endpoint.id)
 * @returns 统计数据,如果不存在返回默认值
 */
export async function getEndpointStats(endpointId: string): Promise<EndpointStatsResponse> {
  // 查询统计记录,同时包含 endpoint 关联以获取 last_active_at
  const stats = await prisma.endpointStats.findUnique({
    where: { endpoint_id: endpointId },
    include: {
      endpoint: {
        select: { last_active_at: true }
      }
    }
  });

  // 如果统计记录不存在,返回默认值
  if (!stats) {
    return {
      current_connections: 0,
      total_connections: 0,
      total_messages: 0,
      last_active_at: null,
    };
  }

  // 返回统计数据
  return {
    current_connections: stats.current_connections,
    total_connections: stats.total_connections,
    total_messages: stats.total_messages,
    last_active_at: stats.endpoint.last_active_at,
  };
}
```

**关键实现要点:**

1. **使用 Prisma `include`**: 关联查询 `endpoint` 以获取 `last_active_at` 字段
2. **默认值处理**: 统计记录不存在时返回所有字段为 0 或 null 的对象
3. **类型安全**: 使用 shared 包中定义的 `EndpointStatsResponse` 类型
4. **无错误抛出**: 统计不存在不是错误情况,返回默认值即可

[Source: docs/architecture/backend-architecture.md#Service Architecture, 参考 endpoint.service.ts]

---

### Controller Layer Implementation

**endpoint.controller.ts 新增函数:**

```typescript
/**
 * 获取端点统计数据控制器
 *
 * @route GET /api/endpoints/:id/stats
 * @param req - Express 请求对象,包含端点 ID
 * @param res - Express 响应对象
 * @param next - Express 下一个中间件函数
 */
export async function getEndpointStats(
  req: Request,
  res: Response,
  next: NextFunction
): Promise<void> {
  try {
    // 从 req.user 获取 userId (由 authenticateToken 中间件附加)
    const userId = req.user?.userId;

    if (!userId) {
      throw new AppError('UNAUTHORIZED', '用户认证信息无效', 401);
    }

    // 从路由参数获取端点 ID
    const endpointId = req.params.id;

    // 1. 验证端点存在且属于当前用户 (复用现有函数)
    await endpointService.getEndpointById(endpointId, userId as string);

    // 2. 获取统计数据
    const stats = await statsService.getEndpointStats(endpointId);

    // 3. 返回成功响应 (200 OK)
    res.status(200).json({
      data: stats,
    });
  } catch (error) {
    // 将错误传递给错误处理中间件
    next(error);
  }
}
```

**关键实现要点:**

1. **复用权限验证**: 调用 `endpointService.getEndpointById()` 验证端点存在和权限,如果失败会抛出 404/403 错误
2. **统一响应格式**: 使用 `{ data: {...} }` 格式与其他 API 保持一致
3. **错误传递**: 所有错误通过 `next(error)` 传递给统一错误处理中间件
4. **类型断言**: 使用 `userId as string` 断言类型(已在 if 中验证)

[Source: 参考现有 endpoint.controller.ts 实现模式]

---

### Project Structure Alignment

**本故事需要创建/修改的文件:**

根据 unified-project-structure.md:

```
packages/
├── shared/
│   └── src/
│       └── types/
│           ├── endpoint.types.ts           # 修改:添加 EndpointStatsResponse 类型
│           └── index.ts                    # 修改:导出新类型
├── backend/
│   ├── src/
│   │   ├── controllers/
│   │   │   └── endpoint.controller.ts     # 修改:添加 getEndpointStats 函数
│   │   ├── services/
│   │   │   └── stats.service.ts           # 修改:添加 getEndpointStats 函数
│   │   └── routes/
│   │       └── endpoint.route.ts          # 修改:添加 GET /:id/stats 路由
│   └── tests/
│       ├── unit/
│       │   └── services/
│       │       └── stats.service.test.ts  # 修改:添加查询测试
│       └── integration/
│           └── endpoint-stats.api.test.ts # 新建:API 集成测试
```

**命名规范:**
- Service 函数使用 camelCase:`getEndpointStats()`
- 路由路径使用 kebab-case:`/:id/stats`
- 类型使用 PascalCase:`EndpointStatsResponse`
- 文件使用 kebab-case:`endpoint-stats.api.test.ts`

[Source: docs/architecture/unified-project-structure.md, docs/architecture/coding-standards.md]

---

### Authentication and Authorization

**JWT 认证流程:**

1. 客户端请求附加 `Authorization: Bearer <TOKEN>` 请求头
2. `authenticateToken` 中间件验证 Token 有效性
3. 中间件将解码的 payload 附加到 `req.user` (包含 `userId`, `username`, `isAdmin`)
4. Controller 从 `req.user.userId` 获取当前用户 ID

**权限验证:**

- 调用 `endpointService.getEndpointById()` 确保:
  - 端点存在 (否则抛出 404)
  - 端点属于当前用户 (否则抛出 403)
- 复用现有权限验证逻辑,保持代码 DRY 原则

[Source: docs/architecture/backend-architecture.md#Authentication]

---

### Error Handling

**使用统一的 AppError 类:**

```typescript
throw new AppError('ERROR_CODE', 'Error message', statusCode);
```

**本 API 可能的错误:**

| 错误码 | HTTP 状态 | 触发条件 |
|--------|----------|---------|
| `UNAUTHORIZED` | 401 | JWT Token 无效或缺失 |
| `ENDPOINT_NOT_FOUND` | 404 | 端点不存在 |
| `FORBIDDEN` | 403 | 端点不属于当前用户 |

**错误处理流程:**

1. Controller 抛出 `AppError` 或其他错误
2. 通过 `next(error)` 传递给错误处理中间件
3. 中间件统一格式化错误响应

**重要**: 统计记录不存在不是错误,应返回默认值而非抛出错误

[Source: docs/architecture/coding-standards.md#Error Handling, 参考 endpoint.service.ts]

---

### Testing

**测试组织:**

根据 testing-strategy.md,本故事需要编写以下测试:

**1. 单元测试 (packages/backend/tests/unit/services/stats.service.test.ts):**

测试场景:
- `getEndpointStats()` 返回正确的统计数据
- 统计记录不存在时返回默认值
- 验证 `last_active_at` 字段正确包含

**2. 集成测试 (packages/backend/tests/integration/endpoint-stats.api.test.ts):**

测试场景:
- `GET /api/endpoints/:id/stats` 返回 200 和正确数据
- 端点不存在返回 404
- 无权访问返回 403
- 未认证请求返回 401
- 统计记录不存在时返回默认值

**测试工具:**
- Jest (测试框架)
- Supertest (API 测试)
- Prisma Mock (模拟数据库)

**测试执行命令:**

```bash
# 运行所有测试
pnpm test

# 运行单元测试
pnpm --filter @websocket-relay/backend test:unit

# 运行集成测试
pnpm --filter @websocket-relay/backend test:integration
```

[Source: docs/architecture/testing-strategy.md]

---

### Type Sharing (Critical!)

**共享类型定义位置:**

所有前后端共享的类型必须定义在 `packages/shared/src/types/`

**本故事需要创建的类型:**

在 `packages/shared/src/types/endpoint.types.ts` 中:

```typescript
/**
 * 端点统计数据响应类型
 */
export interface EndpointStatsResponse {
  current_connections: number;
  total_connections: number;
  total_messages: number;
  last_active_at: Date | null;
}
```

**导出方式:**

在 `packages/shared/src/types/index.ts` 中添加:

```typescript
export type { EndpointStatsResponse } from './endpoint.types';
```

**前后端使用:**

```typescript
// 后端 Service
import type { EndpointStatsResponse } from '@websocket-relay/shared';

// 前端 Service (Story 3.7 使用)
import type { EndpointStatsResponse } from '@websocket-relay/shared';
```

[Source: docs/architecture/coding-standards.md#Critical Fullstack Rules - Type Sharing]

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-28 | 1.0 | 初始创建故事 3.6 | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used

Claude Sonnet 4.5 (claude-sonnet-4-5-20250929)

### Debug Log References

无需调试,开发过程顺利

### Completion Notes List

1. **类型定义** - 在 `packages/shared/src/types/endpoint.types.ts` 中成功添加 `EndpointStatsResponse` 接口
2. **Service 层实现** - 在 `stats.service.ts` 中新增 `getEndpointStats()` 函数,使用 Prisma `findUnique` 查询,包含 `endpoint` 关联以获取 `last_active_at`
3. **Controller 层实现** - 在 `endpoint.controller.ts` 中新增 `getEndpointStats` 函数,复用现有的权限验证逻辑
4. **路由配置** - 在 `endpoint.route.ts` 中添加 `GET /:id/stats` 路由,应用 JWT 认证中间件
5. **单元测试** - 在 `stats.service.test.ts` 中添加 3 个测试用例,覆盖正常查询和默认值场景
6. **集成测试** - 创建 `endpoint-stats.api.test.ts`,包含 5 个测试用例,覆盖所有验收标准
7. **代码规范** - 通过 ESLint 检查,无新增错误,仅保留现有的警告
8. **测试验证** - 集成测试全部通过 (5/5),验证了所有验收标准

### File List

**新建文件:**
- `packages/backend/tests/integration/endpoint-stats.api.test.ts` - API 集成测试文件

**修改文件:**
- `packages/shared/src/types/endpoint.types.ts` - 添加 `EndpointStatsResponse` 接口
- `packages/shared/src/types/index.ts` - 导出新增类型
- `packages/backend/src/services/stats.service.ts` - 新增 `getEndpointStats()` 函数
- `packages/backend/src/controllers/endpoint.controller.ts` - 新增 `getEndpointStats` 控制器函数
- `packages/backend/src/routes/endpoint.route.ts` - 新增 `GET /:id/stats` 路由
- `packages/backend/tests/unit/services/stats.service.test.ts` - 添加单元测试用例

## QA Results

待 QA 代理填写
