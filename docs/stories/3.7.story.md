# Story 3.7: 前端展示端点实时连接数和统计数据

## Status

**Done**

## Story

**As a** 用户,
**I want** 在端点详情页实时查看当前连接数和消息统计,
**so that** 我可以监控端点的使用情况。

## Acceptance Criteria

1. 在端点详情页（`/endpoints/:id`）中添加统计数据展示区域
2. 页面加载时调用 `GET /api/endpoints/:id/stats` 获取统计数据
3. 使用 Ant Design Statistic 组件展示：
   - 当前连接数（使用 Badge 组件显示在线状态：绿色=有连接，灰色=无连接）
   - 累计连接数
   - 累计消息数
   - 最后活跃时间（格式化显示，如"2 分钟前"）
4. 实现定时刷新：每 5 秒自动调用一次 API 更新统计数据（使用 `setInterval`）
5. 组件卸载时清除定时器（使用 `useEffect` cleanup）
6. 如果 API 请求失败，显示 `message.error()` 但不中断定时刷新
7. 统计数据使用卡片布局，视觉上与端点信息区分开

## Tasks / Subtasks

- [x] **Task 1: 在 shared 包中定义统计数据响应类型（如果尚未存在）** (AC: 2)
  - [x] 检查 `packages/shared/src/types/endpoint.types.ts` 是否已有 `EndpointStatsResponse` 类型
  - [x] 如果不存在，添加 `EndpointStatsResponse` 接口定义
  - [x] 确保类型在 `packages/shared/src/types/index.ts` 中导出

- [x] **Task 2: 创建前端 API 服务函数** (AC: 2)
  - [x] 在 `packages/frontend/src/services/endpoint.service.ts` 中新增 `getEndpointStats(id: string)` 函数
  - [x] 函数调用 `GET /api/endpoints/:id/stats` API，使用 Axios 实例
  - [x] 返回类型使用 `EndpointStatsResponse`（从 `@websocket-relay/shared` 导入）
  - [x] 添加错误处理：捕获并重新抛出错误供调用方处理

- [x] **Task 3: 创建统计数据展示组件** (AC: 3, 7)
  - [x] 在 `packages/frontend/src/components/endpoints/` 创建 `EndpointStatsCard.tsx` 组件
  - [x] 接收 props：`stats: EndpointStatsResponse | null`, `loading: boolean`
  - [x] 使用 Ant Design `Card` 组件作为容器
  - [x] 使用 `Statistic` 组件展示：
    - 当前连接数（带 `Badge` 指示器：`status="success"`（绿色）当 `current_connections > 0`，否则 `status="default"`（灰色））
    - 累计连接数
    - 累计消息数
  - [x] 使用 Grid 布局（`Row` + `Col`）排列统计卡片

- [x] **Task 4: 实现时间格式化显示** (AC: 3)
  - [x] 创建工具函数 `packages/frontend/src/utils/formatTime.ts`
  - [x] 实现 `formatRelativeTime(date: Date | null): string` 函数
  - [x] 使用 `date-fns` 库的 `formatDistanceToNow()` 函数
  - [x] 处理 `null` 值：返回"从未活跃"或"--"
  - [x] 在 `EndpointStatsCard` 中使用该函数格式化 `last_active_at`

- [x] **Task 5: 在端点详情页集成统计组件** (AC: 1, 2, 4, 5, 6)
  - [x] 在 `packages/frontend/src/pages/EndpointDetailPage.tsx` 中导入 `EndpointStatsCard` 组件
  - [x] 添加状态：`stats: EndpointStatsResponse | null`, `statsLoading: boolean`
  - [x] 创建 `fetchStats()` 异步函数：
    - 调用 `endpointService.getEndpointStats(id)`
    - 成功时更新 `stats` 状态
    - 失败时调用 `message.error('获取统计数据失败')` 但不中断刷新
  - [x] 在 `useEffect` 中：
    - 页面加载时立即调用 `fetchStats()`
    - 使用 `setInterval(() => fetchStats(), 5000)` 设置 5 秒定时刷新
    - 返回 cleanup 函数：`clearInterval(intervalId)` 清除定时器
  - [x] 在 JSX 中渲染 `<EndpointStatsCard stats={stats} loading={statsLoading} />`

- [x] **Task 6: 样式优化和视觉区分** (AC: 7)
  - [x] 在端点详情页中，确保统计数据卡片与端点基本信息卡片有明显的视觉区分
  - [x] 使用不同的卡片标题：如"实时统计"
  - [x] 可选：使用不同的卡片背景色或边框样式
  - [x] 确保响应式布局：移动端下统计项垂直排列

- [x] **Task 7: 编写前端单元测试（可选）** (AC: 所有)
  - [x] MVP 阶段跳过单元测试，已通过手动测试验证

- [x] **Task 8: 手动测试验证** (AC: 1-7)
  - [x] 启动前后端服务：`pnpm --filter @websocket-relay/frontend dev` 和 `pnpm --filter @websocket-relay/backend dev`
  - [x] 在浏览器中打开端点详情页
  - [x] 验证页面加载时显示统计数据
  - [x] 连接 WebSocket 客户端，验证当前连接数实时更新
  - [x] 发送消息，验证累计消息数增加
  - [x] 验证每 5 秒自动刷新（观察网络请求）
  - [x] 用户确认功能正常

- [x] **Task 9: 代码规范检查**
  - [x] 运行 `pnpm --filter @websocket-relay/frontend lint` 检查代码风格
  - [x] 新增代码遵循现有代码风格（注：项目已有 48 个 lint 错误，非本次引入）

## Dev Notes

### Previous Story Insights

**从 Story 3.6 中学到的关键经验：**

1. **后端 API 已完成**：
   - `GET /api/endpoints/:id/stats` API 已在 Story 3.6 中实现
   - API 需要 JWT 认证（`Authorization: Bearer <TOKEN>`）
   - API 返回格式：
     ```json
     {
       "data": {
         "current_connections": number,
         "total_connections": number,
         "total_messages": number,
         "last_active_at": string | null
       }
     }
     ```
   - 如果统计记录不存在，返回默认值（所有字段为 0 或 null）

2. **`EndpointStatsResponse` 类型定义**：
   - 已在 Story 3.6 中在 `packages/shared/src/types/endpoint.types.ts` 中定义
   - 类型包含字段：`current_connections`, `total_connections`, `total_messages`, `last_active_at`
   - 前端可以直接导入使用

3. **权限验证**：
   - API 会验证端点属于当前登录用户
   - 如果无权访问，返回 403 错误
   - 前端需要处理 403/404 错误（显示友好提示）

4. **统计数据实时性**：
   - 统计数据在 WebSocket 连接建立、断开、消息发送时自动更新
   - 前端通过轮询（每 5 秒）获取最新数据
   - 未来可以优化为 WebSocket 推送（FUTURE）

[Previous Story: docs/stories/3.6.story.md]

---

### Data Models

**EndpointStatsResponse 类型：**

根据 Story 3.6 和 data-models.md，前端使用的统计数据响应类型定义如下：

```typescript
interface EndpointStatsResponse {
  current_connections: number;    // 当前在线连接数
  total_connections: number;      // 累计连接总数
  total_messages: number;         // 累计消息总数
  last_active_at: Date | null;    // 最后活跃时间（ISO 8601 字符串或 null）
}
```

**注意事项：**
- `last_active_at` 是 ISO 8601 格式的字符串（如 `"2025-10-28T08:45:30.000Z"`），需要转换为 `Date` 对象
- 如果统计记录不存在，所有数值字段为 0，`last_active_at` 为 null

[Source: docs/stories/3.6.story.md, docs/architecture/data-models.md#EndpointStats]

---

### API Specifications

**调用的 API：**

```
GET /api/endpoints/:id/stats
```

**路径参数：**
- `id` (string): 端点数据库 UUID（不是 endpoint_id）

**请求头：**
```
Authorization: Bearer <JWT_TOKEN>
```

**成功响应（200 OK）：**

```json
{
  "data": {
    "current_connections": 2,
    "total_connections": 15,
    "total_messages": 48,
    "last_active_at": "2025-10-28T08:45:30.000Z"
  }
}
```

**默认值响应（200 OK，统计记录不存在时）：**

```json
{
  "data": {
    "current_connections": 0,
    "total_connections": 0,
    "total_messages": 0,
    "last_active_at": null
  }
}
```

**错误响应：**

- **401 Unauthorized**：JWT Token 无效或缺失
- **404 Not Found**：端点不存在
- **403 Forbidden**：端点不属于当前用户

**前端错误处理：**
- 使用 Ant Design 的 `message.error()` 显示错误提示
- 错误不应中断定时刷新（捕获错误后继续下次轮询）

[Source: docs/stories/3.6.story.md#API Specifications]

---

### Component Architecture

**前端组件组织：**

根据 frontend-architecture.md，前端组件应遵循以下结构：

```
packages/frontend/src/
├── components/
│   └── endpoints/
│       ├── EndpointStatsCard.tsx       # 新建：统计数据展示组件
│       └── ...（其他端点相关组件）
├── pages/
│   └── EndpointDetailPage.tsx          # 修改：集成统计组件
├── services/
│   └── endpoint.service.ts             # 修改：添加 getEndpointStats 函数
├── utils/
│   └── formatTime.ts                   # 新建：时间格式化工具
└── types/                              # 从 @websocket-relay/shared 导入类型
```

**组件设计原则：**
1. **关注点分离**：`EndpointStatsCard` 仅负责展示，不包含业务逻辑
2. **状态提升**：统计数据的获取和刷新逻辑放在 `EndpointDetailPage` 中
3. **Props 清晰**：组件接收 `stats` 和 `loading` props，便于测试和复用

[Source: docs/architecture/frontend-architecture.md#Component Organization]

---

### UI Component Specifications

**使用 Ant Design 组件：**

根据 tech-stack.md 和 PRD 要求，必须使用 Ant Design 5.x 组件库：

**1. Card（卡片容器）：**
```tsx
import { Card } from 'antd';

<Card title="实时统计" bordered={false}>
  {/* 统计内容 */}
</Card>
```

**2. Statistic（统计数值）：**
```tsx
import { Statistic, Row, Col } from 'antd';

<Row gutter={16}>
  <Col span={6}>
    <Statistic title="当前连接数" value={stats.current_connections} />
  </Col>
  <Col span={6}>
    <Statistic title="累计连接数" value={stats.total_connections} />
  </Col>
  <Col span={6}>
    <Statistic title="累计消息数" value={stats.total_messages} />
  </Col>
  <Col span={6}>
    <Statistic title="最后活跃" value={formatRelativeTime(stats.last_active_at)} />
  </Col>
</Row>
```

**3. Badge（在线状态指示器）：**
```tsx
import { Badge } from 'antd';

<Statistic
  title={
    <>
      当前连接数{' '}
      <Badge status={stats.current_connections > 0 ? 'success' : 'default'} />
    </>
  }
  value={stats.current_connections}
/>
```

**响应式布局：**
- 使用 Ant Design 的 Grid 系统（`Row` + `Col`）
- 设置 `Col` 的 `xs`, `sm`, `md` 属性适配不同屏幕
- 移动端下使用 `span={24}` 垂直排列

[Source: docs/architecture/tech-stack.md#UI Component Library, PRD Epic 3 Story 3.7]

---

### API Service Layer

**前端 API 服务架构：**

根据 frontend-architecture.md 和 coding-standards.md，所有 API 调用必须通过 `services/` 层：

**文件位置：** `packages/frontend/src/services/endpoint.service.ts`

**新增函数签名：**

```typescript
import type { EndpointStatsResponse } from '@websocket-relay/shared';
import api from './api'; // Axios 实例

/**
 * 获取端点统计数据
 *
 * @param id - 端点数据库 UUID
 * @returns 统计数据响应
 * @throws API 请求错误
 */
export async function getEndpointStats(id: string): Promise<EndpointStatsResponse> {
  const response = await api.get(`/api/endpoints/${id}/stats`);
  return response.data.data; // 返回 data.data（API 响应格式）
}
```

**关键实现要点：**

1. **类型导入**：从 `@websocket-relay/shared` 导入 `EndpointStatsResponse` 类型
2. **Axios 实例**：使用统一的 `api` 实例（已配置 JWT Token 拦截器）
3. **响应提取**：API 返回 `{ data: {...} }` 格式，需要提取 `response.data.data`
4. **错误传播**：不在 service 层处理错误，由调用方决定如何处理

**禁止直接使用 Axios：**
```typescript
// ❌ 错误：禁止在组件中直接使用 axios
import axios from 'axios';
axios.get('/api/endpoints/...'); // 违反 coding-standards.md

// ✅ 正确：通过 service 层调用
import { getEndpointStats } from '@/services/endpoint.service';
getEndpointStats(id);
```

[Source: docs/architecture/frontend-architecture.md#API Client, docs/architecture/coding-standards.md#Critical Fullstack Rules]

---

### State Management and Effect Hooks

**React Hooks 使用规范：**

**1. 状态管理（useState）：**

```typescript
import { useState, useEffect } from 'react';
import type { EndpointStatsResponse } from '@websocket-relay/shared';

const [stats, setStats] = useState<EndpointStatsResponse | null>(null);
const [statsLoading, setStatsLoading] = useState<boolean>(true);
```

**2. 副作用管理（useEffect）：**

```typescript
useEffect(() => {
  // 定义异步函数
  const fetchStats = async () => {
    try {
      setStatsLoading(true);
      const data = await getEndpointStats(id);
      setStats(data);
    } catch (error) {
      message.error('获取统计数据失败');
      // 不中断刷新，继续下次轮询
    } finally {
      setStatsLoading(false);
    }
  };

  // 立即调用一次
  fetchStats();

  // 设置定时器
  const intervalId = setInterval(fetchStats, 5000);

  // Cleanup 函数：组件卸载时清除定时器
  return () => {
    clearInterval(intervalId);
  };
}, [id]); // 依赖项：当 id 变化时重新设置定时器
```

**关键要点：**

1. **初始加载**：`useEffect` 内立即调用 `fetchStats()` 一次
2. **定时刷新**：使用 `setInterval` 每 5 秒调用一次
3. **Cleanup**：返回函数清除定时器，避免内存泄漏
4. **依赖项**：`[id]` 确保端点 ID 变化时重新设置定时器
5. **错误处理**：捕获错误但不中断刷新（仅显示提示）

[Source: docs/architecture/frontend-architecture.md#State Management]

---

### Time Formatting

**日期处理库：**

根据 tech-stack.md，项目使用 `date-fns` 库进行日期处理：

**工具函数实现：**

```typescript
// packages/frontend/src/utils/formatTime.ts
import { formatDistanceToNow } from 'date-fns';
import { zhCN } from 'date-fns/locale';

/**
 * 格式化相对时间
 *
 * @param date - 时间字符串或 null
 * @returns 格式化后的相对时间（如"2 分钟前"）
 */
export function formatRelativeTime(date: string | null): string {
  if (!date) {
    return '从未活跃';
  }

  try {
    const parsedDate = new Date(date);
    return formatDistanceToNow(parsedDate, {
      addSuffix: true,      // 添加"前"后缀
      locale: zhCN,         // 使用中文本地化
    });
  } catch {
    return '时间格式错误';
  }
}
```

**使用示例：**

```tsx
import { formatRelativeTime } from '@/utils/formatTime';

<Statistic
  title="最后活跃"
  value={formatRelativeTime(stats?.last_active_at)}
/>
```

**输出示例：**
- `"2 分钟前"`
- `"1 小时前"`
- `"3 天前"`
- `"从未活跃"`（当 `last_active_at` 为 null 时）

[Source: docs/architecture/tech-stack.md#Date/Time Library]

---

### Project Structure Alignment

**本故事需要创建/修改的文件：**

根据 unified-project-structure.md：

```
packages/
├── shared/
│   └── src/
│       └── types/
│           └── endpoint.types.ts           # 检查:确认 EndpointStatsResponse 类型存在
├── frontend/
│   ├── src/
│   │   ├── components/
│   │   │   └── endpoints/
│   │   │       └── EndpointStatsCard.tsx   # 新建:统计数据展示组件
│   │   ├── pages/
│   │   │   └── EndpointDetailPage.tsx      # 修改:集成统计组件和刷新逻辑
│   │   ├── services/
│   │   │   └── endpoint.service.ts         # 修改:添加 getEndpointStats 函数
│   │   ├── utils/
│   │   │   └── formatTime.ts               # 新建:时间格式化工具
│   │   └── __tests__/
│   │       └── components/
│   │           └── EndpointStatsCard.test.tsx  # 新建:组件测试（可选）
```

**命名规范：**
- 组件使用 PascalCase：`EndpointStatsCard.tsx`
- 工具函数使用 camelCase：`formatRelativeTime()`
- 文件使用 camelCase：`formatTime.ts`

[Source: docs/architecture/unified-project-structure.md, docs/architecture/coding-standards.md#Naming Conventions]

---

### Error Handling

**前端错误处理策略：**

根据 coding-standards.md 和 frontend-architecture.md：

**1. API 错误处理：**

```typescript
try {
  const data = await getEndpointStats(id);
  setStats(data);
} catch (error) {
  // 使用 Ant Design message 组件显示错误
  message.error('获取统计数据失败，请稍后重试');

  // 不中断定时刷新（不抛出错误）
  // 下次轮询会继续尝试
}
```

**2. 错误场景处理：**

| 错误类型 | HTTP 状态 | 前端处理 |
|---------|----------|---------|
| 认证失败 | 401 | 由 Axios 拦截器统一处理（跳转登录） |
| 端点不存在 | 404 | 显示"端点不存在"，停止刷新 |
| 无权访问 | 403 | 显示"无权访问"，停止刷新 |
| 网络错误 | - | 显示"网络错误"，继续刷新 |

**3. 容错设计：**

- 统计数据加载失败不影响页面其他部分显示
- 使用 `statsLoading` 状态显示加载指示器
- `stats` 为 `null` 时显示占位内容或"暂无数据"

[Source: docs/architecture/coding-standards.md#Error Handling, docs/architecture/frontend-architecture.md]

---

### Testing

**前端测试策略：**

根据 testing-strategy.md，前端单元测试是可选的（优先级较低），但如果编写测试，应遵循以下规范：

**测试文件位置：**
```
packages/frontend/src/__tests__/
└── components/
    └── EndpointStatsCard.test.tsx
```

**测试框架：**
- **Vitest**（Vite 原生支持）
- **React Testing Library**（组件测试）

**测试场景示例：**

```typescript
import { render, screen } from '@testing-library/react';
import { describe, it, expect } from 'vitest';
import EndpointStatsCard from '@/components/endpoints/EndpointStatsCard';

describe('EndpointStatsCard', () => {
  it('应该正确渲染统计数据', () => {
    const mockStats = {
      current_connections: 2,
      total_connections: 15,
      total_messages: 48,
      last_active_at: new Date().toISOString(),
    };

    render(<EndpointStatsCard stats={mockStats} loading={false} />);

    expect(screen.getByText('2')).toBeInTheDocument(); // 当前连接数
    expect(screen.getByText('15')).toBeInTheDocument(); // 累计连接数
  });

  it('应该在有连接时显示绿色 Badge', () => {
    const mockStats = { current_connections: 2, /* ... */ };
    render(<EndpointStatsCard stats={mockStats} loading={false} />);

    const badge = screen.getByRole('img', { name: /badge/i });
    expect(badge).toHaveClass('ant-badge-status-success');
  });
});
```

**手动测试（必须）：**

由于 MVP 阶段前端测试是可选的，必须进行充分的手动测试：
1. 页面加载时统计数据正确显示
2. 定时刷新正常工作（每 5 秒）
3. 连接 WebSocket 后统计数据实时更新
4. 组件卸载后定时器被清除
5. API 失败时显示错误提示但刷新继续

**测试执行命令：**

```bash
# 启动前端开发服务器
pnpm --filter @websocket-relay/frontend dev

# 运行前端单元测试（如果实现）
pnpm --filter @websocket-relay/frontend test
```

[Source: docs/architecture/testing-strategy.md#Test Organization, docs/architecture/tech-stack.md#Frontend Testing]

---

### Type Sharing (Critical!)

**共享类型使用规范：**

根据 coding-standards.md 的 **Critical Fullstack Rules**：

> **Type Sharing:** 所有共享类型定义在 `packages/shared/src/types`，前后端统一导入

**本故事使用的共享类型：**

```typescript
// 前端导入方式
import type { EndpointStatsResponse } from '@websocket-relay/shared';

// 后端导入方式（已在 Story 3.6 中使用）
import type { EndpointStatsResponse } from '@websocket-relay/shared';
```

**类型定义位置：**

- **文件**：`packages/shared/src/types/endpoint.types.ts`
- **导出**：在 `packages/shared/src/types/index.ts` 中统一导出

**验证类型存在：**

在 Task 1 中，需要先检查 `EndpointStatsResponse` 类型是否已在 Story 3.6 中定义。如果不存在（不太可能），需要添加类型定义。

[Source: docs/architecture/coding-standards.md#Critical Fullstack Rules - Type Sharing, docs/stories/3.6.story.md]

---

### Performance Considerations

**前端性能优化要点：**

1. **避免不必要的重新渲染**：
   - `EndpointStatsCard` 使用 `React.memo()` 包裹（可选）
   - Props 使用基本类型（`stats` 和 `loading`）

2. **定时器清理**：
   - 必须在 `useEffect` cleanup 中清除 `setInterval`
   - 避免组件卸载后继续发送请求（内存泄漏）

3. **API 请求优化**：
   - 使用轮询而非实时推送（简化架构，满足 MVP 需求）
   - 5 秒刷新间隔平衡实时性和服务器负载
   - 未来可优化为 WebSocket 推送（FUTURE）

4. **错误处理不阻塞刷新**：
   - 单次 API 失败不影响后续轮询
   - 避免连续失败时的错误消息轰炸（仅显示一次）

[Source: 架构设计最佳实践]

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-28 | 1.0 | 初始创建故事 3.7 | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used

Claude Sonnet 4.5 (claude-sonnet-4-5-20250929)

### Debug Log References

无需调试日志

### Completion Notes List

- ✅ 确认 `EndpointStatsResponse` 类型已在 Story 3.6 中定义于 `packages/shared/src/types/endpoint.types.ts`
- ✅ 在 `packages/frontend/src/services/endpoint.service.ts` 中新增 `getEndpointStats` 函数
- ✅ 创建 `packages/frontend/src/utils/formatTime.ts` 工具函数，实现相对时间格式化
- ✅ 创建 `packages/frontend/src/components/endpoints/EndpointStatsCard.tsx` 组件
  - 使用 Ant Design Card、Statistic、Row、Col、Badge、Skeleton 组件
  - 实现响应式布局（xs/sm/md 断点）
  - Badge 状态指示器：绿色（有连接）/ 灰色（无连接）
- ✅ 在 `EndpointDetailPage.tsx` 中集成统计组件
  - 添加状态管理：`stats`, `statsLoading`
  - 实现 `fetchStats` 异步函数
  - 使用 `useEffect` 设置定时刷新（5 秒间隔）
  - 实现 cleanup 函数清除定时器
- ✅ 样式优化：使用"实时统计"标题，与"端点详情"卡片视觉区分
- ✅ Lint 检查：新增代码遵循现有风格（项目已有 48 个 lint 错误，非本次引入）
- ✅ 手动测试通过：
  - API 正常返回统计数据
  - WebSocket 连接和消息发送后统计数据正确更新
  - 定时刷新功能正常（每 5 秒）
  - 用户在浏览器中确认功能正常

### File List

**新增文件：**
- `packages/frontend/src/utils/formatTime.ts` - 时间格式化工具函数
- `packages/frontend/src/components/endpoints/EndpointStatsCard.tsx` - 统计数据展示组件

**修改文件：**
- `packages/frontend/src/services/endpoint.service.ts` - 新增 `getEndpointStats` 函数
- `packages/frontend/src/pages/EndpointDetailPage.tsx` - 集成统计组件和定时刷新逻辑

## QA Results

待 QA 代理填写
