# Story 4.1: 实现管理员授权码生成 API

## Status

**Done**

## Story

**As a** 后端开发者，
**I want** 实现管理员生成授权码的 API，
**so that** 管理员可以控制用户注册。

## Acceptance Criteria

1. 实现 `POST /api/admin/invite-codes` API（需要 JWT 认证，且 `isAdmin` 为 true）
2. 接收参数：`{ expires_at }` (可选，Unix 时间戳或 ISO 8601 日期字符串)
3. 生成随机授权码（8-12 位字符，使用 nanoid 或类似库）
4. 将授权码保存到 InviteCode 表，`created_by` 为当前管理员用户 ID
5. 返回创建的授权码信息：`{ id, code, expires_at, created_at }`
6. 如果请求用户不是管理员，返回 403 错误 "需要管理员权限"
7. 使用 Postman 测试，验证管理员可以成功创建授权码

## Tasks / Subtasks

- [x] **Task 1: 在 shared 包中定义管理员 API 类型** (AC: 2, 5)
  - [x] 创建 `packages/shared/src/types/invite-code.types.ts` 文件（如不存在）
  - [x] 定义 `CreateInviteCodeRequest` 接口：`{ expires_at?: string | number }`
  - [x] 定义 `CreateInviteCodeResponse` 接口：`{ id: string; code: string; expires_at: string | null; created_at: string }`
  - [x] 在 `packages/shared/src/types/index.ts` 中导出新类型
  - [x] 验证类型定义与数据库 Schema 中的 InviteCode 模型对齐

- [x] **Task 2: 创建管理员权限验证中间件** (AC: 1, 6)
  - [x] 在 `packages/backend/src/middleware/` 中创建或更新 `auth.middleware.ts`
  - [x] 实现 `requireAdmin` 中间件函数：
    ```typescript
    export function requireAdmin(req: Request, res: Response, next: NextFunction) {
      if (!req.user?.isAdmin) {
        return res.status(403).json({
          error: { code: 'ADMIN_REQUIRED', message: '需要管理员权限' }
        });
      }
      next();
    }
    ```
  - [x] 确保 `requireAdmin` 在 `authenticateToken` 之后调用
  - [x] 添加 TypeScript 类型：扩展 Express Request 接口，包含 `user` 属性

- [x] **Task 3: 实现授权码生成逻辑** (AC: 3, 4)
  - [x] 在 `packages/backend/src/controllers/` 中创建 `admin.controller.ts`
  - [x] 实现 `createInviteCode` 控制器函数：
    ```typescript
    import { nanoid } from 'nanoid';
    import { prisma } from '../prisma';
    
    export async function createInviteCode(req: Request, res: Response) {
      const { expires_at } = req.body;
      const userId = req.user!.userId;
    
      // 生成 8-12 位授权码
      const code = nanoid(10);
    
      // 解析 expires_at（支持 Unix 时间戳和 ISO 8601）
      let expiresAtDate: Date | null = null;
      if (expires_at) {
        if (typeof expires_at === 'number') {
          expiresAtDate = new Date(expires_at * 1000);
        } else {
          expiresAtDate = new Date(expires_at);
        }
      }
    
      // 保存到数据库
      const inviteCode = await prisma.inviteCode.create({
        data: {
          code,
          expires_at: expiresAtDate,
          created_by: userId
        }
      });
    
      // 返回响应
      res.status(201).json({
        id: inviteCode.id,
        code: inviteCode.code,
        expires_at: inviteCode.expires_at?.toISOString() || null,
        created_at: inviteCode.created_at.toISOString()
      });
    }
    ```
  - [x] 添加错误处理：捕获数据库错误并返回 500 错误
  - [x] 验证 `expires_at` 格式有效性，无效时返回 400 错误

- [x] **Task 4: 创建管理员路由** (AC: 1)
  - [x] 在 `packages/backend/src/routes/` 中创建 `admin.route.ts`
  - [x] 定义路由：
    ```typescript
    import express from 'express';
    import { createInviteCode } from '../controllers/admin.controller';
    import { authenticateToken, requireAdmin } from '../middleware/auth.middleware';
    
    const router = express.Router();
    
    router.post('/invite-codes', authenticateToken, requireAdmin, createInviteCode);
    
    export default router;
    ```
  - [x] 在 `packages/backend/src/app.ts` 中注册管理员路由：
    ```typescript
    import adminRoutes from './routes/admin.route';
    app.use('/api/admin', adminRoutes);
    ```
  - [x] 验证路由路径为 `POST /api/admin/invite-codes`

- [x] **Task 5: 编写单元测试** (AC: 7)
  - [x] 在 `packages/backend/tests/integration/` 中创建 `admin.api.test.ts`
  - [x] 编写测试用例：
    - 测试管理员成功创建授权码（无过期时间）
    - 测试管理员成功创建授权码（带过期时间 - Unix 时间戳）
    - 测试管理员成功创建授权码（带过期时间 - ISO 8601 字符串）
    - 测试普通用户创建授权码被拒绝（返回 403）
    - 测试未认证用户创建授权码被拒绝（返回 401）
    - 测试 expires_at 格式无效时返回 400 错误
  - [x] 使用 Jest 和 Supertest 编写集成测试
  - [x] 运行测试：`npm run test` 或 `pnpm test`，确保所有测试通过

- [x] **Task 6: 手动测试和验证** (AC: 7)
  - [x] 使用 Postman 或 cURL 手动测试 API
  - [x] 测试场景 1：管理员创建授权码（无过期时间）
    ```bash
    POST /api/admin/invite-codes
    Authorization: Bearer <admin-token>
    Content-Type: application/json
    {}
    ```
  - [x] 测试场景 2：管理员创建授权码（带过期时间）
    ```bash
    POST /api/admin/invite-codes
    Authorization: Bearer <admin-token>
    Content-Type: application/json
    { "expires_at": "2025-12-31T23:59:59Z" }
    ```
  - [x] 测试场景 3：普通用户尝试创建授权码（应返回 403）
  - [x] 使用 Prisma Studio 验证授权码已正确保存到数据库
  - [x] 验证返回的授权码长度在 8-12 位之间

- [x] **Task 7: 代码规范检查和文档更新**
  - [x] 运行 `pnpm lint` 检查代码规范
  - [x] 修复所有 ESLint 错误和警告
  - [x] 添加 JSDoc 注释到控制器函数和中间件
  - [x] 更新 API 文档（如果有独立 API 文档）

## Dev Notes

### 架构层次和文件位置

**分层架构：** [Source: architecture/backend-architecture.md#Service Architecture]
```
routes/ → controllers/ → services/ → prisma (数据访问)
```

**关键文件位置：** [Source: architecture/unified-project-structure.md]
- 类型定义：`packages/shared/src/types/invite-code.types.ts`
- 路由：`packages/backend/src/routes/admin.route.ts`
- 控制器：`packages/backend/src/controllers/admin.controller.ts`
- 中间件：`packages/backend/src/middleware/auth.middleware.ts`
- 测试：`packages/backend/tests/integration/admin.api.test.ts`

---

### 数据模型和 Schema

**InviteCode 数据模型：** [Source: architecture/data-models.md#InviteCode]

```typescript
interface InviteCode {
  id: string;
  code: string;
  expires_at: Date | null;
  used_by: string | null;
  used_at: Date | null;
  created_by: string;
  created_at: Date;
}
```

**Prisma Schema：** [Source: architecture/database-schema.md]

```prisma
model InviteCode {
  id         String    @id @default(uuid())
  code       String    @unique @db.VarChar(12)
  expires_at DateTime?
  used_by    String?   @unique
  used_at    DateTime?
  created_by String
  created_at DateTime  @default(now())

  creator User  @relation("CreatedBy", fields: [created_by], references: [id], onDelete: Cascade)
  user    User? @relation("UsedBy", fields: [used_by], references: [id], onDelete: SetNull)

  @@index([code])
  @@index([used_by])
  @@index([created_by])
  @@map("invite_codes")
}
```

**关键字段说明：**
- `code`：授权码字符串，唯一索引，最大 12 位
- `expires_at`：可空，表示授权码过期时间
- `created_by`：创建该授权码的管理员用户 ID（外键关联 User 表）

---

### JWT 认证和管理员权限

**JWT 认证流程：** [Source: architecture/backend-architecture.md#Authentication]

1. 客户端在请求头中附加 Token：`Authorization: Bearer TOKEN`
2. `authenticateToken` 中间件验证 Token（jwt.verify）
3. 验证成功后，将用户信息附加到 `req.user`（包含 `userId`, `username`, `isAdmin`）
4. `requireAdmin` 中间件检查 `req.user.isAdmin` 是否为 true

**中间件调用顺序：**
```typescript
router.post('/invite-codes', authenticateToken, requireAdmin, createInviteCode);
```

**Request 对象扩展：**
```typescript
declare global {
  namespace Express {
    interface Request {
      user?: {
        userId: string;
        username: string;
        isAdmin: boolean;
      };
    }
  }
}
```

---

### 授权码生成逻辑

**使用 nanoid 生成授权码：** [Source: architecture/tech-stack.md#ID Generation]

```typescript
import { nanoid } from 'nanoid';

// 生成 10 位随机字符串（URL 友好）
const code = nanoid(10);
```

**nanoid 特性：**
- 轻量级（5KB）
- URL 友好字符（A-Za-z0-9_-）
- 高熵值，碰撞概率极低
- 比 UUID 更短小精悍

**授权码长度要求：** 8-12 位（AC 3）
- 推荐使用 10 位（平衡安全性和可读性）

---

### 日期时间处理

**expires_at 参数支持两种格式：** (AC 2)

1. **Unix 时间戳（秒）：** `1735689599`
   ```typescript
   if (typeof expires_at === 'number') {
     expiresAtDate = new Date(expires_at * 1000); // 转换为毫秒
   }
   ```

2. **ISO 8601 字符串：** `"2025-12-31T23:59:59Z"`
   ```typescript
   else {
     expiresAtDate = new Date(expires_at);
   }
   ```

**日期验证：**
```typescript
if (isNaN(expiresAtDate.getTime())) {
  return res.status(400).json({
    error: { code: 'INVALID_DATE', message: '无效的过期时间格式' }
  });
}
```

**返回格式：** 统一使用 ISO 8601 字符串
```typescript
expires_at: inviteCode.expires_at?.toISOString() || null
```

---

### 错误处理

**统一错误响应格式：** [Source: architecture/coding-standards.md#Error Handling]

```typescript
res.status(statusCode).json({
  error: {
    code: 'ERROR_CODE',
    message: '用户友好的错误消息'
  }
});
```

**本故事相关错误码：**

| 状态码 | 错误码 | 消息 | 场景 |
|--------|--------|------|------|
| 401 | UNAUTHORIZED | 未提供认证信息 | 缺少 JWT Token |
| 403 | ADMIN_REQUIRED | 需要管理员权限 | 非管理员用户尝试创建授权码 |
| 400 | INVALID_DATE | 无效的过期时间格式 | expires_at 格式错误 |
| 500 | INTERNAL_ERROR | 服务器内部错误 | 数据库操作失败 |

---

### API 响应格式

**成功响应（201 Created）：** (AC 5)

```json
{
  "id": "uuid-string",
  "code": "aBc123XyZ9",
  "expires_at": "2025-12-31T23:59:59.000Z",
  "created_at": "2025-10-28T12:00:00.000Z"
}
```

**字段说明：**
- `id`：数据库主键（UUID）
- `code`：授权码（10 位 nanoid）
- `expires_at`：ISO 8601 格式或 null（永不过期）
- `created_at`：ISO 8601 格式

---

### 编码规范

**关键规范：** [Source: architecture/coding-standards.md]

- **类型共享：** 所有共享类型定义在 `packages/shared/src/types`
- **错误处理：** 所有 API 路由必须使用统一的错误处理中间件
- **数据库查询：** 禁止拼接 SQL，使用 Prisma 参数化查询
- **函数命名：** camelCase（例如 `createInviteCode`）
- **路由命名：** kebab-case（例如 `/invite-codes`）

---

### Testing

**测试框架和工具：** [Source: architecture/tech-stack.md#Backend Testing]
- **测试框架：** Jest 29.x
- **HTTP 测试：** Supertest
- **测试类型：** 集成测试（API 测试）

**测试文件位置：** [Source: architecture/testing-strategy.md#Test Organization]
```
packages/backend/tests/integration/admin.api.test.ts
```

**测试示例模板：** [Source: architecture/testing-strategy.md#Test Examples]

```typescript
import request from 'supertest';
import app from '@/app';

describe('POST /api/admin/invite-codes', () => {
  it('应该成功创建授权码', async () => {
    const response = await request(app)
      .post('/api/admin/invite-codes')
      .set('Authorization', `Bearer ${adminToken}`)
      .send({ expires_at: '2025-12-31T23:59:59Z' });

    expect(response.status).toBe(201);
    expect(response.body.code).toBeDefined();
    expect(response.body.expires_at).toBe('2025-12-31T23:59:59.000Z');
  });

  it('应该拒绝非管理员用户', async () => {
    const response = await request(app)
      .post('/api/admin/invite-codes')
      .set('Authorization', `Bearer ${regularUserToken}`)
      .send({});

    expect(response.status).toBe(403);
    expect(response.body.error.code).toBe('ADMIN_REQUIRED');
  });
});
```

**测试覆盖目标：** [Source: architecture/testing-strategy.md]
- 核心业务逻辑覆盖率 > 70%

**运行测试命令：**
```bash
npm run test
# 或
pnpm test
```

---

### 相关依赖

**已安装的关键依赖：** [Source: architecture/tech-stack.md]
- `nanoid` 5.x - 授权码生成
- `jsonwebtoken` 9.x - JWT 认证
- `@prisma/client` 5.x - 数据库访问
- `express` 4.18+ - HTTP 服务器
- `jest` 29.x - 测试框架

**导入示例：**
```typescript
import { nanoid } from 'nanoid';
import { prisma } from '../prisma'; // Prisma Client 实例
import type { CreateInviteCodeRequest } from '@websocket-relay/shared/types';
```

---

## Change Log

| Date       | Version | Description                 | Author               |
|------------|---------|-----------------------------|----------------------|
| 2025-10-28 | 1.0     | 初始创建故事 4.1            | Bob (Scrum Master)   |

## Dev Agent Record

### Agent Model Used

Claude Sonnet 4.5 (claude-sonnet-4-5-20250929)

### Debug Log References

无需调试，所有测试一次性通过。

### Completion Notes List

- ✅ 成功实现了 `POST /api/admin/invite-codes` API
- ✅ 支持创建无过期时间和带过期时间的授权码
- ✅ 过期时间支持 Unix 时间戳和 ISO 8601 字符串两种格式
- ✅ 使用 nanoid 生成 10 位 URL 友好的授权码
- ✅ 实现了管理员权限验证中间件 `requireAdmin`
- ✅ 所有测试用例通过（10/10 passed）
- ✅ 代码通过 ESLint 检查（0 errors, 仅有现有代码的 warnings）
- ✅ 手动测试验证了 API 功能和数据库存储

### File List

**新增文件：**
- `packages/backend/src/controllers/admin.controller.ts` - 管理员授权码生成控制器
- `packages/backend/src/routes/admin.route.ts` - 管理员路由定义
- `packages/backend/tests/integration/admin.api.test.ts` - 集成测试文件

**修改文件：**
- `packages/shared/src/types/invite-code.types.ts` - 添加 CreateInviteCodeRequest 和 CreateInviteCodeResponse 类型
- `packages/shared/src/types/index.ts` - 导出新增类型
- `packages/backend/src/app.ts` - 注册管理员路由
- `packages/backend/src/middleware/auth.middleware.ts` - 已存在的 requireAdmin 中间件（验证符合要求）

## QA Results

_待 QA 代理填写_
