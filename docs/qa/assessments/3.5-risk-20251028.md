# Risk Profile: Story 3.5 - å®ç°è¿æ¥ç»Ÿè®¡å’Œæ•°æ®åº“æ›´æ–°

**Story**: 3.5
**Title**: å®ç°è¿æ¥ç»Ÿè®¡å’Œæ•°æ®åº“æ›´æ–°
**Assessment Date**: 2025-10-28
**Assessed By**: Quinn (Test Architect)
**Overall Risk Level**: ğŸŸ¡ **LOW-MEDIUM**

---

## Executive Summary

Story 3.5 å®ç°äº†ç«¯ç‚¹è¿æ¥ç»Ÿè®¡åŠŸèƒ½,åŒ…æ‹¬æ•°æ®åº“ Schema è®¾è®¡ã€æœåŠ¡å±‚å®ç°ã€WebSocket é›†æˆå’Œå•å…ƒæµ‹è¯•ã€‚**æ€»ä½“è´¨é‡ä¼˜ç§€**,ä»£ç æ¶æ„æ¸…æ™°,é”™è¯¯å¤„ç†å®Œå–„ã€‚

**å…³é”®å‘ç°**:
- âœ… æ ¸å¿ƒåŠŸèƒ½å®Œå…¨å®ç°,ä»£ç è´¨é‡é«˜
- âœ… ä½¿ç”¨ Prisma atomic æ“ä½œä¿è¯å¹¶å‘å®‰å…¨
- âš ï¸ å­˜åœ¨ `current_connections` å¯èƒ½å˜æˆè´Ÿæ•°çš„è¾¹ç¼˜æƒ…å†µ (MEDIUM é£é™©)
- âš ï¸ ç¼ºå°‘ WebSocket é›†æˆæµ‹è¯• (LOW é£é™©)

**å»ºè®®**: ä¿®å¤è´Ÿæ•°é˜²æŠ¤é€»è¾‘åå¯éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒã€‚

---

## Risk Assessment Matrix

### Risk Scoring Criteria

| Score | Probability | Impact | Combined Risk Level |
|-------|------------|--------|---------------------|
| 1-3   | Low        | Low    | LOW                 |
| 4-6   | Medium     | Medium | MEDIUM              |
| 7-9   | High       | High   | HIGH                |
| 10+   | Critical   | Critical| CRITICAL           |

**Risk Score Calculation**: `Risk Score = Probability (1-3) Ã— Impact (1-3)`

---

## Identified Risks

### RISK-001: current_connections å¯èƒ½å˜æˆè´Ÿæ•°

**Category**: Data Integrity
**Probability**: MEDIUM (2/3)
**Impact**: LOW (1/3)
**Risk Score**: **4 (MEDIUM)**

**Description**:
åœ¨é«˜å¹¶å‘æˆ–å¼‚å¸¸æƒ…å†µä¸‹(ä¾‹å¦‚å®¢æˆ·ç«¯å¼‚å¸¸æ–­å¼€ä½† disconnect äº‹ä»¶æœªè§¦å‘,æˆ–è¿æ¥ç®¡ç†å™¨çŠ¶æ€ä¸åŒæ­¥),`current_connections` å­—æ®µå¯èƒ½ä¼šè¢« decrement åˆ°è´Ÿæ•°ã€‚

**Affected Components**:
- `packages/backend/src/services/stats.service.ts:24-29`

**Scenario**:
```
Given: endpoint_stats è®°å½•ä¸­ current_connections = 0
When: disconnect äº‹ä»¶è¢«è§¦å‘ (ç”±äºçŠ¶æ€ä¸åŒæ­¥æˆ–é‡å¤æ–­å¼€)
Then: current_connections è¢« decrement åˆ° -1
```

**Impact**:
- ç»Ÿè®¡æ•°æ®ä¸å‡†ç¡®,å‰ç«¯æ˜¾ç¤ºè´Ÿæ•°è¿æ¥
- å¯èƒ½å½±å“åŸºäºè¿æ¥æ•°çš„ä¸šåŠ¡é€»è¾‘åˆ¤æ–­
- ä¸å½±å“ WebSocket æœåŠ¡æ ¸å¿ƒåŠŸèƒ½

**Likelihood Factors**:
- WebSocket å®¢æˆ·ç«¯å¯èƒ½å¼‚å¸¸æ–­å¼€
- ç½‘ç»œæŠ–åŠ¨å¯èƒ½å¯¼è‡´é‡å¤æ–­å¼€äº‹ä»¶
- ConnectionManager å’Œæ•°æ®åº“çŠ¶æ€å¯èƒ½ä¸åŒæ­¥

**Mitigation**:
```typescript
// å»ºè®®å®ç°
if (action === 'disconnect') {
  const currentStats = await prisma.endpointStats.findUnique({
    where: { endpoint_id: endpointId },
    select: { current_connections: true }
  });
  if (!currentStats || currentStats.current_connections <= 0) {
    console.warn(`[stats.service] Skipping disconnect: current_connections already 0 for endpoint ${endpointId}`);
    return;  // å·²ç»æ˜¯ 0,è·³è¿‡ decrement
  }
}
```

**Acceptance Criteria**:
- [ ] å®ç°é˜²æŠ¤é€»è¾‘
- [ ] æ·»åŠ å•å…ƒæµ‹è¯•éªŒè¯è´Ÿæ•°é˜²æŠ¤
- [ ] æ·»åŠ æ—¥å¿—è®°å½•å¼‚å¸¸æƒ…å†µ

**Priority**: **MEDIUM** (å»ºè®®ä¿®å¤åå†éƒ¨ç½²ç”Ÿäº§)

---

### RISK-002: ç¼ºå°‘ WebSocket é›†æˆæµ‹è¯•

**Category**: Test Coverage
**Probability**: LOW (1/3)
**Impact**: LOW (1/3)
**Risk Score**: **1 (LOW)**

**Description**:
åªæœ‰å•å…ƒæµ‹è¯•è¦†ç›–ç»Ÿè®¡æœåŠ¡é€»è¾‘,ç¼ºå°‘ WebSocket é›†æˆæµ‹è¯•éªŒè¯çœŸå®è¿æ¥åœºæ™¯ä¸‹çš„ç»Ÿè®¡æ›´æ–°ã€‚

**Affected Components**:
- `tests/websocket/` (ç¼ºå°‘é›†æˆæµ‹è¯•)

**Gap Analysis**:
- âœ… å•å…ƒæµ‹è¯•è¦†ç›–æ‰€æœ‰ action ç±»å‹
- âœ… Mock éªŒè¯å‡½æ•°è°ƒç”¨æ­£ç¡®
- âŒ ç¼ºå°‘çœŸå® WebSocket è¿æ¥çš„ç«¯åˆ°ç«¯æµ‹è¯•
- âŒ æœªéªŒè¯ ConnectionManager å’Œ MessageRouter çš„å®é™…é›†æˆ

**Impact**:
- å•å…ƒæµ‹è¯•å·²è¦†ç›–æ ¸å¿ƒä¸šåŠ¡é€»è¾‘,é£é™©è¾ƒä½
- å¯èƒ½å­˜åœ¨é›†æˆå±‚é¢çš„æ„å¤–è¡Œä¸º
- æ‰‹åŠ¨æµ‹è¯•å¯ä»¥éƒ¨åˆ†å¼¥è¡¥

**Mitigation**:
1. æ·»åŠ  WebSocket é›†æˆæµ‹è¯• (è§ `testing-strategy.md:82-109`)
2. å®Œæˆ Task 6 æ‰‹åŠ¨æµ‹è¯•éªŒè¯
3. è€ƒè™‘åœ¨åç»­ Sprint ä¸­è¡¥å……é›†æˆæµ‹è¯•å¥—ä»¶

**Priority**: **LOW** (å¯åœ¨åç»­ Sprint ä¸­è§£å†³)

---

### RISK-003: ç»Ÿè®¡æ•°æ®å¯èƒ½ä¸å‡†ç¡® (é”™è¯¯æ—¶)

**Category**: Reliability
**Probability**: LOW (1/3)
**Impact**: LOW (1/3)
**Risk Score**: **1 (LOW)**

**Description**:
å½“æ•°æ®åº“æ“ä½œå¤±è´¥æ—¶,ç»Ÿè®¡æ•°æ®ä¸ä¼šæ›´æ–°,å¯¼è‡´ä¸å®é™…è¿æ¥çŠ¶æ€ä¸ä¸€è‡´ã€‚

**Affected Components**:
- `packages/backend/src/services/stats.service.ts:42-48` (é”™è¯¯å¤„ç†)

**Impact**:
- ç»Ÿè®¡æ•°æ®ä½œä¸ºç›‘æ§æŒ‡æ ‡,ä¸å½±å“ WebSocket æ ¸å¿ƒåŠŸèƒ½
- é”™è¯¯å·²è®°å½•åˆ°æ—¥å¿—,ä¾¿äºè°ƒæŸ¥
- å‰ç«¯å¯ä»¥å®¹å¿çŸ­æš‚çš„ç»Ÿè®¡ä¸å‡†ç¡®

**Mitigation** (å·²å®ç°):
âœ… try-catch æ•è·æ‰€æœ‰æ•°æ®åº“å¼‚å¸¸
âœ… è®°å½•é”™è¯¯æ—¥å¿—ä½†ä¸æŠ›å‡º
âœ… WebSocket æœåŠ¡å¯ç”¨æ€§ä¼˜å…ˆäºç»Ÿè®¡å‡†ç¡®æ€§

**Additional Recommendations**:
- è€ƒè™‘æ·»åŠ ç»Ÿè®¡æ•°æ®å¥åº·æ£€æŸ¥ç«¯ç‚¹
- å®šæœŸåŒæ­¥ç»Ÿè®¡æ•°æ® (ä¾‹å¦‚æ¯å°æ—¶æ ¡å‡†ä¸€æ¬¡)
- ç›‘æ§é”™è¯¯æ—¥å¿—é¢‘ç‡,åŠæ—¶å‘ç°æ•°æ®åº“é—®é¢˜

**Priority**: **LOW** (å·²æœ‰åˆç†çš„é”™è¯¯å¤„ç†)

---

## Risk Summary

### Risk Distribution

| Risk Level | Count | Risk IDs |
|-----------|-------|----------|
| CRITICAL  | 0     | -        |
| HIGH      | 0     | -        |
| MEDIUM    | 1     | RISK-001 |
| LOW       | 2     | RISK-002, RISK-003 |

### Overall Risk Level Determination

**Calculation**:
- Highest Risk Score: 4 (MEDIUM)
- Critical Risks: 0
- High Risks: 0

**Result**: ğŸŸ¡ **LOW-MEDIUM**

**Rationale**:
ä»…æœ‰ä¸€ä¸ª MEDIUM é£é™© (current_connections è´Ÿæ•°),ä¸”æœ‰æ˜ç¡®çš„ç¼“è§£æ–¹æ¡ˆã€‚å…¶ä»–é£é™©å‡ä¸º LOW çº§åˆ«,å·²æœ‰åˆç†çš„å¤„ç†æœºåˆ¶ã€‚æ€»ä½“é£é™©å¯æ§ã€‚

---

## Test Coverage Analysis

### Requirements Traceability

| AC  | Requirement | Test Coverage | Status |
|-----|------------|---------------|--------|
| AC1 | Schema å®šä¹‰ | Schema å®¡æŸ¥ | âœ… PASS |
| AC2 | æ•°æ®åº“è¿ç§» | è¿ç§»æ–‡ä»¶éªŒè¯ | âœ… PASS |
| AC3 | connect é€’å¢ | `stats.service.test.ts:37-66` | âœ… PASS |
| AC4 | disconnect é€’å‡ | `stats.service.test.ts:68-97` | âœ… PASS |
| AC5 | message é€’å¢ | `stats.service.test.ts:99-140` | âœ… PASS |
| AC6 | last_active_at | `stats.service.test.ts:135-139` | âœ… PASS |
| AC7 | ç»Ÿè®¡æ›´æ–°å‡½æ•° | `stats.service.test.ts:34-162` | âœ… PASS |
| AC8 | upsert é€»è¾‘ | `stats.service.test.ts:142-162` | âœ… PASS |
| AC9 | æ‰‹åŠ¨éªŒè¯ | Task 6 (æœªå®Œæˆ) | âš ï¸ PENDING |

**Coverage Rate**: 8/9 (88.9%)

### Test Quality Assessment

**Unit Tests**: âœ… **Excellent**
- 6 ä¸ªæµ‹è¯•ç”¨ä¾‹,è¦†ç›–æ‰€æœ‰ä¸šåŠ¡é€»è¾‘
- ä½¿ç”¨ Jest Mock éš”ç¦»æ•°æ®åº“ä¾èµ–
- éªŒè¯æ­£å‘æµç¨‹å’Œé”™è¯¯å¤„ç†

**Integration Tests**: âš ï¸ **Missing**
- ç¼ºå°‘ WebSocket é›†æˆæµ‹è¯•
- å»ºè®®æ·»åŠ ä½†ä¸é˜»å¡å‘å¸ƒ

**Manual Tests**: â¸ï¸ **Pending**
- Task 6 æ‰‹åŠ¨éªŒè¯æœªå®Œæˆ
- å»ºè®®åœ¨éƒ¨ç½²å‰å®Œæˆ

---

## Non-Functional Requirements Assessment

### Security: âœ… PASS

**Findings**:
- âœ… ä½¿ç”¨ Prisma å‚æ•°åŒ–æŸ¥è¯¢,æ—  SQL æ³¨å…¥é£é™©
- âœ… é”™è¯¯ä¿¡æ¯ä¸æ³„éœ²æ•æ„Ÿæ•°æ®
- âœ… ä½¿ç”¨æ•°æ®åº“ UUID é¿å… ID æšä¸¾
- âœ… çº§è”åˆ é™¤ä¿è¯æ•°æ®ä¸€è‡´æ€§
- âœ… æ— å¤–éƒ¨ API æš´éœ²,å†…éƒ¨æœåŠ¡è°ƒç”¨

**Concerns**: None

---

### Performance: âœ… PASS

**Findings**:
- âœ… ä½¿ç”¨ Prisma `increment`/`decrement` åŸå­æ“ä½œ
- âœ… ç´¢å¼•è¦†ç›–æŸ¥è¯¢å­—æ®µ (`endpoint_id`)
- âœ… å¼‚æ­¥éé˜»å¡,ä¸å½±å“ WebSocket æ€§èƒ½
- âœ… `@updatedAt` è‡ªåŠ¨æ›´æ–°,å‡å°‘åº”ç”¨é€»è¾‘

**Potential Bottlenecks**:
- é«˜å¹¶å‘åœºæ™¯ä¸‹æ•°æ®åº“æ›´æ–°å¯èƒ½æˆä¸ºç“¶é¢ˆ
- å»ºè®®ç›‘æ§æ•°æ®åº“è¿æ¥æ± ä½¿ç”¨ç‡

**Future Optimizations**:
- è€ƒè™‘ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—æ‰¹é‡æ›´æ–°ç»Ÿè®¡
- æ·»åŠ  Redis ç¼“å­˜å‡å°‘æ•°æ®åº“å‹åŠ›

---

### Reliability: âœ… PASS

**Findings**:
- âœ… å®Œå–„çš„é”™è¯¯å¤„ç† (try-catch)
- âœ… é”™è¯¯ä¸æŠ›å‡º,ç¡®ä¿æœåŠ¡å¯ç”¨æ€§
- âœ… ä½¿ç”¨ `upsert` é¿å…è®°å½•ä¸å­˜åœ¨é”™è¯¯
- âœ… å¼‚æ­¥æ›´æ–°ä¸é˜»å¡ä¸»æµç¨‹

**Concerns**:
- âš ï¸ RISK-001: è´Ÿæ•°é˜²æŠ¤éœ€è¦åŠ å¼º

---

### Maintainability: âœ… PASS

**Findings**:
- âœ… ä»£ç ç»“æ„æ¸…æ™°,èŒè´£å•ä¸€
- âœ… å‘½åè§„èŒƒç¬¦åˆé¡¹ç›®æ ‡å‡†
- âœ… JSDoc æ³¨é‡Šå®Œæ•´
- âœ… æµ‹è¯•è¦†ç›–å…¨é¢,ä¾¿äºé‡æ„

**Concerns**: None

---

## Recommendations

### Immediate Actions (Before Production)

1. **[MEDIUM] å®ç° current_connections è´Ÿæ•°é˜²æŠ¤é€»è¾‘**
   - **Owner**: Dev Team
   - **Effort**: 15 minutes
   - **Priority**: MUST FIX
   - **Implementation**: è§ RISK-001 Mitigation éƒ¨åˆ†

2. **[LOW] å®Œæˆ Task 6 æ‰‹åŠ¨æµ‹è¯•**
   - **Owner**: Dev Team
   - **Effort**: 30 minutes
   - **Priority**: SHOULD DO
   - **Steps**:
     1. å¯åŠ¨ WebSocket æœåŠ¡å™¨
     2. è¿æ¥å¤šä¸ªå®¢æˆ·ç«¯
     3. å‘é€æ¶ˆæ¯å¹¶æ–­å¼€è¿æ¥
     4. åœ¨ Prisma Studio ä¸­éªŒè¯ç»Ÿè®¡æ•°æ®

### Future Improvements (Post-Release)

3. **[LOW] æ·»åŠ  WebSocket é›†æˆæµ‹è¯•**
   - **Owner**: Dev Team
   - **Effort**: 1-2 hours
   - **Priority**: NICE TO HAVE
   - **Benefit**: æé«˜æµ‹è¯•è¦†ç›–ç‡å’Œä¿¡å¿ƒ

4. **[FUTURE] ä¿®å¤é¡¹ç›®çº§æµ‹è¯•åŸºç¡€è®¾æ–½**
   - **Owner**: Platform Team
   - **Effort**: 2-4 hours
   - **Priority**: BACKLOG
   - **Note**: Jest Mock é…ç½®é—®é¢˜å½±å“æ•´ä¸ªé¡¹ç›®

5. **[FUTURE] æ·»åŠ ç»Ÿè®¡æ•°æ®å¥åº·æ£€æŸ¥**
   - **Owner**: Dev Team
   - **Effort**: 1 hour
   - **Priority**: BACKLOG
   - **Benefit**: ç›‘æ§ç»Ÿè®¡æ•°æ®å‡†ç¡®æ€§

---

## Decision

**Gate Status**: ğŸŸ¡ **CONCERNS**

**Rationale**:
- å®ç°è´¨é‡ä¼˜ç§€,æ¶æ„è®¾è®¡åˆç†
- å­˜åœ¨ä¸€ä¸ª MEDIUM é£é™©éœ€è¦ä¿®å¤ (RISK-001)
- LOW é£é™©å¯åœ¨åç»­ Sprint ä¸­è§£å†³

**Recommendation**: **Conditionally Approve**
- ä¿®å¤ current_connections è´Ÿæ•°é˜²æŠ¤é€»è¾‘åå¯éƒ¨ç½²ç”Ÿäº§
- å»ºè®®å®Œæˆæ‰‹åŠ¨æµ‹è¯•éªŒè¯
- LOW ä¼˜å…ˆçº§æ”¹è¿›å¯æ¨è¿Ÿ

**Quality Score**: 85/100

---

## Approval

**Test Architect**: Quinn
**Date**: 2025-10-28
**Gate File**: `docs/qa/gates/3.5-connection-stats-database.yml`

---

*æœ¬é£é™©è¯„ä¼°åŸºäº BMADâ„¢ è´¨é‡ä¿è¯æµç¨‹ç”Ÿæˆ,éµå¾ªé£é™©é©±åŠ¨æµ‹è¯•ç­–ç•¥å’Œ Given-When-Then éœ€æ±‚è¿½æº¯æ–¹æ³•ã€‚*
