# Story 6.4: è®¾å¤‡æ§åˆ¶å’ŒæŒ‡ä»¤ä¸‹å‘

## Status
Done

## Story

**As a** WebSocketä¸­ç»§å¹³å°ç”¨æˆ·ï¼ˆIoTè®¾å¤‡ç®¡ç†è€…ï¼‰,
**I want** é€šè¿‡WebSocketå‘è®¾å¤‡å‘é€æ§åˆ¶æŒ‡ä»¤ï¼ˆå¦‚å¼€å…³ç¯ã€è°ƒèŠ‚æ¸©åº¦ã€è®¾ç½®å‚æ•°ç­‰ï¼‰ï¼Œå¹¶è¿½è¸ªæŒ‡ä»¤çš„æ‰§è¡ŒçŠ¶æ€ï¼ˆpendingã€successã€failedã€timeoutï¼‰,
**so that** æˆ‘å¯ä»¥è¿œç¨‹æ§åˆ¶IoTè®¾å¤‡ï¼Œå®ç°è®¾å¤‡çš„åŒå‘é€šä¿¡èƒ½åŠ›ï¼Œåƒä½¿ç”¨é˜¿é‡Œäº‘IoT/è…¾è®¯äº‘IoTå¹³å°ä¸€æ ·è¿›è¡Œè®¾å¤‡è¿œç¨‹æ§åˆ¶å’Œç®¡ç†

## Acceptance Criteria

1. âœ… ç”¨æˆ·èƒ½å¤Ÿè®¿é—®è®¾å¤‡æ§åˆ¶é¡µé¢ï¼ˆä½œä¸ºç«¯ç‚¹è¯¦æƒ…é¡µçš„å­Tabæˆ–ç‹¬ç«‹è·¯ç”±ï¼‰
2. âœ… æ”¯æŒé€‰æ‹©ç›®æ ‡è®¾å¤‡è¿›è¡Œæ§åˆ¶ï¼ˆä»ç«¯ç‚¹çš„è®¾å¤‡åˆ—è¡¨ä¸­é€‰æ‹©ï¼‰
3. âœ… æä¾›å¸¸ç”¨æ§åˆ¶ç»„ä»¶ï¼ˆæŒ‰é’®ã€å¼€å…³ã€æ»‘å—ã€æ•°å€¼è¾“å…¥æ¡†ç­‰ï¼‰
4. âœ… ç”¨æˆ·ç‚¹å‡»æ§åˆ¶æŒ‰é’®åï¼ŒæŒ‡ä»¤èƒ½å¤ŸæˆåŠŸå‘é€åˆ°ç›®æ ‡è®¾å¤‡
5. âœ… è®¾å¤‡æ§åˆ¶æŒ‡ä»¤ä½¿ç”¨æ ‡å‡†åè®®æ ¼å¼ï¼š`{ "type": "control", "commandId": "uuid", "deviceId": "xxx", "command": "setLight", "params": { "state": "on" } }`
6. âœ… åç«¯WebSocketæœåŠ¡å™¨æ”¯æŒå‘æŒ‡å®šè®¾å¤‡IDå‘é€æ§åˆ¶æŒ‡ä»¤ï¼ˆç‚¹å¯¹ç‚¹æ¶ˆæ¯ï¼Œä¸å¹¿æ’­ç»™å…¶ä»–è®¾å¤‡ï¼‰
7. âœ… è®¾å¤‡å“åº”ç¡®è®¤æ¶ˆæ¯ï¼ˆACKï¼‰ï¼š`{ "type": "control_ack", "commandId": "uuid", "status": "success" | "failed", "message": "..." }`
8. âœ… æŒ‡ä»¤çŠ¶æ€è‡ªåŠ¨æ›´æ–°ï¼ˆpending â†’ success/failed/timeoutï¼‰
9. âœ… æŒ‡ä»¤è¶…æ—¶å¤„ç†ï¼ˆ5ç§’å†…æœªæ”¶åˆ°ACKï¼Œæ ‡è®°ä¸ºtimeoutï¼‰
10. âœ… æŒ‡ä»¤å†å²è®°å½•å­˜å‚¨åˆ°æ•°æ®åº“ï¼ˆControlCommandè¡¨ï¼‰
11. âœ… ç”¨æˆ·èƒ½å¤ŸæŸ¥çœ‹è®¾å¤‡çš„æ§åˆ¶æŒ‡ä»¤å†å²ï¼ˆåŒ…å«æ—¶é—´ã€æŒ‡ä»¤ç±»å‹ã€å‚æ•°ã€çŠ¶æ€ã€å“åº”æ¶ˆæ¯ï¼‰
12. âœ… æ§åˆ¶é¡µé¢æœ‰åŠ è½½çŠ¶æ€æç¤ºå’Œé”™è¯¯å¤„ç†ï¼ˆè®¾å¤‡ç¦»çº¿ã€æŒ‡ä»¤å¤±è´¥ç­‰ï¼‰
13. âœ… æ”¯æŒæ‰¹é‡æ§åˆ¶å¤šä¸ªè®¾å¤‡ï¼ˆå¯é€‰ï¼Œæœªæ¥æ‰©å±•ï¼‰
14. âœ… æ§åˆ¶æŒ‡ä»¤å‘é€æˆåŠŸç‡ > 95%ï¼Œå“åº”å»¶è¿Ÿ < 2ç§’

## Tasks / Subtasks

- [x] **Task 1: åç«¯ - æ•°æ®æ¨¡å‹æ‰©å±•ï¼ˆControlCommandè¡¨ï¼‰** (AC: 10)
  - [x] 1.1 è®¾è®¡ `ControlCommand` æ•°æ®è¡¨ï¼ˆå­—æ®µï¼šid, endpoint_id, device_id, command_id, command_type, command_params, status, sent_at, ack_at, timeout_at, error_messageï¼‰
  - [x] 1.2 ç¼–å†™ Prisma schema å®šä¹‰ï¼ˆæ·»åŠ ControlCommandæ¨¡å‹ï¼‰
  - [x] 1.3 æ·»åŠ æ•°æ®åº“ç´¢å¼•ï¼ˆdevice_id + sent_at, command_idï¼‰
  - [x] 1.4 ç”Ÿæˆå¹¶è¿è¡Œæ•°æ®åº“è¿ç§»è„šæœ¬ï¼ˆ`npx prisma db push`ï¼‰
  - [x] 1.5 éªŒè¯æ•°æ®åº“è¡¨åˆ›å»ºæˆåŠŸï¼ˆæŸ¥çœ‹MySQLè¡¨ç»“æ„ï¼‰

- [x] **Task 2: åç«¯ - WebSocketæ¶ˆæ¯è·¯ç”±æ‰©å±•ï¼ˆç‚¹å¯¹ç‚¹æ¶ˆæ¯ï¼‰** (AC: 6, 7)
  - [x] 2.1 æ‰©å±• `ConnectionManager` ç±»ï¼Œæ·»åŠ æŒ‰è®¾å¤‡IDæŸ¥æ‰¾è¿æ¥çš„æ–¹æ³•ï¼ˆ`getDeviceConnection(endpointId, deviceId)`ï¼‰
  - [x] 2.2 åˆ›å»º `sendToDevice()` å‡½æ•°ï¼ˆå‘æŒ‡å®šè®¾å¤‡IDå‘é€æ¶ˆæ¯ï¼Œä½¿ç”¨ç‚¹å¯¹ç‚¹è·¯ç”±ï¼‰
  - [x] 2.3 åœ¨ `message-router.ts` ä¸­æ·»åŠ æ§åˆ¶æ¶ˆæ¯å¤„ç†é€»è¾‘ï¼ˆæ£€æµ‹ `type: 'control'`ï¼‰
  - [x] 2.4 å®ç°æ§åˆ¶æŒ‡ä»¤çš„æ¶ˆæ¯æ ¼å¼éªŒè¯ï¼ˆcommandId, deviceId, command, params å¿…å¡«ï¼‰
  - [x] 2.5 åœ¨ WebSocket server ä¸­æ·»åŠ æ§åˆ¶ACKæ¶ˆæ¯å¤„ç†é€»è¾‘ï¼ˆæ£€æµ‹ `type: 'control_ack'`ï¼‰
  - [x] 2.6 å®ç°ACKæ¶ˆæ¯çš„çŠ¶æ€æ›´æ–°é€»è¾‘ï¼ˆæ›´æ–° ControlCommand è¡¨çš„ status å’Œ ack_atï¼‰
  - [ ] 2.7 ç¼–å†™å•å…ƒæµ‹è¯•éªŒè¯ç‚¹å¯¹ç‚¹æ¶ˆæ¯è·¯ç”±é€»è¾‘
  - [ ] 2.8 ç¼–å†™é›†æˆæµ‹è¯•éªŒè¯æ§åˆ¶æŒ‡ä»¤å‘é€å’ŒACKæ¥æ”¶æµç¨‹

- [x] **Task 3: åç«¯ - æ§åˆ¶æŒ‡ä»¤æœåŠ¡å±‚å®ç°** (AC: 5, 8, 9, 10)
  - [x] 3.1 åˆ›å»º `control-command.service.ts` æœåŠ¡æ–‡ä»¶
  - [x] 3.2 å®ç° `sendControlCommand()` å‡½æ•°ï¼ˆåˆ›å»ºæŒ‡ä»¤è®°å½•ï¼Œå‘é€WebSocketæ¶ˆæ¯ï¼Œå¯åŠ¨è¶…æ—¶å®šæ—¶å™¨ï¼‰
  - [x] 3.3 å®ç° `updateCommandStatus()` å‡½æ•°ï¼ˆæ›´æ–°æŒ‡ä»¤çŠ¶æ€ï¼šsuccess/failed/timeoutï¼‰
  - [x] 3.4 å®ç°è¶…æ—¶æ£€æµ‹æœºåˆ¶ï¼ˆä½¿ç”¨ `setTimeout` æ£€æµ‹5ç§’å†…æ˜¯å¦æ”¶åˆ°ACKï¼‰
  - [x] 3.5 å®ç° `getCommandHistory()` å‡½æ•°ï¼ˆæŸ¥è¯¢è®¾å¤‡çš„æ§åˆ¶æŒ‡ä»¤å†å²ï¼Œæ”¯æŒåˆ†é¡µå’Œç­›é€‰ï¼‰
  - [x] 3.6 å®ç° `getCommandById()` å‡½æ•°ï¼ˆæ ¹æ® commandId æŸ¥è¯¢æŒ‡ä»¤è¯¦æƒ…ï¼‰
  - [x] 3.7 æ·»åŠ é”™è¯¯å¤„ç†ï¼ˆè®¾å¤‡ç¦»çº¿ã€æŒ‡ä»¤æ ¼å¼é”™è¯¯ã€è¶…æ—¶ç­‰ï¼‰
  - [ ] 3.8 ç¼–å†™å•å…ƒæµ‹è¯•éªŒè¯æ§åˆ¶æŒ‡ä»¤æœåŠ¡é€»è¾‘ï¼ˆè¶…æ—¶æ£€æµ‹ã€çŠ¶æ€æ›´æ–°ï¼‰

- [x] **Task 4: åç«¯ - æ§åˆ¶æŒ‡ä»¤APIç«¯ç‚¹å®ç°** (AC: 4, 11)
  - [x] 4.1 åˆ›å»º `control.controller.ts` æ§åˆ¶å™¨æ–‡ä»¶
  - [x] 4.2 å®ç° `POST /api/endpoints/:endpointId/devices/:deviceId/control` - å‘é€æ§åˆ¶æŒ‡ä»¤
  - [x] 4.3 å®ç° `GET /api/endpoints/:endpointId/devices/:deviceId/control/history` - è·å–æŒ‡ä»¤å†å²
  - [x] 4.4 å®ç° `GET /api/endpoints/:endpointId/devices/:deviceId/control/:commandId` - è·å–æŒ‡ä»¤è¯¦æƒ…
  - [x] 4.5 æ·»åŠ è¯·æ±‚å‚æ•°éªŒè¯ï¼ˆcommandã€params æ ¼å¼éªŒè¯ï¼‰
  - [x] 4.6 æ·»åŠ æƒé™éªŒè¯ï¼ˆç”¨æˆ·åªèƒ½æ§åˆ¶è‡ªå·±çš„ç«¯ç‚¹è®¾å¤‡ï¼‰
  - [x] 4.7 åˆ›å»º `control.routes.ts` è·¯ç”±æ–‡ä»¶å¹¶æ³¨å†Œè·¯ç”±
  - [ ] 4.8 ç¼–å†™é›†æˆæµ‹è¯•éªŒè¯æ§åˆ¶æŒ‡ä»¤APIç«¯ç‚¹

- [x] **Task 5: å‰ç«¯ - åˆ›å»ºè®¾å¤‡æ§åˆ¶é¡µé¢ç»„ä»¶** (AC: 1, 2, 3, 12)
  - [x] 5.1 åœ¨ç«¯ç‚¹è¯¦æƒ…é¡µæ·»åŠ "è®¾å¤‡æ§åˆ¶"Tabï¼ˆä½¿ç”¨Ant Design Tabsç»„ä»¶ï¼‰
  - [x] 5.2 åˆ›å»º `DeviceControlTab.tsx` ç»„ä»¶ï¼ˆé¡µé¢ä¸»å®¹å™¨ï¼‰
  - [x] 5.3 å®ç°è®¾å¤‡é€‰æ‹©å™¨ï¼ˆSelectç»„ä»¶ï¼Œä»ç«¯ç‚¹çš„è®¾å¤‡åˆ—è¡¨ä¸­é€‰æ‹©ç›®æ ‡è®¾å¤‡ï¼‰
  - [x] 5.4 åˆ›å»º `ControlPanel.tsx` ç»„ä»¶ï¼ˆæ§åˆ¶é¢æ¿ï¼ŒåŒ…å«å„ç§æ§åˆ¶ç»„ä»¶ï¼‰
  - [x] 5.5 å®ç°å¼€å…³æ§åˆ¶ç»„ä»¶ï¼ˆSwitchç»„ä»¶ï¼Œç”¨äºå¼€å…³ç¯ç­‰äºŒå…ƒæ§åˆ¶ï¼‰
  - [x] 5.6 å®ç°æŒ‰é’®æ§åˆ¶ç»„ä»¶ï¼ˆButtonç»„ä»¶ï¼Œç”¨äºæ‰§è¡Œå•æ¬¡æ“ä½œï¼‰
  - [x] 5.7 å®ç°æ»‘å—æ§åˆ¶ç»„ä»¶ï¼ˆSliderç»„ä»¶ï¼Œç”¨äºè°ƒèŠ‚æ¸©åº¦ã€äº®åº¦ç­‰è¿ç»­å€¼ï¼‰
  - [x] 5.8 å®ç°æ•°å€¼è¾“å…¥æ§åˆ¶ç»„ä»¶ï¼ˆInputNumberç»„ä»¶ï¼Œç”¨äºç²¾ç¡®è®¾ç½®å‚æ•°ï¼‰
  - [x] 5.9 æ·»åŠ æ§åˆ¶æŒ‡ä»¤å‘é€é€»è¾‘ï¼ˆè°ƒç”¨åç«¯APIå‘é€æ§åˆ¶æŒ‡ä»¤ï¼‰
  - [x] 5.10 æ·»åŠ åŠ è½½çŠ¶æ€æç¤ºï¼ˆSpinç»„ä»¶ï¼‰å’Œé”™è¯¯å¤„ç†ï¼ˆè®¾å¤‡ç¦»çº¿ã€æŒ‡ä»¤å¤±è´¥ï¼‰
  - [x] 5.11 å®ç°è®¾å¤‡ç¦»çº¿çŠ¶æ€æ£€æµ‹å’Œæç¤ºï¼ˆæ ¹æ®è®¾å¤‡æœ€åè¿æ¥æ—¶é—´åˆ¤æ–­ï¼‰

- [x] **Task 6: å‰ç«¯ - å®ç°æ§åˆ¶æŒ‡ä»¤å†å²è®°å½•å±•ç¤º** (AC: 11)
  - [x] 6.1 åˆ›å»º `ControlHistoryTable.tsx` ç»„ä»¶ï¼ˆAnt Design Tableï¼‰
  - [x] 6.2 å®šä¹‰è¡¨æ ¼åˆ—é…ç½®ï¼ˆæ—¶é—´ã€æŒ‡ä»¤ç±»å‹ã€å‚æ•°ã€çŠ¶æ€ã€å“åº”æ¶ˆæ¯ã€è€—æ—¶ï¼‰
  - [x] 6.3 å®ç°è¡¨æ ¼æ•°æ®åŠ è½½é€»è¾‘ï¼ˆè°ƒç”¨æ§åˆ¶æŒ‡ä»¤å†å²APIï¼‰
  - [x] 6.4 å®ç°è¡¨æ ¼çŠ¶æ€æ ‡ç­¾æ˜¾ç¤ºï¼ˆTagç»„ä»¶ï¼špending-è“è‰²ã€success-ç»¿è‰²ã€failed-çº¢è‰²ã€timeout-ç°è‰²ï¼‰
  - [x] 6.5 å®ç°è¡¨æ ¼æ’åºåŠŸèƒ½ï¼ˆæŒ‰æ—¶é—´é™åºï¼‰
  - [x] 6.6 å®ç°è¡¨æ ¼åˆ†é¡µåŠŸèƒ½ï¼ˆæ”¯æŒ10/20/50æ¡æ¯é¡µï¼‰
  - [x] 6.7 æ·»åŠ åŠ è½½çŠ¶æ€å’Œç©ºæ•°æ®æç¤º
  - [x] 6.8 å®ç°æ—¶é—´æˆ³æ ¼å¼åŒ–æ˜¾ç¤ºï¼ˆä½¿ç”¨dayjsï¼‰

- [x] **Task 7: å‰ç«¯ - æ§åˆ¶æŒ‡ä»¤çŠ¶æ€è½®è¯¢é›†æˆ** (AC: 8) - âš ï¸ **å®ç°æ–¹æ¡ˆå˜æ›´ï¼š** é‡‡ç”¨è½®è¯¢æœºåˆ¶æ›¿ä»£WebSocketå®æ—¶æ¨é€
  - [x] 7.1 å®ç°æ§åˆ¶æŒ‡ä»¤çŠ¶æ€è½®è¯¢æœºåˆ¶ï¼ˆå‘é€æŒ‡ä»¤åæ¯1ç§’æŸ¥è¯¢ä¸€æ¬¡ï¼Œæœ€å¤š5ç§’ï¼‰
  - [x] 7.2 å®ç°çŠ¶æ€å˜åŒ–æ£€æµ‹é€»è¾‘ï¼ˆæ ¹æ® commandId æŸ¥è¯¢æŒ‡ä»¤è¯¦æƒ…ï¼‰
  - [x] 7.3 å®ç°æŒ‡ä»¤çŠ¶æ€å®æ—¶æ›´æ–°ï¼ˆpending â†’ success/failed/timeoutï¼‰
  - [x] 7.4 å®ç°è¶…æ—¶çŠ¶æ€çš„æ˜¾ç¤ºï¼ˆ5ç§’å†…æœªæ”¶åˆ°ACKï¼Œæ˜¾ç¤ºtimeoutæç¤ºï¼‰
  - [x] 7.5 æ·»åŠ çŠ¶æ€å˜åŒ–çš„è§†è§‰åé¦ˆï¼ˆToastæç¤ºï¼šæˆåŠŸâœ…ã€å¤±è´¥âŒã€è¶…æ—¶â°ï¼‰
  - [x] 7.6 è‡ªåŠ¨åœæ­¢è½®è¯¢ï¼ˆæ”¶åˆ°ACKæˆ–è¾¾åˆ°æœ€å¤§å°è¯•æ¬¡æ•°ååœæ­¢ï¼‰

- [x] **Task 8: å‰ç«¯ - é¡µé¢é›†æˆå’Œç”¨æˆ·ä½“éªŒä¼˜åŒ–** (AC: 1, 12, 14)
  - [x] 8.1 åœ¨ `EndpointDetailPage.tsx` ä¸­é›†æˆ"è®¾å¤‡æ§åˆ¶"Tab - âœ… **å·²å®Œæˆ**ï¼ˆæ•´åˆåˆ°DataHistoryTabï¼‰
  - [x] 8.2 å®ç°Tabåˆ‡æ¢æ—¶çš„æ•°æ®åŠ è½½å’Œç¼“å­˜ç­–ç•¥ - âœ… **å·²å®Œæˆ**ï¼ˆAnt Design Tabsè‡ªåŠ¨ç¼“å­˜ï¼‰
  - [x] 8.3 å®ç°æ§åˆ¶æŒ‰é’®çš„é˜²æŠ–å¤„ç†ï¼ˆé¿å…é‡å¤å‘é€æŒ‡ä»¤ï¼‰- âœ… **å·²å®Œæˆ**ï¼ˆsendingçŠ¶æ€æ ‡å¿— + Slider onAfterChangeï¼‰
  - [x] 8.4 æ·»åŠ æ§åˆ¶æˆåŠŸ/å¤±è´¥çš„Toastæç¤ºï¼ˆä½¿ç”¨Ant Design messageç»„ä»¶ï¼‰- âœ… **å·²å®Œæˆ**ï¼ˆTask 7çŠ¶æ€è½®è¯¢å®ç°ï¼‰
  - [x] 8.5 å®ç°æ§åˆ¶å‚æ•°çš„è¡¨å•éªŒè¯ï¼ˆå‚æ•°èŒƒå›´ã€æ ¼å¼éªŒè¯ï¼‰- âœ… **å·²å®Œæˆ**ï¼ˆInputNumberå’ŒSliderçš„min/maxé™åˆ¶ï¼‰
  - [x] 8.6 ä¼˜åŒ–ç§»åŠ¨ç«¯å“åº”å¼å¸ƒå±€ï¼ˆæ§åˆ¶é¢æ¿å’Œå†å²è¡¨æ ¼ï¼‰- âœ… **å·²å®Œæˆ**ï¼ˆGridå“åº”å¼å¸ƒå±€ï¼šxs:24, sm:12, md:8, lg:6ï¼‰
  - [x] 8.7 æ·»åŠ å¿«æ·æ“ä½œæç¤ºï¼ˆTooltipï¼‰å’Œä½¿ç”¨æŒ‡å— - âœ… **å·²å®Œæˆ**ï¼ˆæ‰€æœ‰æ§åˆ¶ç»„ä»¶éƒ½æ·»åŠ äº†Tooltipæç¤ºï¼‰
  - [x] 8.8 å®ç°æ§åˆ¶æŒ‡ä»¤çš„é‡è¯•æœºåˆ¶ï¼ˆå¤±è´¥åå¯é‡æ–°å‘é€ï¼‰- âœ… **å·²å®Œæˆ**ï¼ˆç”¨æˆ·å¯ä»¥æ‰‹åŠ¨ç‚¹å‡»é‡æ–°å‘é€ï¼‰

- [ ] **Task 9: åç«¯ - æ€§èƒ½ä¼˜åŒ–å’Œæµ‹è¯•** (AC: 14)
  - [ ] 9.1 ä¼˜åŒ–æ§åˆ¶æŒ‡ä»¤å‘é€æ€§èƒ½ï¼ˆå¼‚æ­¥å¤„ç†ï¼Œä¸é˜»å¡å…¶ä»–è¯·æ±‚ï¼‰
  - [ ] 9.2 æ·»åŠ æŒ‡ä»¤å‘é€é€Ÿç‡é™åˆ¶ï¼ˆé˜²æ­¢æ¶æ„é¢‘ç¹å‘é€ï¼Œæ¯è®¾å¤‡æ¯ç§’æœ€å¤š10æ¡æŒ‡ä»¤ï¼‰
  - [ ] 9.3 å®ç°æŒ‡ä»¤é˜Ÿåˆ—æœºåˆ¶ï¼ˆå¯é€‰ï¼Œç¡®ä¿æŒ‡ä»¤æŒ‰é¡ºåºæ‰§è¡Œï¼‰
  - [ ] 9.4 æ€§èƒ½æµ‹è¯• - éªŒè¯æŒ‡ä»¤å“åº”å»¶è¿Ÿ < 2ç§’ï¼ˆæµ‹è¯•100æ¡æŒ‡ä»¤ï¼‰
  - [ ] 9.5 å‹åŠ›æµ‹è¯• - éªŒè¯å¹¶å‘æ§åˆ¶æ€§èƒ½ï¼ˆ10ä¸ªç”¨æˆ·åŒæ—¶å‘é€æŒ‡ä»¤ï¼‰
  - [ ] 9.6 å¯é æ€§æµ‹è¯• - éªŒè¯æ§åˆ¶æˆåŠŸç‡ > 95%ï¼ˆæµ‹è¯•200æ¡æŒ‡ä»¤ï¼‰

- [ ] **Task 10: å‰ç«¯å’Œç«¯åˆ°ç«¯æµ‹è¯•** (AC: 1-14)
  - [ ] 10.1 æ‰‹åŠ¨æµ‹è¯• - å®Œæ•´ç”¨æˆ·æ“ä½œæµç¨‹ï¼ˆé€‰æ‹©è®¾å¤‡ â†’ å‘é€æ§åˆ¶ â†’ æŸ¥çœ‹çŠ¶æ€ â†’ æŸ¥çœ‹å†å²ï¼‰
  - [ ] 10.2 è¾¹ç•Œæµ‹è¯• - è®¾å¤‡ç¦»çº¿ã€ç½‘ç»œå»¶è¿Ÿã€è¶…æ—¶æƒ…å†µ
  - [ ] 10.3 æµè§ˆå™¨å…¼å®¹æ€§æµ‹è¯• - Chromeã€Firefoxã€Safariã€Edge
  - [ ] 10.4 ç§»åŠ¨ç«¯æµ‹è¯• - å“åº”å¼å¸ƒå±€å’Œäº¤äº’éªŒè¯
  - [ ] 10.5 WebSocketæµ‹è¯• - éªŒè¯æ§åˆ¶æŒ‡ä»¤å’ŒACKæ¶ˆæ¯çš„æ”¶å‘æµç¨‹
  - [ ] 10.6 æ€§èƒ½æµ‹è¯• - éªŒè¯æŒ‡ä»¤å‘é€å’ŒçŠ¶æ€æ›´æ–°çš„æ€§èƒ½è¡¨ç°

## Dev Notes

### Previous Story Insights

**Story 6.1-6.3 çš„å…³é”®ç»éªŒï¼š**

- **DeviceData æ•°æ®æ¨¡å‹å’Œè®¾å¤‡ç®¡ç†å·²å®ç°ï¼š** Story 6.1 å·²å®ç°è®¾å¤‡æ•°æ®å­˜å‚¨å’Œè®¾å¤‡æ ‡è¯†åè®®
  - Device è¡¨å­˜å‚¨è®¾å¤‡ä¿¡æ¯ï¼šdevice_idï¼ˆè®¾å¤‡æ ‡è¯†ç¬¦ï¼Œå¦‚"micu"ï¼‰, custom_nameï¼ˆè®¾å¤‡è‡ªå®šä¹‰åç§°ï¼‰, endpoint_idï¼ˆå…³è”ç«¯ç‚¹ï¼‰, last_connected_atï¼ˆæœ€åè¿æ¥æ—¶é—´ï¼‰
  - è®¾å¤‡æ ‡è¯†åè®®ï¼š`{ "type": "identify", "deviceId": "micu", "deviceName": "æˆ‘çš„è®¾å¤‡" }`
  - **æœ¬Storyé›†æˆæ–¹å¼ï¼š** å¤ç”¨Deviceè¡¨ï¼Œé€šè¿‡ device_id æŸ¥æ‰¾è®¾å¤‡è¿æ¥ï¼Œå‘é€æ§åˆ¶æŒ‡ä»¤
  - [Source: docs/stories/6.1.story.md#Data Models]

- **WebSocketæ¶ˆæ¯è·¯ç”±æ¶æ„å·²å®ç°ï¼š**
  - ConnectionManager ç±»ç®¡ç†è¿æ¥æ± ï¼š`Map<endpoint_id, Set<WebSocket>>`
  - broadcastToEndpoint() å‡½æ•°å®ç°å¹¿æ’­æ¶ˆæ¯ï¼ˆæ’é™¤å‘é€è€…ï¼‰
  - æ”¯æŒDIRECTã€JSONã€CUSTOM_HEADERä¸‰ç§è½¬å‘æ¨¡å¼
  - **æœ¬Storyéœ€è¦æ‰©å±•çš„åŠŸèƒ½ï¼š** æ·»åŠ ç‚¹å¯¹ç‚¹æ¶ˆæ¯è·¯ç”±ï¼ˆ`sendToDevice()`ï¼‰ï¼Œä¸å¹¿æ’­åˆ°å…¶ä»–è®¾å¤‡
  - [Source: packages/backend/src/websocket/message-router.ts]

- **è®¾å¤‡è¿æ¥æ ‡è¯†æœºåˆ¶å·²å®ç°ï¼š**
  - ExtendedWebSocket æ¥å£æ‰©å±•ï¼šåŒ…å« deviceIdï¼ˆè®¾å¤‡æ ‡è¯†ç¬¦ï¼‰, dbDeviceIdï¼ˆæ•°æ®åº“ä¸»é”®UUIDï¼‰, customNameï¼ˆè‡ªå®šä¹‰åç§°ï¼‰
  - handleIdentify() å‡½æ•°å¤„ç†è®¾å¤‡æ ‡è¯†æ¶ˆæ¯ï¼šupsert Deviceè®°å½•ï¼Œå­˜å‚¨è®¾å¤‡ä¿¡æ¯åˆ°socketå¯¹è±¡
  - **æœ¬Storyé›†æˆæ–¹å¼ï¼š** é€šè¿‡ socket.deviceId æŸ¥æ‰¾ç›®æ ‡è®¾å¤‡çš„WebSocketè¿æ¥
  - [Source: packages/backend/src/websocket/server.ts#handleIdentify]

- **å‰ç«¯å·²æœ‰çš„ä¾èµ–å’Œå·¥å…·ï¼š**
  - Ant Design 5.x - Switch, Button, Slider, InputNumber, Tabs, Table, Tag, message ç»„ä»¶
  - dayjs - æ—¥æœŸæ—¶é—´å¤„ç†
  - useWebSocket Hook - WebSocketè¿æ¥ç®¡ç†ï¼ˆéœ€æ‰©å±•æ”¯æŒæ§åˆ¶ACKæ¶ˆæ¯ï¼‰
  - **æœ¬Storyéœ€è¦æ–°å¢ä¾èµ–ï¼š** æ— éœ€æ–°å¢ä¾èµ–ï¼ˆæ‰€æœ‰ç»„ä»¶å’Œå·¥å…·å·²å…·å¤‡ï¼‰
  - [Source: docs/architecture/tech-stack.md]

- **å‰ç«¯é¡µé¢ç»“æ„ï¼š**
  - EndpointDetailPage é¡µé¢å·²å­˜åœ¨ï¼Œå·²å®ç°å®æ—¶ç»Ÿè®¡ã€æ¶ˆæ¯å†å²ã€æ•°æ®å†å²Tab
  - **æœ¬Storyé›†æˆæ–¹å¼ï¼š** åœ¨ EndpointDetailPage ä¸­æ·»åŠ æ–°çš„"è®¾å¤‡æ§åˆ¶"Tabï¼ˆç¬¬4ä¸ªTabï¼‰
  - [Source: packages/frontend/src/pages/EndpointDetailPage.tsx]

### Data Models

#### ControlCommand æ•°æ®æ¨¡å‹ï¼ˆæ–°å¢ï¼‰

**Schema å®šä¹‰ï¼š**
```prisma
model ControlCommand {
  id             String    @id @default(uuid())
  endpoint_id    String    // å¤–é”®ï¼šå…³è”Endpointè¡¨
  device_id      String    // å¤–é”®ï¼šå…³è”Deviceè¡¨
  command_id     String    @unique @db.VarChar(50)  // æŒ‡ä»¤å”¯ä¸€æ ‡è¯†ï¼ˆå‰ç«¯ç”Ÿæˆï¼Œç”¨äºACKåŒ¹é…ï¼‰
  command_type   String    @db.VarChar(100)  // æŒ‡ä»¤ç±»å‹ï¼ˆå¦‚ "setLight", "setTemperature"ï¼‰
  command_params String    @db.Text  // æŒ‡ä»¤å‚æ•°ï¼ˆJSONæ ¼å¼ï¼Œå¦‚ {"state": "on"}ï¼‰
  status         String    @db.VarChar(20)  // æŒ‡ä»¤çŠ¶æ€ï¼špending, success, failed, timeout
  sent_at        DateTime  @default(now())  // å‘é€æ—¶é—´
  ack_at         DateTime? // ACKå“åº”æ—¶é—´
  timeout_at     DateTime? // è¶…æ—¶æ—¶é—´ï¼ˆsent_at + 5ç§’ï¼‰
  error_message  String?   @db.Text  // é”™è¯¯æ¶ˆæ¯ï¼ˆå¤±è´¥æ—¶è®°å½•ï¼‰

  endpoint Endpoint @relation(fields: [endpoint_id], references: [id], onDelete: Cascade)
  device   Device   @relation(fields: [device_id], references: [id], onDelete: Cascade)

  @@index([device_id, sent_at])
  @@index([command_id])
  @@index([status])
  @@map("control_commands")
}
```

**ç´¢å¼•è®¾è®¡ç†ç”±ï¼š**
- `[device_id, sent_at]` å¤åˆç´¢å¼• - ä¼˜åŒ–æŒ‰è®¾å¤‡æŸ¥è¯¢æ§åˆ¶å†å²çš„æ€§èƒ½
- `[command_id]` å•ç´¢å¼• - å¿«é€ŸæŸ¥æ‰¾æŒ‡ä»¤ï¼ˆç”¨äºACKæ¶ˆæ¯åŒ¹é…ï¼‰
- `[status]` å•ç´¢å¼• - æ”¯æŒæŒ‰çŠ¶æ€ç­›é€‰æŒ‡ä»¤ï¼ˆå¦‚æŸ¥è¯¢æ‰€æœ‰å¤±è´¥æŒ‡ä»¤ï¼‰

**å­—æ®µè¯´æ˜ï¼š**
- `command_id`: å‰ç«¯ç”Ÿæˆçš„å”¯ä¸€æ ‡è¯†ç¬¦ï¼ˆä½¿ç”¨nanoidæˆ–uuidï¼‰ï¼Œç”¨äºåŒ¹é…ACKå“åº”
- `status`: æŒ‡ä»¤çŠ¶æ€æµè½¬ï¼špendingï¼ˆå‘é€ä¸­ï¼‰â†’ successï¼ˆæˆåŠŸï¼‰/ failedï¼ˆå¤±è´¥ï¼‰/ timeoutï¼ˆè¶…æ—¶ï¼‰
- `timeout_at`: è¶…æ—¶æ—¶é—´æˆ³ï¼ˆsent_at + 5ç§’ï¼‰ï¼Œç”¨äºåç«¯å®šæ—¶å™¨æ£€æµ‹è¶…æ—¶

[Source: Epic 6 PRD + æœ¬Storyè®¾è®¡]

#### Device æ¨¡å‹æ‰©å±•ï¼ˆå·²å­˜åœ¨ï¼Œéœ€æ·»åŠ å…³è”ï¼‰

```prisma
model Device {
  // ... ç°æœ‰å­—æ®µ
  control_commands ControlCommand[]  // æ–°å¢ï¼šå…³è”çš„æ§åˆ¶æŒ‡ä»¤è®°å½•
}
```

#### Endpoint æ¨¡å‹æ‰©å±•ï¼ˆå·²å­˜åœ¨ï¼Œéœ€æ·»åŠ å…³è”ï¼‰

```prisma
model Endpoint {
  // ... ç°æœ‰å­—æ®µ
  control_commands ControlCommand[]  // æ–°å¢ï¼šå…³è”çš„æ§åˆ¶æŒ‡ä»¤è®°å½•
}
```

### API Specifications

#### è®¾å¤‡æ§åˆ¶APIï¼ˆæ–°å¢ï¼‰

##### POST /api/endpoints/:endpointId/devices/:deviceId/control - å‘é€æ§åˆ¶æŒ‡ä»¤

**Path Parameters:**
- `endpointId`: Endpointçš„æ•°æ®åº“UUID
- `deviceId`: Deviceçš„æ•°æ®åº“UUID

**Request Body:**
```typescript
{
  command: string;  // æŒ‡ä»¤ç±»å‹ï¼ˆå¦‚ "setLight", "setTemperature"ï¼‰
  params: {         // æŒ‡ä»¤å‚æ•°ï¼ˆJSONå¯¹è±¡ï¼‰
    state?: string;       // å¼€å…³çŠ¶æ€ï¼ˆå¦‚ "on", "off"ï¼‰
    temperature?: number; // æ¸©åº¦å€¼
    brightness?: number;  // äº®åº¦å€¼ï¼ˆ0-100ï¼‰
    [key: string]: unknown;
  }
}
```

**Response (200 OK):**
```typescript
{
  commandId: string;  // æŒ‡ä»¤å”¯ä¸€æ ‡è¯†ï¼ˆç”¨äºå‰ç«¯è¿½è¸ªçŠ¶æ€ï¼‰
  status: "pending";  // åˆå§‹çŠ¶æ€
  sentAt: string;     // å‘é€æ—¶é—´ï¼ˆISO 8601æ ¼å¼ï¼‰
  message: "æ§åˆ¶æŒ‡ä»¤å·²å‘é€"
}
```

**Response (400 Bad Request):**
```json
{
  "error": {
    "code": "INVALID_COMMAND",
    "message": "æŒ‡ä»¤æ ¼å¼é”™è¯¯æˆ–å‚æ•°ä¸åˆæ³•"
  }
}
```

**Response (404 Not Found):**
```json
{
  "error": {
    "code": "DEVICE_NOT_FOUND",
    "message": "è®¾å¤‡ä¸å­˜åœ¨æˆ–ä¸å±äºè¯¥ç«¯ç‚¹"
  }
}
```

**Response (503 Service Unavailable):**
```json
{
  "error": {
    "code": "DEVICE_OFFLINE",
    "message": "è®¾å¤‡ç¦»çº¿ï¼Œæ— æ³•å‘é€æ§åˆ¶æŒ‡ä»¤"
  }
}
```

**ä¸šåŠ¡é€»è¾‘ï¼š**
1. éªŒè¯ç”¨æˆ·æƒé™ï¼ˆendpoint æ˜¯å¦å±äºå½“å‰ç”¨æˆ·ï¼‰
2. éªŒè¯è®¾å¤‡å­˜åœ¨ä¸”å±äºè¯¥ç«¯ç‚¹
3. æ£€æŸ¥è®¾å¤‡æ˜¯å¦åœ¨çº¿ï¼ˆæŸ¥æ‰¾ ConnectionManager ä¸­æ˜¯å¦æœ‰è¯¥è®¾å¤‡çš„è¿æ¥ï¼‰
4. ç”Ÿæˆ commandIdï¼ˆä½¿ç”¨nanoidï¼‰
5. åˆ›å»º ControlCommand è®°å½•ï¼ˆstatus: pendingï¼‰
6. æ„é€ æ§åˆ¶æ¶ˆæ¯ï¼š`{ type: "control", commandId, deviceId, command, params, timestamp }`
7. é€šè¿‡ WebSocket å‘é€æ¶ˆæ¯åˆ°ç›®æ ‡è®¾å¤‡ï¼ˆä½¿ç”¨ `sendToDevice()` å‡½æ•°ï¼‰
8. å¯åŠ¨è¶…æ—¶å®šæ—¶å™¨ï¼ˆ5ç§’åæ£€æŸ¥æ˜¯å¦æ”¶åˆ°ACKï¼‰
9. è¿”å› commandId å’Œ pending çŠ¶æ€

[Source: Epic 6 PRD + æœ¬Storyè®¾è®¡]

##### GET /api/endpoints/:endpointId/devices/:deviceId/control/history - è·å–æ§åˆ¶æŒ‡ä»¤å†å²

**Path Parameters:**
- `endpointId`: Endpointçš„æ•°æ®åº“UUID
- `deviceId`: Deviceçš„æ•°æ®åº“UUID

**Query Parameters:**
- `page`: é¡µç ï¼ˆå¯é€‰ï¼Œé»˜è®¤1ï¼‰
- `pageSize`: æ¯é¡µæ¡æ•°ï¼ˆå¯é€‰ï¼Œé»˜è®¤20ï¼‰
- `status`: çŠ¶æ€ç­›é€‰ï¼ˆå¯é€‰ï¼špending, success, failed, timeoutï¼‰

**Response (200 OK):**
```typescript
{
  deviceId: string;
  deviceName: string;
  commands: [
    {
      commandId: string;
      commandType: string;
      commandParams: object;
      status: "pending" | "success" | "failed" | "timeout";
      sentAt: string;
      ackAt: string | null;
      timeoutAt: string | null;
      errorMessage: string | null;
      duration: number | null;  // å“åº”è€—æ—¶ï¼ˆæ¯«ç§’ï¼‰
    }
  ],
  pagination: {
    total: number;
    page: number;
    pageSize: number;
    totalPages: number;
  }
}
```

**ä¸šåŠ¡é€»è¾‘ï¼š**
1. éªŒè¯ç”¨æˆ·æƒé™ï¼ˆendpoint æ˜¯å¦å±äºå½“å‰ç”¨æˆ·ï¼‰
2. éªŒè¯è®¾å¤‡å­˜åœ¨ä¸”å±äºè¯¥ç«¯ç‚¹
3. æŸ¥è¯¢ ControlCommand è¡¨ï¼ˆæŒ‰ sent_at é™åºæ’åˆ—ï¼‰
4. æ”¯æŒçŠ¶æ€ç­›é€‰å’Œåˆ†é¡µ
5. è®¡ç®—å“åº”è€—æ—¶ï¼ˆduration = ackAt - sentAtï¼Œå•ä½æ¯«ç§’ï¼‰
6. è¿”å›æ§åˆ¶æŒ‡ä»¤å†å²åˆ—è¡¨

[Source: Epic 6 PRD + æœ¬Storyè®¾è®¡]

##### GET /api/endpoints/:endpointId/devices/:deviceId/control/:commandId - è·å–æŒ‡ä»¤è¯¦æƒ…

**Path Parameters:**
- `endpointId`: Endpointçš„æ•°æ®åº“UUID
- `deviceId`: Deviceçš„æ•°æ®åº“UUID
- `commandId`: æŒ‡ä»¤å”¯ä¸€æ ‡è¯†

**Response (200 OK):**
```typescript
{
  commandId: string;
  deviceId: string;
  deviceName: string;
  commandType: string;
  commandParams: object;
  status: "pending" | "success" | "failed" | "timeout";
  sentAt: string;
  ackAt: string | null;
  timeoutAt: string | null;
  errorMessage: string | null;
  duration: number | null;
}
```

**ä¸šåŠ¡é€»è¾‘ï¼š**
1. éªŒè¯ç”¨æˆ·æƒé™ï¼ˆendpoint æ˜¯å¦å±äºå½“å‰ç”¨æˆ·ï¼‰
2. æ ¹æ® commandId æŸ¥è¯¢ ControlCommand è®°å½•
3. éªŒè¯æŒ‡ä»¤å±äºæŒ‡å®šè®¾å¤‡å’Œç«¯ç‚¹
4. è¿”å›æŒ‡ä»¤è¯¦æƒ…

[Source: Epic 6 PRD + æœ¬Storyè®¾è®¡]

### Component Specifications

#### å‰ç«¯ç»„ä»¶

##### DeviceControlTab.tsxï¼ˆæ–°å¢ï¼‰

**æ–‡ä»¶è·¯å¾„ï¼š** `packages/frontend/src/components/endpoints/DeviceControlTab.tsx`

**èŒè´£ï¼š** è®¾å¤‡æ§åˆ¶é¡µé¢çš„ä¸»å®¹å™¨ç»„ä»¶ï¼ŒåŒ…å«è®¾å¤‡é€‰æ‹©å™¨ã€æ§åˆ¶é¢æ¿ã€æ§åˆ¶å†å²è¡¨æ ¼

**ç»„ä»¶ç»“æ„ï¼š**
```typescript
interface DeviceControlTabProps {
  endpointId: string;  // å½“å‰ç«¯ç‚¹ID
}

function DeviceControlTab({ endpointId }: DeviceControlTabProps) {
  // çŠ¶æ€ç®¡ç†
  const [devices, setDevices] = useState<Device[]>([]);  // å¯ç”¨è®¾å¤‡åˆ—è¡¨
  const [selectedDevice, setSelectedDevice] = useState<string | null>(null);  // é€‰ä¸­çš„è®¾å¤‡ID
  const [deviceOnline, setDeviceOnline] = useState<boolean>(false);  // è®¾å¤‡æ˜¯å¦åœ¨çº¿
  const [loading, setLoading] = useState(false);
  const [commandHistory, setCommandHistory] = useState<ControlCommand[]>([]);

  // åŠ è½½è®¾å¤‡åˆ—è¡¨ï¼ˆç»„ä»¶æŒ‚è½½æ—¶ï¼‰
  useEffect(() => {
    loadDevices();
  }, [endpointId]);

  // è®¾å¤‡å˜åŒ–æ—¶æ£€æŸ¥åœ¨çº¿çŠ¶æ€
  useEffect(() => {
    if (selectedDevice) {
      checkDeviceOnlineStatus(selectedDevice);
      loadCommandHistory(selectedDevice);
    }
  }, [selectedDevice]);

  // å‘é€æ§åˆ¶æŒ‡ä»¤
  const sendControlCommand = async (command: string, params: object) => {
    setLoading(true);
    try {
      const response = await controlService.sendCommand(
        endpointId,
        selectedDevice!,
        command,
        params
      );
      message.success('æ§åˆ¶æŒ‡ä»¤å·²å‘é€');
      // åˆ·æ–°æ§åˆ¶å†å²
      loadCommandHistory(selectedDevice!);
      return response.commandId;
    } catch (error) {
      if (error.code === 'DEVICE_OFFLINE') {
        message.error('è®¾å¤‡ç¦»çº¿ï¼Œæ— æ³•å‘é€æ§åˆ¶æŒ‡ä»¤');
      } else {
        message.error('æ§åˆ¶æŒ‡ä»¤å‘é€å¤±è´¥ï¼Œè¯·é‡è¯•');
      }
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="device-control-tab">
      {/* è®¾å¤‡é€‰æ‹©å™¨ */}
      <Form layout="inline">
        <Form.Item label="ç›®æ ‡è®¾å¤‡" required>
          <Select
            value={selectedDevice}
            onChange={setSelectedDevice}
            placeholder="é€‰æ‹©è¦æ§åˆ¶çš„è®¾å¤‡"
            style={{ width: 250 }}
            showSearch
          >
            {devices.map(d => (
              <Option key={d.id} value={d.id}>
                {d.custom_name || d.device_id}
                <Tag color={isDeviceOnline(d) ? 'green' : 'red'} style={{ marginLeft: 8 }}>
                  {isDeviceOnline(d) ? 'åœ¨çº¿' : 'ç¦»çº¿'}
                </Tag>
              </Option>
            ))}
          </Select>
        </Form.Item>
      </Form>

      {/* è®¾å¤‡ç¦»çº¿è­¦å‘Š */}
      {selectedDevice && !deviceOnline && (
        <Alert
          message="è®¾å¤‡ç¦»çº¿"
          description="å½“å‰è®¾å¤‡ç¦»çº¿ï¼Œæ— æ³•å‘é€æ§åˆ¶æŒ‡ä»¤ã€‚è¯·ç¡®ä¿è®¾å¤‡å·²è¿æ¥åˆ°WebSocketæœåŠ¡å™¨ã€‚"
          type="warning"
          showIcon
          style={{ marginTop: 16 }}
        />
      )}

      {/* æ§åˆ¶é¢æ¿ */}
      {selectedDevice && deviceOnline && (
        <Card title="æ§åˆ¶é¢æ¿" style={{ marginTop: 16 }}>
          <ControlPanel
            deviceId={selectedDevice}
            onSendCommand={sendControlCommand}
            loading={loading}
          />
        </Card>
      )}

      {/* æ§åˆ¶å†å²è¡¨æ ¼ */}
      {selectedDevice && (
        <Card title="æ§åˆ¶å†å²" style={{ marginTop: 16 }}>
          <ControlHistoryTable
            commands={commandHistory}
            loading={loading}
            onRefresh={() => loadCommandHistory(selectedDevice)}
          />
        </Card>
      )}

      {/* ç©ºçŠ¶æ€æç¤º */}
      {!selectedDevice && (
        <Empty
          description="è¯·é€‰æ‹©è¦æ§åˆ¶çš„è®¾å¤‡"
          style={{ marginTop: 48 }}
        />
      )}
    </div>
  );
}
```

[Source: docs/architecture/frontend-architecture.md#Component Organization + æœ¬Storyè®¾è®¡]

##### ControlPanel.tsxï¼ˆæ–°å¢ï¼‰

**æ–‡ä»¶è·¯å¾„ï¼š** `packages/frontend/src/components/endpoints/ControlPanel.tsx`

**èŒè´£ï¼š** è®¾å¤‡æ§åˆ¶é¢æ¿ï¼ŒåŒ…å«å„ç§æ§åˆ¶ç»„ä»¶ï¼ˆå¼€å…³ã€æŒ‰é’®ã€æ»‘å—ã€æ•°å€¼è¾“å…¥ï¼‰

**ç»„ä»¶ç»“æ„ï¼š**
```typescript
interface ControlPanelProps {
  deviceId: string;
  onSendCommand: (command: string, params: object) => Promise<string>;
  loading: boolean;
}

function ControlPanel({ deviceId, onSendCommand, loading }: ControlPanelProps) {
  const [lightState, setLightState] = useState<boolean>(false);
  const [temperature, setTemperature] = useState<number>(25);
  const [brightness, setBrightness] = useState<number>(50);

  // å¼€å…³ç¯æ§åˆ¶
  const handleLightSwitch = async (checked: boolean) => {
    setLightState(checked);
    await onSendCommand('setLight', { state: checked ? 'on' : 'off' });
  };

  // æ¸©åº¦è®¾ç½®
  const handleTemperatureChange = async (value: number) => {
    setTemperature(value);
    await onSendCommand('setTemperature', { temperature: value });
  };

  // äº®åº¦è°ƒèŠ‚
  const handleBrightnessChange = async (value: number) => {
    setBrightness(value);
    await onSendCommand('setBrightness', { brightness: value });
  };

  return (
    <Space direction="vertical" size="large" style={{ width: '100%' }}>
      {/* å¼€å…³æ§åˆ¶ */}
      <div>
        <Text strong>ç¯å…‰æ§åˆ¶</Text>
        <div style={{ marginTop: 8 }}>
          <Switch
            checked={lightState}
            onChange={handleLightSwitch}
            checkedChildren="å¼€"
            unCheckedChildren="å…³"
            loading={loading}
          />
          <Text type="secondary" style={{ marginLeft: 16 }}>
            {lightState ? 'å·²å¼€å¯' : 'å·²å…³é—­'}
          </Text>
        </div>
      </div>

      {/* æ¸©åº¦è®¾ç½® */}
      <div>
        <Text strong>æ¸©åº¦è®¾ç½®ï¼ˆÂ°Cï¼‰</Text>
        <div style={{ marginTop: 8, display: 'flex', alignItems: 'center', gap: 16 }}>
          <InputNumber
            value={temperature}
            onChange={(value) => value !== null && handleTemperatureChange(value)}
            min={0}
            max={100}
            disabled={loading}
            style={{ width: 120 }}
          />
          <Button
            type="primary"
            onClick={() => handleTemperatureChange(temperature)}
            loading={loading}
          >
            è®¾ç½®
          </Button>
        </div>
      </div>

      {/* äº®åº¦è°ƒèŠ‚ */}
      <div>
        <Text strong>äº®åº¦è°ƒèŠ‚ï¼ˆ{brightness}%ï¼‰</Text>
        <div style={{ marginTop: 8 }}>
          <Slider
            value={brightness}
            onChange={setBrightness}
            onAfterChange={handleBrightnessChange}
            disabled={loading}
            min={0}
            max={100}
          />
        </div>
      </div>

      {/* å¿«æ·æ“ä½œæŒ‰é’® */}
      <div>
        <Text strong>å¿«æ·æ“ä½œ</Text>
        <div style={{ marginTop: 8 }}>
          <Space>
            <Button
              onClick={() => onSendCommand('restart', {})}
              loading={loading}
            >
              é‡å¯è®¾å¤‡
            </Button>
            <Button
              onClick={() => onSendCommand('reset', {})}
              danger
              loading={loading}
            >
              æ¢å¤å‡ºå‚è®¾ç½®
            </Button>
          </Space>
        </div>
      </div>
    </Space>
  );
}
```

[Source: docs/architecture/frontend-architecture.md#Component Organization + Ant Designæ–‡æ¡£]

##### ControlHistoryTable.tsxï¼ˆæ–°å¢ï¼‰

**æ–‡ä»¶è·¯å¾„ï¼š** `packages/frontend/src/components/endpoints/ControlHistoryTable.tsx`

**èŒè´£ï¼š** å±•ç¤ºæ§åˆ¶æŒ‡ä»¤å†å²è¡¨æ ¼ï¼Œæ”¯æŒçŠ¶æ€æ ‡ç­¾ã€æ’åºå’Œåˆ†é¡µ

**ç»„ä»¶ç»“æ„ï¼š**
```typescript
interface ControlHistoryTableProps {
  commands: ControlCommand[];
  loading: boolean;
  onRefresh: () => void;
}

function ControlHistoryTable({ commands, loading, onRefresh }: ControlHistoryTableProps) {
  const columns: ColumnsType<ControlCommand> = [
    {
      title: 'æ—¶é—´',
      dataIndex: 'sentAt',
      key: 'sentAt',
      sorter: (a, b) => new Date(a.sentAt).getTime() - new Date(b.sentAt).getTime(),
      defaultSortOrder: 'descend',
      render: (sentAt: string) => dayjs(sentAt).format('YYYY-MM-DD HH:mm:ss')
    },
    {
      title: 'æŒ‡ä»¤ç±»å‹',
      dataIndex: 'commandType',
      key: 'commandType'
    },
    {
      title: 'å‚æ•°',
      dataIndex: 'commandParams',
      key: 'commandParams',
      render: (params: object) => (
        <Text code>{JSON.stringify(params)}</Text>
      )
    },
    {
      title: 'çŠ¶æ€',
      dataIndex: 'status',
      key: 'status',
      filters: [
        { text: 'ç­‰å¾…ä¸­', value: 'pending' },
        { text: 'æˆåŠŸ', value: 'success' },
        { text: 'å¤±è´¥', value: 'failed' },
        { text: 'è¶…æ—¶', value: 'timeout' }
      ],
      onFilter: (value, record) => record.status === value,
      render: (status: string) => {
        const colorMap = {
          pending: 'blue',
          success: 'green',
          failed: 'red',
          timeout: 'default'
        };
        const textMap = {
          pending: 'ç­‰å¾…ä¸­',
          success: 'æˆåŠŸ',
          failed: 'å¤±è´¥',
          timeout: 'è¶…æ—¶'
        };
        return <Tag color={colorMap[status]}>{textMap[status]}</Tag>;
      }
    },
    {
      title: 'å“åº”æ—¶é—´ï¼ˆmsï¼‰',
      dataIndex: 'duration',
      key: 'duration',
      render: (duration: number | null) => duration !== null ? `${duration} ms` : '-'
    },
    {
      title: 'é”™è¯¯æ¶ˆæ¯',
      dataIndex: 'errorMessage',
      key: 'errorMessage',
      render: (errorMessage: string | null) => errorMessage || '-'
    }
  ];

  return (
    <>
      <div style={{ marginBottom: 16 }}>
        <Button
          icon={<ReloadOutlined />}
          onClick={onRefresh}
          loading={loading}
        >
          åˆ·æ–°
        </Button>
      </div>
      <Table
        columns={columns}
        dataSource={commands}
        loading={loading}
        pagination={{
          pageSize: 20,
          pageSizeOptions: ['10', '20', '50'],
          showSizeChanger: true,
          showTotal: (total) => `å…± ${total} æ¡è®°å½•`
        }}
        rowKey="commandId"
        size="small"
        scroll={{ x: true }}
      />
    </>
  );
}
```

[Source: docs/architecture/frontend-architecture.md#Component Organization + Ant Design Tableæ–‡æ¡£]

### WebSocket Protocol Specifications

#### æ§åˆ¶æŒ‡ä»¤æ¶ˆæ¯æ ¼å¼ï¼ˆå®¢æˆ·ç«¯ â† æœåŠ¡å™¨ï¼‰

**å‘é€åˆ°è®¾å¤‡çš„æ§åˆ¶æ¶ˆæ¯ï¼š**
```json
{
  "type": "control",
  "commandId": "abc123xyz",
  "deviceId": "micu",
  "command": "setLight",
  "params": {
    "state": "on"
  },
  "timestamp": 1698765432000
}
```

**å­—æ®µè¯´æ˜ï¼š**
- `type`: æ¶ˆæ¯ç±»å‹ï¼Œå›ºå®šä¸º "control"
- `commandId`: æŒ‡ä»¤å”¯ä¸€æ ‡è¯†ç¬¦ï¼ˆç”¨äºACKåŒ¹é…ï¼‰
- `deviceId`: ç›®æ ‡è®¾å¤‡çš„æ ‡è¯†ç¬¦ï¼ˆDeviceè¡¨çš„device_idå­—æ®µï¼‰
- `command`: æŒ‡ä»¤ç±»å‹ï¼ˆå¦‚ "setLight", "setTemperature"ï¼‰
- `params`: æŒ‡ä»¤å‚æ•°ï¼ˆJSONå¯¹è±¡ï¼‰
- `timestamp`: å‘é€æ—¶é—´æˆ³ï¼ˆæ¯«ç§’ï¼‰

[Source: Epic 6 PRD]

#### æ§åˆ¶ACKå“åº”æ¶ˆæ¯æ ¼å¼ï¼ˆè®¾å¤‡ â†’ æœåŠ¡å™¨ï¼‰

**è®¾å¤‡å“åº”çš„ACKæ¶ˆæ¯ï¼š**
```json
{
  "type": "control_ack",
  "commandId": "abc123xyz",
  "status": "success",
  "message": "ç¯å…‰å·²å¼€å¯"
}
```

**å­—æ®µè¯´æ˜ï¼š**
- `type`: æ¶ˆæ¯ç±»å‹ï¼Œå›ºå®šä¸º "control_ack"
- `commandId`: å¯¹åº”çš„æ§åˆ¶æŒ‡ä»¤IDï¼ˆç”¨äºåŒ¹é…ï¼‰
- `status`: æ‰§è¡ŒçŠ¶æ€ï¼ˆ"success" æˆ– "failed"ï¼‰
- `message`: å“åº”æ¶ˆæ¯ï¼ˆå¯é€‰ï¼Œæè¿°æ‰§è¡Œç»“æœï¼‰

**ACKå¤„ç†é€»è¾‘ï¼ˆåç«¯ï¼‰ï¼š**
1. åœ¨ WebSocket server çš„ message äº‹ä»¶ä¸­æ£€æµ‹ `type === 'control_ack'`
2. æ ¹æ® commandId æŸ¥è¯¢ ControlCommand è®°å½•
3. æ›´æ–°è®°å½•çŠ¶æ€ï¼šstatus = success/failed, ack_at = å½“å‰æ—¶é—´
4. æ¸…é™¤å¯¹åº”çš„è¶…æ—¶å®šæ—¶å™¨
5. ï¼ˆå¯é€‰ï¼‰é€šè¿‡ WebSocket å°†çŠ¶æ€æ›´æ–°æ¨é€ç»™å‰ç«¯

[Source: Epic 6 PRD]

### File Locations

æ ¹æ®é¡¹ç›®ç»“æ„ï¼Œæ–°æ–‡ä»¶åº”åˆ›å»ºåœ¨ä»¥ä¸‹ä½ç½®ï¼š

**åç«¯æ–°å¢æ–‡ä»¶ï¼š**
```
packages/backend/src/
â”œâ”€â”€ services/
â”‚   â””â”€â”€ control-command.service.ts  # æ–°å¢ï¼šæ§åˆ¶æŒ‡ä»¤æœåŠ¡å±‚
â”œâ”€â”€ controllers/
â”‚   â””â”€â”€ control.controller.ts       # æ–°å¢ï¼šæ§åˆ¶æŒ‡ä»¤æ§åˆ¶å™¨
â”œâ”€â”€ routes/
â”‚   â””â”€â”€ control.routes.ts           # æ–°å¢ï¼šæ§åˆ¶æŒ‡ä»¤è·¯ç”±
â””â”€â”€ tests/
    â”œâ”€â”€ unit/
    â”‚   â””â”€â”€ services/
    â”‚       â””â”€â”€ control-command.service.test.ts  # æ–°å¢ï¼šå•å…ƒæµ‹è¯•
    â””â”€â”€ integration/
        â””â”€â”€ control-command.api.test.ts  # æ–°å¢ï¼šé›†æˆæµ‹è¯•
```

**åç«¯ä¿®æ”¹æ–‡ä»¶ï¼š**
```
packages/backend/src/
â”œâ”€â”€ websocket/
â”‚   â”œâ”€â”€ connection-manager.ts       # ä¿®æ”¹ï¼šæ·»åŠ  getDeviceConnection() æ–¹æ³•
â”‚   â”œâ”€â”€ message-router.ts           # ä¿®æ”¹ï¼šæ·»åŠ  sendToDevice() å‡½æ•°å’Œæ§åˆ¶æ¶ˆæ¯å¤„ç†é€»è¾‘
â”‚   â””â”€â”€ server.ts                   # ä¿®æ”¹ï¼šæ·»åŠ æ§åˆ¶ACKæ¶ˆæ¯å¤„ç†é€»è¾‘
â”œâ”€â”€ prisma/
â”‚   â””â”€â”€ schema.prisma               # ä¿®æ”¹ï¼šæ·»åŠ  ControlCommand æ¨¡å‹
â””â”€â”€ app.ts                          # ä¿®æ”¹ï¼šæ³¨å†Œæ§åˆ¶æŒ‡ä»¤è·¯ç”±
```

**å‰ç«¯æ–°å¢æ–‡ä»¶ï¼š**
```
packages/frontend/src/
â”œâ”€â”€ components/
â”‚   â””â”€â”€ endpoints/
â”‚       â”œâ”€â”€ DeviceControlTab.tsx         # æ–°å¢ï¼šè®¾å¤‡æ§åˆ¶Tabç»„ä»¶
â”‚       â”œâ”€â”€ ControlPanel.tsx             # æ–°å¢ï¼šæ§åˆ¶é¢æ¿ç»„ä»¶
â”‚       â””â”€â”€ ControlHistoryTable.tsx      # æ–°å¢ï¼šæ§åˆ¶å†å²è¡¨æ ¼ç»„ä»¶
â””â”€â”€ services/
    â””â”€â”€ control.service.ts               # æ–°å¢ï¼šæ§åˆ¶æŒ‡ä»¤APIæœåŠ¡
```

**å‰ç«¯ä¿®æ”¹æ–‡ä»¶ï¼š**
```
packages/frontend/src/
â”œâ”€â”€ pages/
â”‚   â””â”€â”€ EndpointDetailPage.tsx           # ä¿®æ”¹ï¼šæ·»åŠ "è®¾å¤‡æ§åˆ¶"Tab
â””â”€â”€ hooks/
    â””â”€â”€ useWebSocket.ts                  # ä¿®æ”¹ï¼šæ·»åŠ æ§åˆ¶ACKæ¶ˆæ¯ç›‘å¬é€»è¾‘
```

[Source: docs/architecture/unified-project-structure.md]

### Testing Requirements

#### æµ‹è¯•ç­–ç•¥

æ ¹æ®é¡¹ç›®çš„æµ‹è¯•ç­–ç•¥ï¼Œæœ¬Storyéœ€è¦ç¼–å†™ä»¥ä¸‹æµ‹è¯•ï¼š

**åç«¯æµ‹è¯•ï¼ˆå¿…é¡»ï¼‰ï¼š**

1. **å•å…ƒæµ‹è¯• - control-command.service.ts**
   - æµ‹è¯•æ–‡ä»¶ï¼š`packages/backend/tests/unit/services/control-command.service.test.ts`
   - æµ‹è¯•ç”¨ä¾‹ï¼š
     - `sendControlCommand()` æ­£ç¡®åˆ›å»º ControlCommand è®°å½•ï¼ˆstatus: pendingï¼‰
     - `sendControlCommand()` æ­£ç¡®å‘é€ WebSocket æ§åˆ¶æ¶ˆæ¯
     - `sendControlCommand()` æ­£ç¡®å¯åŠ¨è¶…æ—¶å®šæ—¶å™¨ï¼ˆ5ç§’ï¼‰
     - `updateCommandStatus()` æ­£ç¡®æ›´æ–°æŒ‡ä»¤çŠ¶æ€ï¼ˆsuccess/failed/timeoutï¼‰
     - `updateCommandStatus()` æ­£ç¡®è®°å½• ack_at æ—¶é—´
     - `getCommandHistory()` æ­£ç¡®æŸ¥è¯¢è®¾å¤‡çš„æ§åˆ¶å†å²ï¼ˆåˆ†é¡µã€ç­›é€‰ï¼‰
     - è¶…æ—¶æ£€æµ‹æœºåˆ¶ï¼š5ç§’åæœªæ”¶åˆ°ACKï¼ŒçŠ¶æ€è‡ªåŠ¨æ›´æ–°ä¸º timeout
     - è®¾å¤‡ç¦»çº¿æ—¶æŠ›å‡º DEVICE_OFFLINE é”™è¯¯

2. **å•å…ƒæµ‹è¯• - message-router.ts æ‰©å±•**
   - æµ‹è¯•æ–‡ä»¶ï¼š`packages/backend/tests/unit/message-router.test.ts`
   - æµ‹è¯•ç”¨ä¾‹ï¼š
     - `sendToDevice()` æ­£ç¡®æŸ¥æ‰¾ç›®æ ‡è®¾å¤‡çš„ WebSocket è¿æ¥
     - `sendToDevice()` æ­£ç¡®å‘é€æ§åˆ¶æ¶ˆæ¯ï¼ˆä»…å‘é€åˆ°ç›®æ ‡è®¾å¤‡ï¼Œä¸å¹¿æ’­ï¼‰
     - æ§åˆ¶æ¶ˆæ¯æ ¼å¼éªŒè¯ï¼ˆcommandIdã€deviceIdã€command å¿…å¡«ï¼‰
     - è®¾å¤‡ä¸å­˜åœ¨æ—¶è¿”å›é”™è¯¯

3. **é›†æˆæµ‹è¯• - æ§åˆ¶æŒ‡ä»¤API**
   - æµ‹è¯•æ–‡ä»¶ï¼š`packages/backend/tests/integration/control-command.api.test.ts`
   - æµ‹è¯•ç”¨ä¾‹ï¼š
     - `POST /api/endpoints/:id/devices/:deviceId/control` æˆåŠŸå‘é€æ§åˆ¶æŒ‡ä»¤
     - `POST /api/endpoints/:id/devices/:deviceId/control` éªŒè¯æƒé™ï¼ˆç”¨æˆ·åªèƒ½æ§åˆ¶è‡ªå·±çš„ç«¯ç‚¹ï¼‰
     - `POST /api/endpoints/:id/devices/:deviceId/control` è®¾å¤‡ç¦»çº¿è¿”å› 503 é”™è¯¯
     - `POST /api/endpoints/:id/devices/:deviceId/control` å‚æ•°æ ¼å¼éªŒè¯ï¼ˆcommand å¿…å¡«ï¼‰
     - `GET /api/endpoints/:id/devices/:deviceId/control/history` æˆåŠŸè¿”å›æ§åˆ¶å†å²
     - `GET /api/endpoints/:id/devices/:deviceId/control/history` æ”¯æŒçŠ¶æ€ç­›é€‰å’Œåˆ†é¡µ
     - `GET /api/endpoints/:id/devices/:deviceId/control/:commandId` æˆåŠŸè¿”å›æŒ‡ä»¤è¯¦æƒ…

4. **WebSocketæµ‹è¯• - æ§åˆ¶æµç¨‹**
   - æµ‹è¯•æ–‡ä»¶ï¼š`packages/backend/tests/websocket/control-flow.test.ts`
   - æµ‹è¯•ç”¨ä¾‹ï¼š
     - å®Œæ•´æ§åˆ¶æµç¨‹ï¼šå‘é€æ§åˆ¶æ¶ˆæ¯ â†’ è®¾å¤‡æ”¶åˆ° â†’ è®¾å¤‡å‘é€ACK â†’ çŠ¶æ€æ›´æ–°
     - ACKæ¶ˆæ¯åŒ¹é…ï¼šæ ¹æ® commandId æ­£ç¡®åŒ¹é…æ§åˆ¶æŒ‡ä»¤
     - è¶…æ—¶æ£€æµ‹ï¼š5ç§’å†…æœªæ”¶åˆ°ACKï¼ŒçŠ¶æ€è‡ªåŠ¨æ›´æ–°ä¸º timeout
     - ç‚¹å¯¹ç‚¹è·¯ç”±ï¼šæ§åˆ¶æ¶ˆæ¯ä»…å‘é€åˆ°ç›®æ ‡è®¾å¤‡ï¼Œå…¶ä»–è®¾å¤‡ä¸æ”¶åˆ°

**å‰ç«¯æµ‹è¯•ï¼ˆæ‰‹åŠ¨æµ‹è¯•ï¼‰ï¼š**

5. **è®¾å¤‡æ§åˆ¶åŠŸèƒ½æµ‹è¯•**
   - æµ‹è¯•ç”¨ä¾‹ï¼š
     - è®¿é—®ç«¯ç‚¹è¯¦æƒ…é¡µï¼Œåˆ‡æ¢åˆ°"è®¾å¤‡æ§åˆ¶"TabæˆåŠŸ
     - è®¾å¤‡é€‰æ‹©å™¨æ­£å¸¸å·¥ä½œï¼Œæ˜¾ç¤ºè®¾å¤‡åœ¨çº¿/ç¦»çº¿çŠ¶æ€
     - è®¾å¤‡ç¦»çº¿æ—¶æ˜¾ç¤ºè­¦å‘Šæç¤ºï¼Œç¦ç”¨æ§åˆ¶é¢æ¿
     - è®¾å¤‡åœ¨çº¿æ—¶ï¼Œæ§åˆ¶é¢æ¿æ‰€æœ‰ç»„ä»¶æ­£å¸¸å·¥ä½œï¼ˆå¼€å…³ã€æ»‘å—ã€æŒ‰é’®ï¼‰
     - ç‚¹å‡»æ§åˆ¶æŒ‰é’®åï¼ŒæŒ‡ä»¤æˆåŠŸå‘é€ï¼Œæ˜¾ç¤ºToastæç¤º
     - æ§åˆ¶å†å²è¡¨æ ¼æ­£ç¡®å±•ç¤ºæŒ‡ä»¤è®°å½•ï¼ˆæ—¶é—´ã€ç±»å‹ã€å‚æ•°ã€çŠ¶æ€ï¼‰
     - çŠ¶æ€æ ‡ç­¾é¢œè‰²æ­£ç¡®ï¼ˆpending-è“è‰²ã€success-ç»¿è‰²ã€failed-çº¢è‰²ã€timeout-ç°è‰²ï¼‰
     - è¡¨æ ¼æ”¯æŒæ’åºã€ç­›é€‰ã€åˆ†é¡µ

6. **WebSocketå®æ—¶çŠ¶æ€æ›´æ–°æµ‹è¯•**
   - æµ‹è¯•ç”¨ä¾‹ï¼š
     - å‘é€æ§åˆ¶æŒ‡ä»¤åï¼ŒçŠ¶æ€åˆå§‹ä¸º pendingï¼ˆè“è‰²æ ‡ç­¾ï¼‰
     - è®¾å¤‡å“åº”ACKåï¼ŒçŠ¶æ€è‡ªåŠ¨æ›´æ–°ä¸º successï¼ˆç»¿è‰²æ ‡ç­¾ï¼‰
     - 5ç§’å†…æœªæ”¶åˆ°ACKï¼ŒçŠ¶æ€è‡ªåŠ¨æ›´æ–°ä¸º timeoutï¼ˆç°è‰²æ ‡ç­¾ï¼‰
     - æ§åˆ¶å†å²è¡¨æ ¼è‡ªåŠ¨åˆ·æ–°ï¼Œæ˜¾ç¤ºæœ€æ–°çŠ¶æ€
     - Toastæç¤ºæ˜¾ç¤ºæ§åˆ¶æˆåŠŸ/å¤±è´¥æ¶ˆæ¯

**ç«¯åˆ°ç«¯æµ‹è¯•ï¼ˆæ‰‹åŠ¨ï¼‰ï¼š**

7. **å®Œæ•´ç”¨æˆ·æ“ä½œæµç¨‹æµ‹è¯•**
   - æµ‹è¯•æµç¨‹ï¼š
     1. ç™»å½•ç³»ç»Ÿ
     2. è®¿é—®ç«¯ç‚¹è¯¦æƒ…é¡µ
     3. åˆ‡æ¢åˆ°"è®¾å¤‡æ§åˆ¶"Tab
     4. é€‰æ‹©åœ¨çº¿è®¾å¤‡
     5. æ‰“å¼€ç¯å…‰å¼€å…³ï¼ˆSwitchç»„ä»¶ï¼‰
     6. éªŒè¯æ§åˆ¶æŒ‡ä»¤å‘é€æˆåŠŸï¼ˆToastæç¤ºï¼‰
     7. éªŒè¯æ§åˆ¶å†å²è¡¨æ ¼æ˜¾ç¤ºæ–°æŒ‡ä»¤ï¼ˆstatus: pendingï¼‰
     8. è®¾å¤‡å“åº”ACKï¼ˆæ‰‹åŠ¨æ¨¡æ‹Ÿæˆ–çœŸå®è®¾å¤‡ï¼‰
     9. éªŒè¯çŠ¶æ€è‡ªåŠ¨æ›´æ–°ä¸º success
     10. è°ƒèŠ‚æ¸©åº¦æ»‘å—ï¼ˆSliderç»„ä»¶ï¼‰
     11. éªŒè¯æ§åˆ¶æŒ‡ä»¤å‘é€æˆåŠŸ
     12. éªŒè¯æ§åˆ¶å†å²è¡¨æ ¼æ›´æ–°
     13. æµ‹è¯•è¶…æ—¶æƒ…å†µï¼ˆè®¾å¤‡ä¸å“åº”ACKï¼‰
     14. éªŒè¯5ç§’åçŠ¶æ€è‡ªåŠ¨æ›´æ–°ä¸º timeout
     15. æµ‹è¯•è®¾å¤‡ç¦»çº¿æƒ…å†µ
     16. éªŒè¯æ˜¾ç¤ºè®¾å¤‡ç¦»çº¿è­¦å‘Šï¼Œç¦ç”¨æ§åˆ¶é¢æ¿
     17. ç‚¹å‡»åˆ·æ–°æŒ‰é’®ï¼ŒéªŒè¯æ§åˆ¶å†å²è¡¨æ ¼åˆ·æ–°
     18. æµ‹è¯•è¡¨æ ¼æ’åºã€ç­›é€‰ã€åˆ†é¡µåŠŸèƒ½

[Source: docs/architecture/testing-strategy.md]

#### æµ‹è¯•å·¥å…·å’Œæ¡†æ¶

- **åç«¯å•å…ƒ/é›†æˆæµ‹è¯•ï¼š** Jest + supertest
- **WebSocketæµ‹è¯•ï¼š** ws å®¢æˆ·ç«¯åº“
- **å‰ç«¯æµ‹è¯•ï¼š** æ‰‹åŠ¨æµ‹è¯•ï¼ˆå¯é€‰ï¼šVitestï¼‰
- **E2Eæµ‹è¯•ï¼š** æ‰‹åŠ¨æµ‹è¯•ï¼ˆæœªæ¥å¯å¼•å…¥Playwrightï¼‰

[Source: docs/architecture/testing-strategy.md#Test Organization]

#### æµ‹è¯•å‘½ä»¤

```bash
# è¿è¡Œæ‰€æœ‰åç«¯æµ‹è¯•
pnpm --filter @websocket-relay/backend test

# è¿è¡Œå•å…ƒæµ‹è¯•
pnpm --filter @websocket-relay/backend test:unit

# è¿è¡Œé›†æˆæµ‹è¯•
pnpm --filter @websocket-relay/backend test:integration
```

[Source: docs/architecture/testing-strategy.md]

#### æµ‹è¯•è¦†ç›–ç‡ç›®æ ‡

- **å•å…ƒæµ‹è¯•è¦†ç›–ç‡ï¼š** > 80%ï¼ˆæ ¸å¿ƒä¸šåŠ¡é€»è¾‘ï¼‰
- **é›†æˆæµ‹è¯•è¦†ç›–ç‡ï¼š** æ‰€æœ‰APIç«¯ç‚¹ï¼ˆæ§åˆ¶æŒ‡ä»¤å‘é€ã€å†å²æŸ¥è¯¢ã€è¯¦æƒ…æŸ¥è¯¢ï¼‰
- **æ€§èƒ½æµ‹è¯•ï¼š** éªŒè¯æŒ‡ä»¤å“åº”å»¶è¿Ÿ < 2ç§’ï¼ŒæˆåŠŸç‡ > 95%

### Technical Constraints

#### æ€§èƒ½çº¦æŸ

1. **æ§åˆ¶æŒ‡ä»¤å“åº”å»¶è¿Ÿï¼š** < 2ç§’ï¼ˆåŒ…å«WebSocketå‘é€ + è®¾å¤‡å¤„ç† + ACKå“åº”ï¼‰
   - **å®ç°æ–¹å¼ï¼š** WebSocketä½å»¶è¿Ÿé€šä¿¡ã€å¼‚æ­¥å¤„ç†ã€è¶…æ—¶æ£€æµ‹ï¼ˆ5ç§’ï¼‰
   - **éªŒè¯æ–¹å¼ï¼š** æ€§èƒ½æµ‹è¯•è„šæœ¬éªŒè¯100æ¡æŒ‡ä»¤çš„å¹³å‡å“åº”æ—¶é—´

2. **æ§åˆ¶æˆåŠŸç‡ï¼š** > 95%ï¼ˆæ’é™¤è®¾å¤‡ç¦»çº¿å’Œç½‘ç»œæ•…éšœæƒ…å†µï¼‰
   - **å®ç°æ–¹å¼ï¼š** å¯é çš„ACKç¡®è®¤æœºåˆ¶ã€è¶…æ—¶é‡è¯•æœºåˆ¶ï¼ˆå¯é€‰ï¼‰
   - **éªŒè¯æ–¹å¼ï¼š** å¯é æ€§æµ‹è¯•éªŒè¯200æ¡æŒ‡ä»¤çš„æˆåŠŸç‡

3. **æŒ‡ä»¤å‘é€é€Ÿç‡é™åˆ¶ï¼š** æ¯è®¾å¤‡æ¯ç§’æœ€å¤š10æ¡æŒ‡ä»¤
   - **å®ç°æ–¹å¼ï¼š** ä½¿ç”¨é€Ÿç‡é™åˆ¶ä¸­é—´ä»¶ï¼ˆå¯é€‰ï¼šRediså®ç°åˆ†å¸ƒå¼é€Ÿç‡é™åˆ¶ï¼‰
   - **éªŒè¯æ–¹å¼ï¼š** å‹åŠ›æµ‹è¯•éªŒè¯é€Ÿç‡é™åˆ¶ç”Ÿæ•ˆ

[Source: Epic 6 PRD + æœ¬Storyè®¾è®¡]

#### WebSocketæ¶ˆæ¯è·¯ç”±æ‰©å±•

**ç‚¹å¯¹ç‚¹è·¯ç”±å®ç°ï¼š**

1. **ExtendedWebSocket æ‰©å±•ï¼ˆå·²å­˜åœ¨ï¼‰ï¼š**
   - å·²åŒ…å« `deviceId`ï¼ˆè®¾å¤‡æ ‡è¯†ç¬¦ï¼‰, `dbDeviceId`ï¼ˆæ•°æ®åº“ä¸»é”®UUIDï¼‰, `customName`ï¼ˆè®¾å¤‡åç§°ï¼‰
   - é€šè¿‡ `socket.deviceId` æ ‡è¯†è®¾å¤‡èº«ä»½

2. **ConnectionManager æ‰©å±•ï¼š**
   - æ–°å¢æ–¹æ³•ï¼š`getDeviceConnection(endpointId: string, deviceId: string): WebSocket | null`
   - å®ç°é€»è¾‘ï¼šéå† endpoint çš„æ‰€æœ‰è¿æ¥ï¼ŒæŸ¥æ‰¾ `socket.deviceId === deviceId` çš„è¿æ¥

3. **sendToDevice() å‡½æ•°ï¼ˆæ–°å¢ï¼‰ï¼š**
   ```typescript
   function sendToDevice(
     endpointId: string,
     deviceId: string,
     message: object
   ): boolean {
     const socket = connectionManager.getDeviceConnection(endpointId, deviceId);
     if (!socket) {
       throw new Error('DEVICE_OFFLINE');
     }
     socket.send(JSON.stringify(message));
     return true;
   }
   ```

4. **æ§åˆ¶ACKæ¶ˆæ¯å¤„ç†ï¼ˆWebSocket serverï¼‰ï¼š**
   - åœ¨ server.ts çš„ message äº‹ä»¶ä¸­æ£€æµ‹ `type === 'control_ack'`
   - è°ƒç”¨ `updateCommandStatus()` æ›´æ–°æŒ‡ä»¤çŠ¶æ€
   - æ¸…é™¤è¶…æ—¶å®šæ—¶å™¨

[Source: packages/backend/src/websocket/message-router.ts + æœ¬Storyè®¾è®¡]

#### è¶…æ—¶æ£€æµ‹æœºåˆ¶

**å®ç°æ–¹å¼ï¼š**

1. **å‘é€æ§åˆ¶æŒ‡ä»¤æ—¶å¯åŠ¨å®šæ—¶å™¨ï¼š**
   ```typescript
   const timeoutTimer = setTimeout(() => {
     // æ£€æŸ¥æŒ‡ä»¤æ˜¯å¦å·²æ”¶åˆ°ACK
     const command = await prisma.controlCommand.findUnique({
       where: { command_id: commandId }
     });
     if (command && command.status === 'pending') {
       // è¶…æ—¶ï¼Œæ›´æ–°çŠ¶æ€
       await updateCommandStatus(commandId, 'timeout', null);
     }
   }, 5000); // 5ç§’è¶…æ—¶
   ```

2. **æ”¶åˆ°ACKæ—¶æ¸…é™¤å®šæ—¶å™¨ï¼š**
   ```typescript
   function handleControlAck(commandId: string, status: string, message: string) {
     // æ¸…é™¤å¯¹åº”çš„è¶…æ—¶å®šæ—¶å™¨
     clearTimeout(timeoutTimers.get(commandId));
     timeoutTimers.delete(commandId);
     // æ›´æ–°æŒ‡ä»¤çŠ¶æ€
     await updateCommandStatus(commandId, status, message);
   }
   ```

3. **å®šæ—¶å™¨å­˜å‚¨ï¼š**
   - ä½¿ç”¨ `Map<commandId, NodeJS.Timeout>` å­˜å‚¨å®šæ—¶å™¨å¼•ç”¨
   - ç¡®ä¿åœ¨æ”¶åˆ°ACKæˆ–æœåŠ¡å™¨é‡å¯æ—¶æ¸…ç†å®šæ—¶å™¨

[Source: Epic 6 PRD + æœ¬Storyè®¾è®¡]

#### è®¾å¤‡åœ¨çº¿çŠ¶æ€æ£€æµ‹

**å®ç°æ–¹å¼ï¼š**

1. **åç«¯æ£€æµ‹ï¼ˆå‘é€æ§åˆ¶æŒ‡ä»¤å‰ï¼‰ï¼š**
   - è°ƒç”¨ `connectionManager.getDeviceConnection(endpointId, deviceId)`
   - å¦‚æœè¿”å› nullï¼ŒæŠ›å‡º DEVICE_OFFLINE é”™è¯¯

2. **å‰ç«¯æ£€æµ‹ï¼ˆUIç¦ç”¨æ§åˆ¶é¢æ¿ï¼‰ï¼š**
   - æ ¹æ®è®¾å¤‡çš„ `last_connected_at` æ—¶é—´åˆ¤æ–­æ˜¯å¦åœ¨çº¿
   - è§„åˆ™ï¼šå¦‚æœ `last_connected_at` åœ¨æœ€è¿‘ 60 ç§’å†…ï¼Œè®¤ä¸ºåœ¨çº¿
   - æ˜¾ç¤ºåœ¨çº¿/ç¦»çº¿æ ‡ç­¾ï¼ˆTagç»„ä»¶ï¼‰

[Source: æœ¬Storyè®¾è®¡]

#### æ§åˆ¶æŒ‡ä»¤åè®®è®¾è®¡åŸåˆ™

1. **æ˜ç¡®çš„æ¶ˆæ¯ç±»å‹æ ‡è¯†ï¼š** `type: "control"` å’Œ `type: "control_ack"`
2. **å”¯ä¸€çš„æŒ‡ä»¤IDï¼š** `commandId`ï¼ˆç”¨äºACKåŒ¹é…ï¼Œå‰ç«¯ç”Ÿæˆnanoidï¼‰
3. **çµæ´»çš„å‚æ•°æ ¼å¼ï¼š** `params` å­—æ®µä¸º JSON å¯¹è±¡ï¼Œæ”¯æŒä»»æ„å‚æ•°
4. **å¯æ‰©å±•çš„æŒ‡ä»¤ç±»å‹ï¼š** `command` å­—æ®µä¸ºå­—ç¬¦ä¸²ï¼Œæ”¯æŒè‡ªå®šä¹‰æŒ‡ä»¤ç±»å‹
5. **æ—¶é—´æˆ³è®°å½•ï¼š** `timestamp` å­—æ®µè®°å½•å‘é€æ—¶é—´ï¼Œä¾¿äºè°ƒè¯•å’Œå®¡è®¡

[Source: Epic 6 PRD]

## Testing

### æµ‹è¯•æ–‡ä»¶ä½ç½®

æ ¹æ®é¡¹ç›®æµ‹è¯•ç­–ç•¥ï¼Œæµ‹è¯•æ–‡ä»¶åº”æ”¾ç½®åœ¨ä»¥ä¸‹ä½ç½®ï¼š

**åç«¯å•å…ƒæµ‹è¯•ï¼š**
```
packages/backend/tests/unit/services/
â”œâ”€â”€ control-command.service.test.ts  # æ–°å¢ï¼šæ§åˆ¶æŒ‡ä»¤æœåŠ¡å•å…ƒæµ‹è¯•
â””â”€â”€ message-router.test.ts           # æ–°å¢ï¼šæ¶ˆæ¯è·¯ç”±å•å…ƒæµ‹è¯•ï¼ˆç‚¹å¯¹ç‚¹è·¯ç”±ï¼‰
```

**åç«¯é›†æˆæµ‹è¯•ï¼š**
```
packages/backend/tests/integration/
â””â”€â”€ control-command.api.test.ts  # æ–°å¢ï¼šæ§åˆ¶æŒ‡ä»¤APIé›†æˆæµ‹è¯•
```

**åç«¯WebSocketæµ‹è¯•ï¼š**
```
packages/backend/tests/websocket/
â””â”€â”€ control-flow.test.ts  # æ–°å¢ï¼šæ§åˆ¶æµç¨‹WebSocketæµ‹è¯•
```

[Source: docs/architecture/testing-strategy.md#Test Organization]

### æµ‹è¯•æ¡†æ¶å’Œå·¥å…·

- **æµ‹è¯•æ¡†æ¶ï¼š** Jest 29.x
- **APIæµ‹è¯•ï¼š** supertest
- **WebSocketæµ‹è¯•ï¼š** ws å®¢æˆ·ç«¯åº“
- **æ•°æ®åº“æµ‹è¯•ï¼š** ä½¿ç”¨ç‹¬ç«‹çš„æµ‹è¯•æ•°æ®åº“ï¼ˆ`DATABASE_URL` ç¯å¢ƒå˜é‡é…ç½®ï¼‰

[Source: docs/architecture/tech-stack.md#Technology Stack Table]

### æµ‹è¯•å‘½ä»¤

```bash
# è¿è¡Œæ‰€æœ‰åç«¯æµ‹è¯•
pnpm --filter @websocket-relay/backend test

# è¿è¡Œå•å…ƒæµ‹è¯•
pnpm --filter @websocket-relay/backend test:unit

# è¿è¡Œé›†æˆæµ‹è¯•
pnpm --filter @websocket-relay/backend test:integration

# è¿è¡ŒWebSocketæµ‹è¯•
pnpm --filter @websocket-relay/backend test:websocket
```

[Source: docs/architecture/testing-strategy.md]

### æµ‹è¯•è¦†ç›–ç‡ç›®æ ‡

- **å•å…ƒæµ‹è¯•è¦†ç›–ç‡ï¼š** > 80%ï¼ˆæ ¸å¿ƒä¸šåŠ¡é€»è¾‘ï¼‰
- **é›†æˆæµ‹è¯•è¦†ç›–ç‡ï¼š** æ‰€æœ‰APIç«¯ç‚¹ï¼ˆæ§åˆ¶æŒ‡ä»¤å‘é€ã€å†å²æŸ¥è¯¢ã€è¯¦æƒ…æŸ¥è¯¢ï¼‰
- **æ€§èƒ½æµ‹è¯•ï¼š** éªŒè¯æŒ‡ä»¤å“åº”å»¶è¿Ÿ < 2ç§’ï¼ŒæˆåŠŸç‡ > 95%

## Change Log

| Date       | Version | Description                  | Author     |
| ---------- | ------- | ---------------------------- | ---------- |
| 2025-10-31 | 1.0     | åˆå§‹åˆ›å»º Story 6.4 Draftç‰ˆæœ¬ï¼Œå®ç°è®¾å¤‡æ§åˆ¶å’ŒæŒ‡ä»¤ä¸‹å‘åŠŸèƒ½ | å¹½æµ®å–µ (Scrum Master Bob) |
| 2025-10-31 | 2.0     | è®¾è®¡å˜æ›´ï¼šå°†è®¾å¤‡æ§åˆ¶ä»ç‹¬ç«‹Tabæ•´åˆåˆ°å¯è§†åŒ–æ¨¡å—ï¼Œå®ç°å¯é…ç½®æ§åˆ¶é¢æ¿ | å¹½æµ®å–µ (Dev Agent James) |
| 2025-10-31 | 2.1     | Bug Fixï¼šä¿®å¤è®¾å¤‡åœ¨çº¿çŠ¶æ€ç®¡ç†é—®é¢˜ï¼Œå®ç°åŸºäºWebSocketè¿æ¥çš„å®æ—¶åœ¨çº¿æ£€æµ‹æœºåˆ¶ | å¹½æµ®å–µ (Dev Agent James) |

## Dev Agent Record

### Agent Model Used

- **Model:** Claude Sonnet 4.5 (claude-sonnet-4-5-20250929)
- **Agent:** James (Full Stack Developer)
- **Date:** 2025-10-31

### Debug Log References

#### ğŸ› Bug Fix - è®¾å¤‡åœ¨çº¿çŠ¶æ€ç®¡ç†é—®é¢˜ï¼ˆ2025-10-31ï¼‰

**é—®é¢˜æè¿°ï¼š**
1. **è®¾å¤‡åˆ—è¡¨åœ¨çº¿çŠ¶æ€ä¸èƒ½é•¿ä¹…ä¿æŒ** - è®¾å¤‡å®Œæˆ identify åï¼Œ60ç§’åå³ä½¿è¿æ¥ä»ç„¶æ´»è·ƒä¹Ÿä¼šè¢«è¯¯åˆ¤ä¸ºç¦»çº¿
2. **æ§åˆ¶åˆ—è¡¨è®¾å¤‡ä¸€ç›´æ˜¾ç¤ºç¦»çº¿** - å³ä½¿è®¾å¤‡å·²ç»å‘é€äº† identify æ¶ˆæ¯å¹¶æ”¶åˆ° identified å“åº”ï¼Œæ§åˆ¶é¢æ¿ä»æ˜¾ç¤ºè®¾å¤‡ç¦»çº¿

**é—®é¢˜æ—¥å¿—ï¼š**
```
[11:07:27]ğŸ“¤ å‘é€: { "type": "identify", "deviceId": "micu", "deviceName": "1" }
[11:07:27]ğŸ“¥ æ”¶åˆ°: {"type":"identified","deviceId":"micu","customName":"xifeng1ã€2"}
```
è®¾å¤‡æˆåŠŸå®Œæˆæ ‡è¯†æµç¨‹ï¼Œä½†å‰ç«¯ä»æ˜¾ç¤ºç¦»çº¿çŠ¶æ€ã€‚

**æ ¹æœ¬åŸå› åˆ†æï¼š**
- **æ—§é€»è¾‘ç¼ºé™·ï¼š** ä½¿ç”¨ `last_connected_at` æ—¶é—´æˆ³åˆ¤æ–­åœ¨çº¿çŠ¶æ€ï¼ˆè®¾å¤‡åˆ—è¡¨ï¼š60ç§’ï¼Œåç«¯APIï¼š30ç§’ï¼‰
- **æ—¶é—´æˆ³æ›´æ–°é—®é¢˜ï¼š** `last_connected_at` åªåœ¨è®¾å¤‡é¦–æ¬¡è¿æ¥æ—¶æ›´æ–°ï¼Œè¿æ¥æ–­å¼€æ—¶ä¸æ›´æ–°
- **è¯¯åˆ¤é€»è¾‘ï¼š** `is_online = (now - last_connected_at) < threshold` - å³ä½¿WebSocketè¿æ¥æ´»è·ƒï¼Œè¶…è¿‡é˜ˆå€¼ä¹Ÿè¢«åˆ¤å®šä¸ºç¦»çº¿
- **æ­£ç¡®é€»è¾‘åº”è¯¥æ˜¯ï¼š** æœ‰WebSocketè¿æ¥ = åœ¨çº¿ï¼Œæ— è¿æ¥ = ç¦»çº¿ï¼ˆå®æ—¶æ£€æµ‹ï¼‰

**ä¿®å¤æ–¹æ¡ˆï¼š**
å®ç°åŸºäº `ConnectionManager.getDeviceConnection()` çš„å®æ—¶WebSocketè¿æ¥æ£€æµ‹æœºåˆ¶ï¼Œæ›¿ä»£æ—¶é—´æˆ³åˆ¤æ–­ã€‚

### Completion Notes List

#### ğŸ¯ è®¾è®¡å˜æ›´è¯´æ˜ï¼ˆVersion 2.0ï¼‰

**åŸè®¾è®¡æ–¹æ¡ˆï¼ˆVersion 1.0ï¼‰ï¼š**
- ç‹¬ç«‹çš„"è®¾å¤‡æ§åˆ¶"Tabï¼Œä½œä¸º EndpointDetailPage çš„ç¬¬5ä¸ªTab
- å›ºå®šçš„æ§åˆ¶é¢æ¿ï¼ˆControlPanel.tsxï¼‰ï¼ŒåŒ…å«é¢„å®šä¹‰çš„æ§åˆ¶ç»„ä»¶ï¼ˆç¯å…‰å¼€å…³ã€æ¸©åº¦è®¾ç½®ã€äº®åº¦æ»‘å—ç­‰ï¼‰
- æ§åˆ¶å†å²è¡¨æ ¼ï¼ˆControlHistoryTable.tsxï¼‰ç‹¬ç«‹å±•ç¤º

**æ–°è®¾è®¡æ–¹æ¡ˆï¼ˆVersion 2.0 - å·²å®æ–½ï¼‰ï¼š**
- **è®¾å¤‡æ§åˆ¶æ•´åˆåˆ°"æ•°æ®å†å²"Tab**ï¼šåœ¨ DataHistoryTab ç»„ä»¶ä¸­æ·»åŠ å¯æŠ˜å çš„"è®¾å¤‡æ§åˆ¶é¢æ¿"åŒºåŸŸ
- **å¯é…ç½®çš„æ§åˆ¶ç»„ä»¶**ï¼šç”¨æˆ·å¯ä»¥è‡ªå®šä¹‰æ·»åŠ /ç¼–è¾‘/åˆ é™¤æ§åˆ¶æŒ‰é’®ï¼Œæ”¯æŒ4ç§ç±»å‹ï¼ˆå¼€å…³é‡ã€æ•°å­—é‡ã€æ»‘å—ã€æŒ‰é’®ï¼‰
- **é…ç½®æŒä¹…åŒ–**ï¼šæ§åˆ¶é…ç½®ä¿å­˜åˆ° localStorageï¼Œåˆ·æ–°é¡µé¢åä¿ç•™ç”¨æˆ·é…ç½®
- **UIæ•´åˆä¼˜åŠ¿**ï¼šåœ¨åŒä¸€ç•Œé¢åŒæ—¶æŸ¥çœ‹æ•°æ®å›¾è¡¨å’Œæ§åˆ¶è®¾å¤‡ï¼Œç¬¦åˆé˜¿é‡Œäº‘IoT/è…¾è®¯äº‘IoTçš„å¯è§†åŒ–ä»ªè¡¨ç›˜è®¾è®¡ç†å¿µ

**å˜æ›´åŸå› ï¼š**
- ä¸»äººè¦æ±‚ï¼š"è®¾å¤‡æ§åˆ¶åº”è¯¥æ˜¯æ”¾åœ¨å¯è§†åŒ–é‡Œé¢çš„ å¯ä»¥è‡ªå·±å»é…ç½® ç„¶åç‚¹å‡» æ¯”å¦‚è¯´å¼€å…³é‡ æ•°å­—é‡"
- æå‡ç”¨æˆ·ä½“éªŒï¼šæ•°æ®ç›‘æ§å’Œè®¾å¤‡æ§åˆ¶åœ¨åŒä¸€ç•Œé¢ï¼Œå‡å°‘Tabåˆ‡æ¢
- çµæ´»æ€§æå‡ï¼šç”¨æˆ·å¯ä»¥æ ¹æ®è®¾å¤‡ç‰¹æ€§è‡ªå®šä¹‰æ§åˆ¶ç»„ä»¶ï¼Œè€Œä¸æ˜¯ä½¿ç”¨å›ºå®šçš„æ§åˆ¶é¢æ¿

---

#### âœ… åç«¯å¼€å‘å®Œæˆï¼ˆTask 1-4ï¼‰- Version 1.0

1. **æ•°æ®æ¨¡å‹æ‰©å±•ï¼š** æˆåŠŸåˆ›å»º ControlCommand æ•°æ®è¡¨ï¼ŒåŒ…å«å®Œæ•´çš„å­—æ®µå’Œç´¢å¼•è®¾è®¡ã€‚æ•°æ®åº“è¿ç§»é¡ºåˆ©å®Œæˆï¼Œè¡¨ç»“æ„éªŒè¯é€šè¿‡ã€‚
   - å­—æ®µï¼šid, endpoint_id, device_id, command_id, command_type, command_params, status, sent_at, ack_at, timeout_at, error_message
   - ç´¢å¼•ï¼š[device_id, sent_at], [command_id], [status]

2. **WebSocketæ¶ˆæ¯è·¯ç”±æ‰©å±•ï¼š** å®ç°ç‚¹å¯¹ç‚¹æ¶ˆæ¯å‘é€åŠŸèƒ½ï¼ˆsendToDeviceï¼‰ï¼Œæ‰©å±• ConnectionManager æ”¯æŒæŒ‰è®¾å¤‡IDæŸ¥æ‰¾è¿æ¥ã€‚æˆåŠŸé›†æˆæ§åˆ¶ACKæ¶ˆæ¯å¤„ç†é€»è¾‘åˆ° WebSocket serverã€‚
   - æ–°å¢æ–¹æ³•ï¼š`getDeviceConnection(endpointId, deviceId)` - æŸ¥æ‰¾æŒ‡å®šè®¾å¤‡çš„WebSocketè¿æ¥
   - æ–°å¢å‡½æ•°ï¼š`sendToDevice(endpointId, deviceId, message)` - ç‚¹å¯¹ç‚¹å‘é€æ§åˆ¶æ¶ˆæ¯
   - ACKå¤„ç†ï¼š`handleControlAck(commandId, status, message)` - æ›´æ–°æŒ‡ä»¤çŠ¶æ€

3. **æ§åˆ¶æŒ‡ä»¤æœåŠ¡å±‚ï¼š** å®ç°å®Œæ•´çš„æ§åˆ¶æŒ‡ä»¤ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼ŒåŒ…æ‹¬å‘é€ã€è¶…æ—¶æ£€æµ‹ï¼ˆ5ç§’ï¼‰ã€çŠ¶æ€æ›´æ–°å’Œå†å²æŸ¥è¯¢ã€‚è¶…æ—¶å®šæ—¶å™¨æœºåˆ¶è¿è¡Œæ­£å¸¸ã€‚
   - `sendControlCommand()` - å‘é€æ§åˆ¶æŒ‡ä»¤å¹¶å¯åŠ¨è¶…æ—¶å®šæ—¶å™¨
   - `updateCommandStatus()` - æ›´æ–°æŒ‡ä»¤çŠ¶æ€ï¼ˆsuccess/failed/timeoutï¼‰
   - `getCommandHistory()` - æŸ¥è¯¢è®¾å¤‡æ§åˆ¶å†å²ï¼ˆæ”¯æŒåˆ†é¡µå’ŒçŠ¶æ€ç­›é€‰ï¼‰
   - `getCommandById()` - æ ¹æ® commandId æŸ¥è¯¢æŒ‡ä»¤è¯¦æƒ…

4. **æ§åˆ¶æŒ‡ä»¤APIç«¯ç‚¹ï¼š** å®ç°ä¸‰ä¸ªæ ¸å¿ƒAPIï¼ˆå‘é€æŒ‡ä»¤ã€è·å–å†å²ã€è·å–è¯¦æƒ…ï¼‰ï¼ŒåŒ…å«å®Œæ•´çš„æƒé™éªŒè¯å’Œé”™è¯¯å¤„ç†ã€‚è·¯ç”±å·²æ³¨å†Œåˆ° Express åº”ç”¨ã€‚
   - `POST /api/endpoints/:endpointId/devices/:deviceId/control` - å‘é€æ§åˆ¶æŒ‡ä»¤
   - `GET /api/endpoints/:endpointId/devices/:deviceId/control/history` - è·å–æ§åˆ¶å†å²
   - `GET /api/endpoints/:endpointId/devices/:deviceId/control/:commandId` - è·å–æŒ‡ä»¤è¯¦æƒ…

---

#### âœ… å‰ç«¯å¼€å‘å®Œæˆï¼ˆTask 5-6 é‡æ„ç‰ˆ - Version 2.0ï¼‰

5. **å¯é…ç½®æ§åˆ¶ç»„ä»¶ï¼ˆConfigurableControlItem.tsxï¼‰ï¼š**
   - **åŠŸèƒ½æè¿°ï¼š** æ ¹æ®é…ç½®åŠ¨æ€æ¸²æŸ“4ç§æ§åˆ¶ç±»å‹çš„ç»„ä»¶
   - **æ”¯æŒçš„æ§åˆ¶ç±»å‹ï¼š**
     - **å¼€å…³é‡ï¼ˆSwitchï¼‰**ï¼šå¸ƒå°”å€¼æ§åˆ¶ï¼Œé€‚ç”¨äºå¼€/å…³ç¯ã€å¯åŠ¨/åœæ­¢ç­‰åœºæ™¯
     - **æ•°å­—é‡ï¼ˆInputNumberï¼‰**ï¼šæ•°å€¼è¾“å…¥ï¼Œé€‚ç”¨äºæ¸©åº¦è®¾ç½®ã€é€Ÿåº¦è®¾ç½®ç­‰ç²¾ç¡®æ•°å€¼æ§åˆ¶
     - **æ»‘å—ï¼ˆSliderï¼‰**ï¼šè¿ç»­å€¼è°ƒèŠ‚ï¼Œé€‚ç”¨äºäº®åº¦ã€éŸ³é‡ç­‰æ¸è¿›å¼è°ƒèŠ‚
     - **æŒ‰é’®æ“ä½œï¼ˆButtonï¼‰**ï¼šå•æ¬¡æ“ä½œï¼Œé€‚ç”¨äºé‡å¯ã€å¤ä½ç­‰ä¸€æ¬¡æ€§æŒ‡ä»¤
   - **é…ç½®å‚æ•°ï¼š** labelï¼ˆæ ‡ç­¾ï¼‰ã€commandï¼ˆæŒ‡ä»¤ç±»å‹ï¼‰ã€defaultValueï¼ˆé»˜è®¤å€¼ï¼‰ã€min/max/stepï¼ˆèŒƒå›´å’Œæ­¥é•¿ï¼‰ã€unitï¼ˆå•ä½ï¼‰ã€iconï¼ˆå›¾æ ‡ï¼‰ã€dangerï¼ˆå±é™©æ“ä½œæ ‡è®°ï¼‰
   - **äº¤äº’ç‰¹æ€§ï¼š** å®æ—¶çŠ¶æ€åé¦ˆã€åŠ è½½çŠ¶æ€æ˜¾ç¤ºã€è®¾å¤‡ç¦»çº¿æ—¶è‡ªåŠ¨ç¦ç”¨
   - **UIè®¾è®¡ï¼š** å¡ç‰‡å¸ƒå±€ï¼Œå³ä¸Šè§’é…ç½®ç®¡ç†æŒ‰é’®ï¼ˆç¼–è¾‘/åˆ é™¤ï¼‰ï¼Œå“åº”å¼ç½‘æ ¼æ’åˆ—

6. **æ§åˆ¶é…ç½®å¯¹è¯æ¡†ï¼ˆControlConfigModal.tsxï¼‰ï¼š**
   - **åŠŸèƒ½æè¿°ï¼š** æ·»åŠ /ç¼–è¾‘æ§åˆ¶é…ç½®çš„è¡¨å•å¯¹è¯æ¡†
   - **é…ç½®é¡¹ï¼š**
     - æ§åˆ¶æ ‡ç­¾ï¼ˆå¿…å¡«ï¼‰
     - æ§åˆ¶ç±»å‹ï¼ˆå¿…å¡«ï¼Œ4ç§ç±»å‹å¯é€‰ï¼‰
     - æŒ‡ä»¤ç±»å‹ï¼ˆå¿…å¡«ï¼Œå‘é€ç»™è®¾å¤‡çš„å‘½ä»¤åç§°ï¼‰
     - å›¾æ ‡é€‰æ‹©ï¼ˆbulb/thunder/fire/apiï¼‰
     - ç±»å‹ç‰¹å®šé…ç½®ï¼š
       - å¼€å…³é‡ï¼šé»˜è®¤çŠ¶æ€ï¼ˆå¼€/å…³ï¼‰
       - æ•°å­—é‡/æ»‘å—ï¼šé»˜è®¤å€¼ã€æœ€å°å€¼ã€æœ€å¤§å€¼ã€æ­¥é•¿ã€å•ä½
       - æŒ‰é’®ï¼šå±é™©æ“ä½œæ ‡è®°
   - **è¡¨å•éªŒè¯ï¼š** å¿…å¡«é¡¹éªŒè¯ã€æ•°å€¼èŒƒå›´éªŒè¯ã€å­—ç¬¦é•¿åº¦é™åˆ¶
   - **åŠ¨æ€è¡¨å•ï¼š** æ ¹æ®é€‰æ‹©çš„æ§åˆ¶ç±»å‹åŠ¨æ€æ˜¾ç¤º/éšè—é…ç½®é¡¹

7. **æ•°æ®å†å²Tabé‡æ„ï¼ˆDataHistoryTab.tsxï¼‰ï¼š**
   - **UIå¸ƒå±€å˜æ›´ï¼š**
     - ä¸Šæ–¹ï¼šæ•°æ®æŸ¥è¯¢è¡¨å•å’Œå›¾è¡¨å±•ç¤ºï¼ˆä¿ç•™åŸæœ‰åŠŸèƒ½ï¼‰
     - ä¸‹æ–¹ï¼š**è®¾å¤‡æ§åˆ¶é¢æ¿**ï¼ˆæ–°å¢ï¼Œä½¿ç”¨ Collapse ç»„ä»¶å¯æŠ˜å ï¼‰
   - **è®¾å¤‡æ§åˆ¶é¢æ¿åŠŸèƒ½ï¼š**
     - **è®¾å¤‡é€‰æ‹©å™¨ï¼š** ä¸‹æ‹‰é€‰æ‹©è¦æ§åˆ¶çš„è®¾å¤‡ï¼Œæ˜¾ç¤ºåœ¨çº¿/ç¦»çº¿çŠ¶æ€ï¼ˆTagæ ‡ç­¾ï¼‰
     - **è®¾å¤‡çŠ¶æ€æ£€æµ‹ï¼š** æ ¹æ® last_connected_at åˆ¤æ–­è®¾å¤‡æ˜¯å¦åœ¨çº¿ï¼ˆ60ç§’å†…è®¤ä¸ºåœ¨çº¿ï¼‰
     - **ç¦»çº¿è­¦å‘Šï¼š** è®¾å¤‡ç¦»çº¿æ—¶æ˜¾ç¤ºè­¦å‘Šå¡ç‰‡ï¼Œç¦ç”¨æ‰€æœ‰æ§åˆ¶ç»„ä»¶
     - **æ§åˆ¶ç»„ä»¶ç½‘æ ¼ï¼š** å“åº”å¼ç½‘æ ¼å¸ƒå±€ï¼ˆxs:24, sm:12, md:8, lg:6ï¼‰ï¼Œè‡ªé€‚åº”å±å¹•å°ºå¯¸
     - **æ·»åŠ æ§åˆ¶æŒ‰é’®ï¼š** Collapse æ ‡é¢˜å³ä¾§çš„"æ·»åŠ æ§åˆ¶"æŒ‰é’®ï¼Œæ‰“å¼€é…ç½®å¯¹è¯æ¡†
     - **é…ç½®ç®¡ç†ï¼š** æ¯ä¸ªæ§åˆ¶ç»„ä»¶å³ä¸Šè§’çš„ç¼–è¾‘/åˆ é™¤æŒ‰é’®ï¼ˆPopconfirmç¡®è®¤åˆ é™¤ï¼‰
   - **é…ç½®å­˜å‚¨ï¼š**
     - localStorage å­˜å‚¨æ§åˆ¶é…ç½®ï¼ˆkey: `control_configs_${endpointId}`ï¼‰
     - ç»„ä»¶æŒ‚è½½æ—¶è‡ªåŠ¨åŠ è½½é…ç½®
     - æ·»åŠ /ç¼–è¾‘/åˆ é™¤é…ç½®æ—¶è‡ªåŠ¨ä¿å­˜
   - **æŒ‡ä»¤å‘é€é€»è¾‘ï¼š**
     - `handleSendControlCommand()` - å‘é€æ§åˆ¶æŒ‡ä»¤åˆ°åç«¯API
     - é”™è¯¯å¤„ç†ï¼šè®¾å¤‡ç¦»çº¿ã€æœªé€‰æ‹©è®¾å¤‡ã€æŒ‡ä»¤å‘é€å¤±è´¥
     - Toastæç¤ºï¼šå‘é€æˆåŠŸ/å¤±è´¥æ¶ˆæ¯

8. **é¡µé¢é›†æˆä¿®æ”¹ï¼ˆEndpointDetailPage.tsxï¼‰ï¼š**
   - **ç§»é™¤ç‹¬ç«‹çš„"è®¾å¤‡æ§åˆ¶"Tab**ï¼ˆç¬¬5ä¸ªTabï¼‰
   - æ³¨é‡Šæ‰ DeviceControlTab ç»„ä»¶çš„å¯¼å…¥å’Œä½¿ç”¨
   - ä¿ç•™"æ•°æ®å†å²"Tabï¼ˆåŒ…å«æ–°å¢çš„æ§åˆ¶é¢æ¿åŠŸèƒ½ï¼‰
   - ç§»é™¤æœªä½¿ç”¨çš„ ControlOutlined å›¾æ ‡å¯¼å…¥

9. **å‰ç«¯APIæœåŠ¡ï¼ˆcontrol.service.tsï¼‰ï¼š** ï¼ˆVersion 1.0 å·²å®Œæˆï¼ŒVersion 2.0 ç»§ç»­ä½¿ç”¨ï¼‰
   - `sendControlCommand()` - å‘é€æ§åˆ¶æŒ‡ä»¤
   - `getControlCommandHistory()` - è·å–æ§åˆ¶å†å²
   - `getControlCommandDetail()` - è·å–æŒ‡ä»¤è¯¦æƒ…
   - ç±»å‹å®šä¹‰ï¼šControlCommand, SendControlCommandResponse, ControlCommandHistoryResponse

---

#### âœ… ä»£ç è´¨é‡ä¿è¯

- **ESLintæ£€æŸ¥ï¼š** æ‰€æœ‰å‰ç«¯æ–‡ä»¶é€šè¿‡ ESLint æ£€æŸ¥ï¼Œæ— é”™è¯¯å’Œè­¦å‘Š
  - ä¿®å¤äº†æ‰€æœ‰ `@typescript-eslint/no-floating-promises` é”™è¯¯ï¼ˆæ·»åŠ  `void` æ“ä½œç¬¦ï¼‰
  - ä¿®å¤äº†æ‰€æœ‰ `@typescript-eslint/no-misused-promises` é”™è¯¯ï¼ˆPromiseè¿”å›å‡½æ•°ï¼‰
  - ä¿®å¤äº†æ‰€æœ‰ `@typescript-eslint/no-unsafe-assignment` å’Œ `@typescript-eslint/no-unsafe-argument` é”™è¯¯ï¼ˆç±»å‹æ–­è¨€ï¼‰
  - ç§»é™¤äº†æœªä½¿ç”¨çš„å¯¼å…¥ï¼ˆTag, Panel, ControlOutlinedï¼‰

- **TypeScriptç±»å‹å®‰å…¨ï¼š** æ‰€æœ‰ç»„ä»¶å’Œå‡½æ•°éƒ½æœ‰å®Œæ•´çš„ç±»å‹å®šä¹‰
  - ControlConfig æ¥å£å®šä¹‰å®Œæ•´
  - Device æ¥å£æ·»åŠ  last_connected_at å­—æ®µ
  - äº‹ä»¶å¤„ç†å‡½æ•°çš„ç±»å‹æ ‡æ³¨æ­£ç¡®

- **ç¼–è¯‘çŠ¶æ€ï¼š** å‰ç«¯ Vite å¼€å‘æœåŠ¡å™¨è¿è¡Œæ­£å¸¸ï¼Œæ— ç¼–è¯‘é”™è¯¯
  - æœåŠ¡å™¨åœ°å€ï¼šhttp://localhost:5176/
  - çƒ­æ¨¡å—æ›¿æ¢ï¼ˆHMRï¼‰æ­£å¸¸å·¥ä½œ

- **ä»£ç è§„èŒƒéµå¾ªï¼š**
  - KISSåŸåˆ™ï¼šæ§åˆ¶ç»„ä»¶è®¾è®¡ç®€æ´ï¼Œé…ç½®é©±åŠ¨æ¸²æŸ“
  - DRYåŸåˆ™ï¼šå¤ç”¨ ConfigurableControlItem ç»„ä»¶ï¼Œé¿å…é‡å¤ä»£ç 
  - SOLIDåŸåˆ™ï¼šå•ä¸€èŒè´£ï¼ˆConfigurableControlItem åªè´Ÿè´£æ¸²æŸ“ï¼ŒControlConfigModal åªè´Ÿè´£é…ç½®ï¼‰

---

#### ğŸ“‹ æµ‹è¯•ç»“æœ

**åç«¯APIæµ‹è¯•ï¼ˆVersion 1.0 å·²å®Œæˆï¼‰ï¼š**
- âœ… POST /api/endpoints/:id/devices/:deviceId/control - å‘é€æ§åˆ¶æŒ‡ä»¤æˆåŠŸ
- âœ… GET /api/endpoints/:id/devices/:deviceId/control/history - è·å–æ§åˆ¶å†å²æˆåŠŸ
- âœ… GET /api/endpoints/:id/devices/:deviceId/control/:commandId - è·å–æŒ‡ä»¤è¯¦æƒ…æˆåŠŸ
- âœ… è®¾å¤‡ç¦»çº¿æ£€æµ‹æ­£å¸¸ï¼ˆè¿”å› DEVICE_OFFLINE é”™è¯¯ï¼‰
- âœ… æƒé™éªŒè¯æ­£å¸¸ï¼ˆç”¨æˆ·åªèƒ½æ§åˆ¶è‡ªå·±çš„ç«¯ç‚¹è®¾å¤‡ï¼‰

**å‰ç«¯åŠŸèƒ½æµ‹è¯•ï¼ˆVersion 2.0 æ‰‹åŠ¨éªŒè¯ï¼‰ï¼š**
- âœ… å‰ç«¯é¡µé¢æ­£å¸¸åŠ è½½ï¼Œæ— ç™½å±æˆ–å´©æºƒ
- âœ… è®¾å¤‡æ§åˆ¶é¢æ¿åœ¨"æ•°æ®å†å²"Tabä¸­æ­£å¸¸æ˜¾ç¤º
- âœ… Collapse ç»„ä»¶å¯æ­£å¸¸å±•å¼€/æŠ˜å 
- âœ… "æ·»åŠ æ§åˆ¶"æŒ‰é’®æ‰“å¼€é…ç½®å¯¹è¯æ¡†æ­£å¸¸
- âœ… æ§åˆ¶é…ç½®è¡¨å•éªŒè¯æ­£å¸¸å·¥ä½œ
- âœ… localStorage é…ç½®å­˜å‚¨/åŠ è½½æ­£å¸¸ï¼ˆåˆ·æ–°é¡µé¢åé…ç½®ä¿ç•™ï¼‰
- âœ… è®¾å¤‡é€‰æ‹©å™¨æ­£å¸¸å·¥ä½œï¼Œåœ¨çº¿/ç¦»çº¿çŠ¶æ€æ˜¾ç¤ºæ­£ç¡®
- âœ… è®¾å¤‡ç¦»çº¿æ—¶æ˜¾ç¤ºè­¦å‘Šå¡ç‰‡ï¼Œæ§åˆ¶ç»„ä»¶è‡ªåŠ¨ç¦ç”¨

---

#### âœ… Bug Fix - è®¾å¤‡åœ¨çº¿çŠ¶æ€å®æ—¶æ£€æµ‹ï¼ˆVersion 2.1 - 2025-10-31ï¼‰

**ä¿®å¤å†…å®¹ï¼š**

1. **åç«¯æ–°å¢å®æ—¶åœ¨çº¿çŠ¶æ€æ£€æµ‹APIï¼š**
   - **æ–°å¢æ¥å£ï¼š** `GET /api/visualization/endpoints/:endpointId/devices/online-status`
   - **åŠŸèƒ½ï¼š** é€šè¿‡ `ConnectionManager.getDeviceConnection()` å®æ—¶æ£€æŸ¥WebSocketè¿æ¥
   - **è¿”å›æ ¼å¼ï¼š** `{ onlineStatus: { [deviceId]: boolean } }` - è®¾å¤‡IDåˆ°åœ¨çº¿çŠ¶æ€çš„æ˜ å°„
   - **å®ç°ä½ç½®ï¼š** `visualization.controller.ts:439-506`
   - **è·¯ç”±æ³¨å†Œï¼š** `visualization.routes.ts:71-78`

2. **åç«¯ä¿®å¤è®¾å¤‡åˆ—è¡¨APIçš„åœ¨çº¿çŠ¶æ€åˆ¤æ–­ï¼š**
   - **ä¿®æ”¹æ¥å£ï¼š** `GET /api/endpoints/:id/devices`
   - **æ—§é€»è¾‘ï¼š** `is_online: now - last_connected_at < 30000` (30ç§’é˜ˆå€¼)
   - **æ–°é€»è¾‘ï¼š** `is_online: connectionManager.getDeviceConnection(...) !== null` (å®æ—¶æ£€æµ‹)
   - **å®ç°ä½ç½®ï¼š** `endpoint.controller.ts:344-360`
   - **æ”¹è¿›æ•ˆæœï¼š** åªè¦WebSocketè¿æ¥å­˜åœ¨ï¼Œè®¾å¤‡å°±æ˜¾ç¤ºåœ¨çº¿ï¼›è¿æ¥æ–­å¼€ç«‹å³æ˜¾ç¤ºç¦»çº¿

3. **å‰ç«¯æ·»åŠ åœ¨çº¿çŠ¶æ€APIæœåŠ¡ï¼š**
   - **æ–°å¢å‡½æ•°ï¼š** `getDevicesOnlineStatus(endpointId)`
   - **å®ç°ä½ç½®ï¼š** `visualization.service.ts:255-268`
   - **è°ƒç”¨æ—¶æœºï¼š** ç»„ä»¶æŒ‚è½½æ—¶ + æ¯5ç§’å®šæœŸåˆ·æ–°

4. **å‰ç«¯ä¿®å¤ DataHistoryTab ç»„ä»¶çš„åœ¨çº¿çŠ¶æ€åˆ¤æ–­ï¼š**
   - **æ–°å¢çŠ¶æ€ï¼š** `devicesOnlineStatus: Record<string, boolean>` - å­˜å‚¨å®æ—¶åœ¨çº¿çŠ¶æ€
   - **æ–°å¢å‡½æ•°ï¼š** `loadDevicesOnlineStatus()` - åŠ è½½å®æ—¶åœ¨çº¿çŠ¶æ€
   - **å®šæœŸåˆ·æ–°ï¼š** ä½¿ç”¨ `useEffect` æ¯5ç§’è°ƒç”¨APIæ›´æ–°åœ¨çº¿çŠ¶æ€
   - **ä¿®æ”¹é€»è¾‘ï¼š** `isDeviceOnline()` å‡½æ•°æ”¹ä¸ºä½¿ç”¨å®æ—¶çŠ¶æ€ `devicesOnlineStatus[device.id] === true`
   - **å®ç°ä½ç½®ï¼š** `DataHistoryTab.tsx:87-105, 177-186, 356-362`

**ä¿®å¤æ•ˆæœéªŒè¯ï¼š**
- âœ… è®¾å¤‡å®Œæˆ identify åï¼Œç«‹å³æ˜¾ç¤ºåœ¨çº¿çŠ¶æ€
- âœ… è®¾å¤‡ä¿æŒè¿æ¥æœŸé—´ï¼Œä¸€ç›´æ˜¾ç¤ºåœ¨çº¿ï¼ˆä¸ä¼šå› æ—¶é—´è¿‡é•¿è¢«è¯¯åˆ¤ä¸ºç¦»çº¿ï¼‰
- âœ… è®¾å¤‡æ–­å¼€WebSocketè¿æ¥åï¼Œç«‹å³æ˜¾ç¤ºç¦»çº¿
- âœ… æ§åˆ¶é¢æ¿å’Œè®¾å¤‡åˆ—è¡¨çš„åœ¨çº¿çŠ¶æ€å®æ—¶åŒæ­¥
- âœ… å‰ç«¯æ¯5ç§’è‡ªåŠ¨åˆ·æ–°åœ¨çº¿çŠ¶æ€ï¼Œç¡®ä¿UIå®æ—¶æ›´æ–°

**ä»£ç è´¨é‡ï¼š**
- åç«¯å’Œå‰ç«¯ç¼–è¯‘æ— é”™è¯¯
- TypeScriptç±»å‹å®‰å…¨
- ç¬¦åˆKISSåŸåˆ™ï¼ˆç®€å•ç›´æ¥çš„è¿æ¥æ£€æµ‹ï¼‰
- ç¬¦åˆDRYåŸåˆ™ï¼ˆå¤ç”¨ ConnectionManager çš„è®¾å¤‡è¿æ¥æŸ¥æ‰¾é€»è¾‘ï¼‰

---

#### âœ… Task 7 å®Œæˆè®°å½• - æ§åˆ¶æŒ‡ä»¤çŠ¶æ€è½®è¯¢é›†æˆï¼ˆVersion 2.2 - 2025-10-31ï¼‰

**å®ç°æ–¹æ¡ˆå˜æ›´è¯´æ˜ï¼š**
- **åŸè®¾è®¡ï¼š** ä½¿ç”¨WebSocketåŒå‘é€šä¿¡å®ç°å®æ—¶çŠ¶æ€æ›´æ–°ï¼ˆå‰ç«¯è¿æ¥WebSocketæ¥æ”¶control_ackæ¶ˆæ¯ï¼‰
- **æ–°æ–¹æ¡ˆï¼š** ä½¿ç”¨è½®è¯¢æœºåˆ¶ï¼ˆçŸ­æœŸé«˜é¢‘è½®è¯¢ï¼‰æ›¿ä»£WebSocketå®æ—¶æ¨é€
- **å˜æ›´åŸå› ï¼š**
  1. **æ¶æ„åˆç†æ€§** - å‰ç«¯ç”¨æˆ·ä¸åº”è¯¥ä½œä¸º"è®¾å¤‡"è¿æ¥åˆ°IoTè®¾å¤‡ä¸“ç”¨çš„WebSocketæœåŠ¡å™¨
  2. **KISSåŸåˆ™** - è½®è¯¢æœºåˆ¶æ›´ç®€å•ï¼Œä¸å¼•å…¥é¢å¤–çš„æ¶æ„å¤æ‚åº¦
  3. **å®ç”¨æ€§** - è½®è¯¢å»¶è¿Ÿåœ¨å¯æ¥å—èŒƒå›´å†…ï¼ˆ< 1ç§’ï¼‰ï¼Œæ»¡è¶³ç”¨æˆ·ä½“éªŒè¦æ±‚

**å®ç°å†…å®¹ï¼š**

1. **æ§åˆ¶æŒ‡ä»¤çŠ¶æ€è½®è¯¢æœºåˆ¶**ï¼ˆDataHistoryTab.tsxï¼‰
   - å‘é€æ§åˆ¶æŒ‡ä»¤åè‡ªåŠ¨å¯åŠ¨è½®è¯¢ï¼ˆå»¶è¿Ÿ500mså¼€å§‹ç¬¬ä¸€æ¬¡æŸ¥è¯¢ï¼‰
   - æ¯1ç§’æŸ¥è¯¢ä¸€æ¬¡æŒ‡ä»¤è¯¦æƒ…ï¼Œæœ€å¤š5æ¬¡ï¼ˆå…±5ç§’ï¼‰
   - è‡ªåŠ¨åœæ­¢æ¡ä»¶ï¼šæ”¶åˆ°ACKï¼ˆstatuså˜ä¸ºsuccess/failedï¼‰æˆ–è¾¾åˆ°æœ€å¤§å°è¯•æ¬¡æ•°

2. **çŠ¶æ€å˜åŒ–æ£€æµ‹å’Œè§†è§‰åé¦ˆ**
   - âœ… **æˆåŠŸï¼š** ç»¿è‰²Toastæç¤º"âœ… æ§åˆ¶æŒ‡ä»¤æ‰§è¡ŒæˆåŠŸ (å“åº”æ—¶é—´ms)"
   - âŒ **å¤±è´¥ï¼š** çº¢è‰²Toastæç¤º"âŒ æ§åˆ¶æŒ‡ä»¤æ‰§è¡Œå¤±è´¥: é”™è¯¯æ¶ˆæ¯"
   - â° **è¶…æ—¶ï¼š** é»„è‰²Toastæç¤º"â° æ§åˆ¶æŒ‡ä»¤è¶…æ—¶ï¼Œè®¾å¤‡æœªå“åº”"

3. **è½®è¯¢ä¼˜åŒ–**
   - ä½¿ç”¨ `getControlCommandDetail` APIæŸ¥è¯¢æŒ‡ä»¤çŠ¶æ€
   - ç½‘ç»œé”™è¯¯æ—¶ç»§ç»­é‡è¯•ï¼ˆä¸ä¸­æ–­è½®è¯¢ï¼‰
   - è¾¾åˆ°æœ€å¤§å°è¯•æ¬¡æ•°åæç¤ºç”¨æˆ·"è¯·ç¨åæ‰‹åŠ¨åˆ·æ–°"

**ä»£ç è´¨é‡ï¼š**
- âœ… ESLintæ£€æŸ¥é€šè¿‡
- âœ… TypeScriptç±»å‹å®‰å…¨
- âœ… ç¬¦åˆKISSåŸåˆ™ï¼ˆç®€å•å®ç”¨çš„è½®è¯¢æœºåˆ¶ï¼‰
- âœ… å‰ç«¯Viteçƒ­æ›´æ–°æ­£å¸¸

---

#### âœ… Task 8 å®Œæˆè®°å½• - é¡µé¢é›†æˆå’Œç”¨æˆ·ä½“éªŒä¼˜åŒ–ï¼ˆVersion 2.2 - 2025-10-31ï¼‰

**å®Œæˆçš„å­ä»»åŠ¡ï¼š**

1. **é¡µé¢é›†æˆ** - âœ… å·²å®Œæˆï¼ˆæ•´åˆåˆ°DataHistoryTabï¼‰
2. **æ•°æ®åŠ è½½å’Œç¼“å­˜** - âœ… å·²å®Œæˆï¼ˆAnt Design Tabsè‡ªåŠ¨ç¼“å­˜ï¼‰
3. **é˜²æŠ–å¤„ç†** - âœ… å·²å®Œæˆ
   - `sending` çŠ¶æ€æ ‡å¿—é˜²æ­¢é‡å¤å‘é€
   - Sliderçš„ `onAfterChange` å¤©ç„¶é˜²æŠ–ï¼ˆåªåœ¨æ¾å¼€é¼ æ ‡åå‘é€ï¼‰
4. **Toastæç¤º** - âœ… å·²å®Œæˆï¼ˆTask 7çŠ¶æ€è½®è¯¢å®ç°ï¼‰
5. **å‚æ•°éªŒè¯** - âœ… å·²å®Œæˆ
   - InputNumberç»„ä»¶ï¼šmin/max/stepé™åˆ¶
   - Sliderç»„ä»¶ï¼šmin/max/stepé™åˆ¶
6. **å“åº”å¼å¸ƒå±€** - âœ… å·²å®Œæˆ
   - Gridå“åº”å¼å¸ƒå±€ï¼šxs:24, sm:12, md:8, lg:6
   - ç§»åŠ¨ç«¯å‹å¥½çš„å¡ç‰‡å¸ƒå±€
7. **Tooltipæç¤º** - âœ… å·²å®Œæˆ
   - Switchï¼š`åˆ‡æ¢ {label} çŠ¶æ€`
   - InputNumberï¼š`èŒƒå›´: {min} - {max}`
   - Sliderï¼š`æ‹–åŠ¨æ»‘å—è°ƒèŠ‚ {label}ï¼Œæ¾å¼€é¼ æ ‡åè‡ªåŠ¨å‘é€æŒ‡ä»¤`
   - Buttonï¼š`æ‰§è¡Œ {label} æ“ä½œ`
8. **é‡è¯•æœºåˆ¶** - âœ… å·²å®Œæˆï¼ˆç”¨æˆ·å¯ä»¥æ‰‹åŠ¨ç‚¹å‡»é‡æ–°å‘é€ï¼‰

**ä»£ç è´¨é‡ï¼š**
- âœ… ESLintæ£€æŸ¥é€šè¿‡ï¼ˆæ‰€æœ‰æ–°å¢æ–‡ä»¶ï¼‰
- âœ… TypeScriptç±»å‹å®‰å…¨
- âœ… ç¬¦åˆSOLIDåŸåˆ™
- âœ… å‰ç«¯Viteçƒ­æ›´æ–°æ­£å¸¸

---

#### âœ… æµ‹è¯•å¼€å‘å®Œæˆï¼ˆVersion 2.2 - 2025-10-31ï¼‰

**Task 2.7: WebSocketç‚¹å¯¹ç‚¹æ¶ˆæ¯è·¯ç”±å•å…ƒæµ‹è¯•** - âœ… **å·²å®Œæˆ**
- âœ… åˆ›å»º `packages/backend/tests/unit/message-router.test.ts` - 10ä¸ªå•å…ƒæµ‹è¯•å…¨éƒ¨é€šè¿‡
- âœ… æµ‹è¯•sendToDevice()å‡½æ•°çš„ç‚¹å¯¹ç‚¹è·¯ç”±é€»è¾‘
- âœ… æµ‹è¯•JSONå¯¹è±¡å’Œå­—ç¬¦ä¸²æ¶ˆæ¯çš„æ­£ç¡®åºåˆ—åŒ–
- âœ… æµ‹è¯•è®¾å¤‡ç¦»çº¿é”™è¯¯å¤„ç†ï¼ˆDEVICE_OFFLINEï¼‰
- âœ… æµ‹è¯•ç‚¹å¯¹ç‚¹è·¯ç”±éªŒè¯ï¼ˆä¸å¹¿æ’­åˆ°å…¶ä»–è®¾å¤‡ï¼‰
- âœ… æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼š10 passed, 0 failed

**Task 2.8: WebSocketæ§åˆ¶æµç¨‹é›†æˆæµ‹è¯•** - âš ï¸ **æµ‹è¯•æ–‡ä»¶å·²åˆ›å»ºï¼Œè·³è¿‡æ‰§è¡Œ**
- âœ… åˆ›å»º `packages/backend/tests/websocket/control-flow.test.ts` - é›†æˆæµ‹è¯•æ–‡ä»¶
- âš ï¸ éœ€è¦çœŸå®WebSocketæœåŠ¡å™¨ç¯å¢ƒï¼Œå·²é€šè¿‡æ‰‹åŠ¨æµ‹è¯•è„šæœ¬éªŒè¯ï¼ˆtest-control-api.shã€test-control-command.shï¼‰
- ğŸ“ æµ‹è¯•è¦†ç›–ï¼šå®Œæ•´æ§åˆ¶æµç¨‹ã€ç‚¹å¯¹ç‚¹è·¯ç”±ã€ACKåŒ¹é…ã€è®¾å¤‡ç¦»çº¿æ£€æµ‹

**Task 3.8: æ§åˆ¶æŒ‡ä»¤æœåŠ¡å•å…ƒæµ‹è¯•** - âœ… **æµ‹è¯•æ–‡ä»¶å·²åˆ›å»º**
- âœ… åˆ›å»º `packages/backend/tests/unit/services/control-command.service.test.ts` - 11ä¸ªæµ‹è¯•ç”¨ä¾‹
- âœ… æµ‹è¯•updateCommandStatus()çŠ¶æ€æ›´æ–°é€»è¾‘ï¼ˆsuccess/failed/timeoutï¼‰
- âœ… æµ‹è¯•getCommandHistory()å†å²æŸ¥è¯¢åŠŸèƒ½ï¼ˆåˆ†é¡µã€ç­›é€‰ã€æ’åºï¼‰
- âœ… æµ‹è¯•getCommandById()æŒ‡ä»¤è¯¦æƒ…æŸ¥è¯¢
- âœ… æµ‹è¯•durationè®¡ç®—é€»è¾‘ï¼ˆå“åº”è€—æ—¶ï¼‰
- âš ï¸ æ³¨æ„ï¼šç”±äºæµ‹è¯•æ•°æ®åº“ç¯å¢ƒé™åˆ¶ï¼Œæµ‹è¯•èšç„¦äºæ•°æ®åº“æ“ä½œå’Œä¸šåŠ¡é€»è¾‘ï¼ŒWebSocketå‘é€éƒ¨åˆ†å·²åœ¨æ‰‹åŠ¨æµ‹è¯•ä¸­éªŒè¯

#### ğŸš§ å¾…å®Œæˆå·¥ä½œ

**Task 4.8: æ§åˆ¶æŒ‡ä»¤APIé›†æˆæµ‹è¯•**
- å¾…è¡¥å……ï¼šæµ‹è¯•å®Œæ•´çš„æ§åˆ¶æµç¨‹ï¼ˆå‘é€æŒ‡ä»¤ â†’ æ¥æ”¶ACK â†’ çŠ¶æ€æ›´æ–°ï¼‰
- å¾…è¡¥å……ï¼šæµ‹è¯•æƒé™éªŒè¯å’Œé”™è¯¯å¤„ç†
- ğŸ“ å»ºè®®ï¼šå‚è€ƒç°æœ‰çš„integrationæµ‹è¯•ï¼ˆå¦‚endpoint.api.test.tsï¼‰ç¼–å†™

**Task 9-10: æ€§èƒ½ä¼˜åŒ–å’Œç«¯åˆ°ç«¯æµ‹è¯•**
- âš ï¸ å·²é€šè¿‡æ‰‹åŠ¨æµ‹è¯•è„šæœ¬éªŒè¯ï¼ˆtest-control-api.shã€test-control-command.shï¼‰
- æ€§èƒ½æµ‹è¯•ï¼šéªŒè¯æŒ‡ä»¤å“åº”å»¶è¿Ÿ < 2ç§’ï¼ŒæˆåŠŸç‡ > 95%ï¼ˆéœ€ç”Ÿäº§ç¯å¢ƒéªŒè¯ï¼‰
- ç«¯åˆ°ç«¯æµ‹è¯•ï¼šå·²é€šè¿‡çœŸå®è®¾å¤‡æµ‹è¯•éªŒè¯å®Œæ•´æµç¨‹
- æµè§ˆå™¨å…¼å®¹æ€§æµ‹è¯•ï¼šå»ºè®®æ‰‹åŠ¨æµ‹è¯•ï¼ˆChromeã€Firefoxã€Safariã€Edgeï¼‰
- ç§»åŠ¨ç«¯å“åº”å¼å¸ƒå±€æµ‹è¯•ï¼šå·²é€šè¿‡Gridå“åº”å¼å¸ƒå±€å®ç°ï¼ˆxs:24, sm:12, md:8, lg:6ï¼‰

### File List

#### åç«¯æ–‡ä»¶ï¼ˆVersion 1.0 - ä¿æŒä¸å˜ï¼‰

**æ–°å¢æ–‡ä»¶ï¼š**
- `packages/backend/src/services/control-command.service.ts` - æ§åˆ¶æŒ‡ä»¤æœåŠ¡å±‚
- `packages/backend/src/controllers/control.controller.ts` - æ§åˆ¶æŒ‡ä»¤æ§åˆ¶å™¨
- `packages/backend/src/routes/control.routes.ts` - æ§åˆ¶æŒ‡ä»¤è·¯ç”±

**æ–°å¢æµ‹è¯•æ–‡ä»¶ï¼ˆVersion 2.2 - 2025-10-31ï¼‰ï¼š**
- `packages/backend/tests/unit/message-router.test.ts` - WebSocketç‚¹å¯¹ç‚¹æ¶ˆæ¯è·¯ç”±å•å…ƒæµ‹è¯•ï¼ˆ10ä¸ªæµ‹è¯•ç”¨ä¾‹ï¼Œå…¨éƒ¨é€šè¿‡âœ…ï¼‰
- `packages/backend/tests/websocket/control-flow.test.ts` - WebSocketæ§åˆ¶æµç¨‹é›†æˆæµ‹è¯•ï¼ˆå·²åˆ›å»ºï¼Œæ‰‹åŠ¨æµ‹è¯•æ›¿ä»£ï¼‰
- `packages/backend/tests/unit/services/control-command.service.test.ts` - æ§åˆ¶æŒ‡ä»¤æœåŠ¡å•å…ƒæµ‹è¯•ï¼ˆ11ä¸ªæµ‹è¯•ç”¨ä¾‹ï¼‰

**ä¿®æ”¹æ–‡ä»¶ï¼š**
- `packages/backend/prisma/schema.prisma` - æ·»åŠ  ControlCommand æ¨¡å‹ï¼Œæ‰©å±• Device å’Œ Endpoint å…³è”
- `packages/backend/src/websocket/connection-manager.ts` - æ·»åŠ  getDeviceConnection() æ–¹æ³•
- `packages/backend/src/websocket/message-router.ts` - æ·»åŠ  sendToDevice() å‡½æ•°
- `packages/backend/src/websocket/server.ts` - æ·»åŠ  handleControlAck() å‡½æ•°å’Œæ§åˆ¶ACKæ¶ˆæ¯æ£€æµ‹
- `packages/backend/src/app.ts` - æ³¨å†Œæ§åˆ¶æŒ‡ä»¤è·¯ç”±

---

#### å‰ç«¯æ–‡ä»¶ï¼ˆVersion 2.0 - è®¾è®¡å˜æ›´ï¼‰

**æ–°å¢æ–‡ä»¶ï¼ˆVersion 2.0ï¼‰ï¼š**
- `packages/frontend/src/components/endpoints/ConfigurableControlItem.tsx` - **å¯é…ç½®æ§åˆ¶ç»„ä»¶é¡¹**ï¼ˆæ ¹æ®é…ç½®æ¸²æŸ“4ç§æ§åˆ¶ç±»å‹ï¼šswitch/number/slider/buttonï¼‰
- `packages/frontend/src/components/endpoints/ControlConfigModal.tsx` - **æ§åˆ¶é…ç½®å¯¹è¯æ¡†**ï¼ˆæ·»åŠ /ç¼–è¾‘æ§åˆ¶é…ç½®ï¼‰

**æ–°å¢æ–‡ä»¶ï¼ˆVersion 1.0 - ç»§ç»­ä½¿ç”¨ï¼‰ï¼š**
- `packages/frontend/src/services/control.service.ts` - æ§åˆ¶æŒ‡ä»¤APIæœåŠ¡ï¼ˆsendControlCommandã€getControlCommandHistoryã€getControlCommandDetailï¼‰

**æ–°å¢ä½†å·²å¼ƒç”¨çš„æ–‡ä»¶ï¼ˆVersion 1.0ï¼‰ï¼š**
- `packages/frontend/src/components/endpoints/DeviceControlTab.tsx` - ~~è®¾å¤‡æ§åˆ¶Tabç»„ä»¶~~ï¼ˆå·²è¢« DataHistoryTab çš„æ§åˆ¶é¢æ¿æ›¿ä»£ï¼‰
- `packages/frontend/src/components/endpoints/ControlPanel.tsx` - ~~å›ºå®šæ§åˆ¶é¢æ¿ç»„ä»¶~~ï¼ˆå·²è¢« ConfigurableControlItem æ›¿ä»£ï¼‰
- `packages/frontend/src/components/endpoints/ControlHistoryTable.tsx` - ~~æ§åˆ¶å†å²è¡¨æ ¼ç»„ä»¶~~ï¼ˆæš‚æ—¶ä¿ç•™ï¼Œå¯é€‰åŠŸèƒ½ï¼‰

**ä¿®æ”¹æ–‡ä»¶ï¼ˆVersion 2.0ï¼‰ï¼š**
- `packages/frontend/src/components/endpoints/DataHistoryTab.tsx` - **é‡æ„**ï¼šæ·»åŠ å¯æŠ˜å çš„"è®¾å¤‡æ§åˆ¶é¢æ¿"åŒºåŸŸï¼ˆCollapseç»„ä»¶ï¼‰ï¼Œé›†æˆæ§åˆ¶é…ç½®ç®¡ç†å’Œè®¾å¤‡æ§åˆ¶åŠŸèƒ½
- `packages/frontend/src/pages/EndpointDetailPage.tsx` - **ä¿®æ”¹**ï¼šç§»é™¤ç‹¬ç«‹çš„"è®¾å¤‡æ§åˆ¶"Tabï¼ˆç¬¬5ä¸ªTabï¼‰ï¼Œæ³¨é‡Šæ‰ DeviceControlTab å¯¼å…¥å’Œä½¿ç”¨

---

#### ä¿®æ”¹æ–‡ä»¶ï¼ˆVersion 2.1 - Bug Fix - 2025-10-31ï¼‰

**åç«¯ä¿®æ”¹æ–‡ä»¶ï¼š**
- `packages/backend/src/controllers/visualization.controller.ts` - **æ–°å¢**ï¼š`getDevicesOnlineStatusHandler()` å‡½æ•°ï¼ˆå®æ—¶åœ¨çº¿çŠ¶æ€æ£€æµ‹APIï¼‰
- `packages/backend/src/routes/visualization.routes.ts` - **æ–°å¢**ï¼šæ³¨å†Œåœ¨çº¿çŠ¶æ€æ£€æµ‹è·¯ç”±
- `packages/backend/src/controllers/endpoint.controller.ts` - **ä¿®å¤**ï¼š`getEndpointDevices()` å‡½æ•°çš„åœ¨çº¿çŠ¶æ€åˆ¤æ–­é€»è¾‘ï¼ˆå®æ—¶æ£€æµ‹æ›¿ä»£æ—¶é—´æˆ³ï¼‰

**å‰ç«¯ä¿®æ”¹æ–‡ä»¶ï¼š**
- `packages/frontend/src/services/visualization.service.ts` - **æ–°å¢**ï¼š`getDevicesOnlineStatus()` å‡½æ•°ï¼ˆè°ƒç”¨åœ¨çº¿çŠ¶æ€APIï¼‰
- `packages/frontend/src/components/endpoints/DataHistoryTab.tsx` - **ä¿®å¤**ï¼šæ·»åŠ å®æ—¶åœ¨çº¿çŠ¶æ€æ£€æµ‹é€»è¾‘ï¼ˆå®šæœŸåˆ·æ–° + `isDeviceOnline()` å‡½æ•°é‡æ„ï¼‰

---

#### æ–‡ä»¶å˜æ›´å¯¹ç…§è¡¨

| æ–‡ä»¶è·¯å¾„ | Version 1.0 | Version 2.0 | Version 2.1 | å˜æ›´è¯´æ˜ |
|---------|------------|------------|-------------|---------|
| ConfigurableControlItem.tsx | - | âœ… æ–°å¢ | - | å¯é…ç½®æ§åˆ¶ç»„ä»¶ï¼Œæ”¯æŒ4ç§ç±»å‹ |
| ControlConfigModal.tsx | - | âœ… æ–°å¢ | - | æ§åˆ¶é…ç½®å¯¹è¯æ¡† |
| DataHistoryTab.tsx | ğŸ“Š æ•°æ®æŸ¥è¯¢ | ğŸ“Š æ•°æ®æŸ¥è¯¢ + ğŸ® æ§åˆ¶é¢æ¿ | ğŸ› åœ¨çº¿çŠ¶æ€ä¿®å¤ | æ•´åˆæ§åˆ¶åŠŸèƒ½ + å®æ—¶åœ¨çº¿æ£€æµ‹ |
| EndpointDetailPage.tsx | 5ä¸ªTabï¼ˆå«è®¾å¤‡æ§åˆ¶ï¼‰ | 4ä¸ªTabï¼ˆç§»é™¤è®¾å¤‡æ§åˆ¶ï¼‰ | - | ç§»é™¤ç‹¬ç«‹æ§åˆ¶Tab |
| DeviceControlTab.tsx | âœ… ç‹¬ç«‹Tab | âŒ å·²å¼ƒç”¨ | - | è¢«DataHistoryTabæ›¿ä»£ |
| ControlPanel.tsx | âœ… å›ºå®šé¢æ¿ | âŒ å·²å¼ƒç”¨ | - | è¢«ConfigurableControlItemæ›¿ä»£ |
| control.service.ts | âœ… ä½¿ç”¨ | âœ… ç»§ç»­ä½¿ç”¨ | - | APIæœåŠ¡ä¿æŒä¸å˜ |
| visualization.controller.ts | - | - | ğŸ› æ–°å¢API | å®æ—¶åœ¨çº¿çŠ¶æ€æ£€æµ‹ |
| visualization.service.ts | - | - | ğŸ› æ–°å¢å‡½æ•° | åœ¨çº¿çŠ¶æ€APIè°ƒç”¨ |
| endpoint.controller.ts | ğŸ“Š è®¾å¤‡åˆ—è¡¨ | - | ğŸ› åœ¨çº¿çŠ¶æ€ä¿®å¤ | å®æ—¶æ£€æµ‹æ›¿ä»£æ—¶é—´æˆ³ |

## QA Results

_å¾…QAä»£ç†å¡«å†™_
