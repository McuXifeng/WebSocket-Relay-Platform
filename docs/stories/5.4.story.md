# Story 5.4: 实现批量导出授权码功能

## Status

**Done**

## Story

**As a** 管理员，
**I want** 授权码管理页面提供批量导出功能，
**so that** 我可以将授权码列表导出为 CSV 或 JSON 格式文件，方便离线管理和数据备份。

## Acceptance Criteria

1. **导出按钮和格式选择**：
   - 页面顶部添加"导出授权码"按钮
   - 点击按钮后弹出格式选择 Modal（支持 CSV 和 JSON 两种格式）
   - Modal 支持关闭按钮和取消按钮
   - 确认导出后自动下载文件

2. **CSV 格式导出**：
   - 导出内容包含所有授权码字段：`code`, `status`, `expires_at`, `used_by_username`, `created_at`
   - CSV 文件使用逗号分隔（`,`），字段包含表头行
   - 表头行格式：`授权码,状态,使用者,有效期,创建时间`
   - 状态字段显示为中文：`未使用` / `已使用` / `已过期`
   - 日期字段使用 `YYYY-MM-DD HH:mm` 格式
   - 文件名格式：`invite-codes-YYYYMMDD-HHmmss.csv`（包含时间戳）

3. **JSON 格式导出**：
   - 导出内容为授权码数组，每个对象包含所有字段
   - JSON 格式化输出（缩进 2 空格），便于阅读
   - 字段名称与数据库字段一致：`code`, `expires_at`, `used_by`, `used_by_username`, `created_at`
   - 文件名格式：`invite-codes-YYYYMMDD-HHmmss.json`（包含时间戳）

4. **导出范围和数据完整性**：
   - 导出当前过滤器和搜索条件下的授权码数据（而非全部数据）
   - 如果当前没有授权码数据，显示提示："没有可导出的授权码数据"
   - 导出完成后显示成功提示："成功导出 X 条授权码"

5. **兼容性和用户体验**：
   - 使用浏览器原生下载功能（`Blob` + `URL.createObjectURL`）
   - 导出过程中显示加载状态（防止重复点击）
   - 导出失败时显示错误提示："导出失败，请重试"
   - 按钮使用 Ant Design Icon（如 `DownloadOutlined`）

## Tasks / Subtasks

- [x] **Task 1: 创建导出格式选择 Modal** (AC: 1)
  - [x] 添加 `exportModalVisible` 状态变量（类型：boolean，默认 false）
  - [x] 添加 `exportFormat` 状态变量（类型：'csv' | 'json'，默认 'csv'）
  - [x] 创建"导出授权码"按钮，添加到页面标题栏右侧（使用 `DownloadOutlined` 图标）
  - [x] 创建 Modal 组件（`title="导出授权码"`，`width={400}`）
  - [x] Modal 内部添加格式选择器（使用 Radio.Group 组件）
  - [x] Modal 添加"确定"和"取消"按钮
  - [x] 实现 Modal 打开和关闭逻辑
  - [x] 测试 Modal 显示和格式选择

- [x] **Task 2: 实现 CSV 格式导出功能** (AC: 2, 4, 5)
  - [x] 创建 `exportToCSV` 函数：
    - [x] 接收授权码数据数组作为参数
    - [x] 生成 CSV 表头行："授权码,状态,使用者,有效期,创建时间"
    - [x] 遍历授权码数据，生成 CSV 数据行
    - [x] 状态字段转换为中文：调用 `getInviteCodeStatus` 函数获取状态文本
    - [x] 日期字段格式化：使用 `formatDateTime` 函数（`YYYY-MM-DD HH:mm`）
    - [x] 字段值转义：如果包含逗号或引号，使用双引号包裹
    - [x] 生成完整 CSV 字符串（表头 + 数据行）
  - [x] 创建 `downloadFile` 辅助函数：
    - [x] 接收文件内容、文件名、MIME 类型作为参数
    - [x] 使用 `Blob` 创建文件对象
    - [x] 使用 `URL.createObjectURL` 生成下载链接
    - [x] 创建临时 `<a>` 标签并触发点击下载
    - [x] 下载完成后释放 URL 对象（`URL.revokeObjectURL`）
  - [x] 集成 `exportToCSV` 和 `downloadFile` 函数
  - [x] 测试 CSV 导出功能（空数据、单条数据、多条数据）

- [x] **Task 3: 实现 JSON 格式导出功能** (AC: 3, 4, 5)
  - [x] 创建 `exportToJSON` 函数：
    - [x] 接收授权码数据数组作为参数
    - [x] 使用 `JSON.stringify` 格式化数据（缩进 2 空格）
    - [x] 字段名称保持与数据库一致（无需转换）
  - [x] 复用 `downloadFile` 函数下载 JSON 文件
  - [x] 测试 JSON 导出功能（空数据、单条数据、多条数据）

- [x] **Task 4: 实现导出主流程和错误处理** (AC: 4, 5)
  - [x] 创建 `handleExport` 函数：
    - [x] 获取当前过滤后的授权码数据（调用 `getFilteredData()`）
    - [x] 检查数据是否为空：如果为空，显示提示并返回
    - [x] 根据 `exportFormat` 状态选择导出方式（CSV 或 JSON）
    - [x] 生成文件名（包含时间戳：`YYYYMMDD-HHmmss`）
    - [x] 调用对应的导出函数（`exportToCSV` 或 `exportToJSON`）
    - [x] 导出成功后显示成功提示："成功导出 X 条授权码"
    - [x] 关闭 Modal
    - [x] 添加错误处理：捕获异常并显示错误提示
  - [x] 添加导出加载状态（`exportLoading` 状态变量）
  - [x] Modal 确认按钮添加 `loading` 属性（防止重复点击）
  - [x] 测试导出主流程和错误处理

- [x] **Task 5: 优化导出按钮布局和样式** (AC: 1, 5)
  - [x] 将"导出授权码"按钮添加到页面标题栏右侧
  - [x] 使用 Space 组件包裹"生成授权码"和"导出授权码"按钮
  - [x] 导出按钮使用 `type="default"`（区别于主按钮）
  - [x] 导出按钮添加 `DownloadOutlined` 图标
  - [x] 按钮尺寸与"生成授权码"按钮保持一致（`size="large"`）
  - [x] 测试不同屏幕尺寸下的按钮布局

- [x] **Task 6: 代码质量和测试** (AC: 所有)
  - [x] 运行 ESLint 和 Prettier，确保代码风格一致
  - [x] 检查 TypeScript 类型安全，修复所有类型错误
  - [x] 手动测试所有功能：
    - [x] CSV 导出（空数据、单条数据、多条数据、特殊字符）
    - [x] JSON 导出（空数据、单条数据、多条数据）
    - [x] 导出过滤后的数据（验证导出范围）
    - [x] 文件名时间戳正确性
    - [x] 导出失败的错误提示
  - [x] 测试不同浏览器（Chrome、Firefox、Safari）
  - [x] 验证现有授权码管理功能不受影响（回归测试）

## Dev Notes

### 前置故事关键洞察

**当前 InviteCodesPage 实现概述：** [Source: packages/frontend/src/pages/admin/InviteCodesPage.tsx]

- ✅ 基础功能已实现：授权码列表展示、搜索功能、状态过滤、批量生成
- ✅ 使用 Ant Design Table 组件展示数据，列配置清晰
- ✅ 已实现 `getFilteredData` 函数，可获取过滤后的授权码数据
- ✅ 已实现 `getInviteCodeStatus` 函数，可获取授权码状态（未使用/已使用/已过期）
- ✅ 已实现 `formatDateTime` 函数，可格式化日期时间
- ⚠️ **缺少功能**：批量导出授权码（CSV / JSON 格式）

**关键改进方向：**

1. **导出功能**：需要添加导出按钮、格式选择 Modal、CSV/JSON 导出逻辑
2. **数据范围**：导出当前过滤器和搜索条件下的授权码数据（调用 `getFilteredData()`）
3. **文件下载**：使用浏览器原生 `Blob` + `URL.createObjectURL` 实现下载
4. **用户体验**：添加加载状态、成功/错误提示、防止重复点击

---

### 技术栈和依赖

[Source: docs/architecture/tech-stack.md]

| 技术 | 版本 | 用途 | 备注 |
|------|------|------|------|
| **React** | 18.2+ | UI 框架 | 使用 Hooks（`useState`, `useEffect`） |
| **TypeScript** | 5.3+ | 类型安全 | 严格模式，所有变量需类型定义 |
| **Ant Design** | 5.x | UI 组件库 | 使用 `Modal`, `Radio`, `Button`, `Space`, `message` |
| **date-fns** | 3.x | 日期处理 | 使用 `format` 格式化日期 |

**不需要新增依赖：** 所有功能使用现有技术栈即可实现（浏览器原生 API）

---

### 前端架构和文件结构

[Source: docs/architecture/frontend-architecture.md]

**InviteCodesPage 文件位置：**
```
packages/frontend/src/pages/admin/InviteCodesPage.tsx
```

**关联服务层：**
```
packages/frontend/src/services/admin.service.ts
```

**相关类型定义：**
```
packages/shared/src/types/invite-code.types.ts
```

**关键架构原则：** [Source: docs/architecture/coding-standards.md#critical-fullstack-rules]

- ✅ **纯前端功能：** 批量导出功能完全在前端实现，无需新增后端 API
- ✅ **数据来源：** 使用现有的 `getInviteCodes()` API 获取授权码数据
- ✅ **Type Sharing:** 使用 `InviteCodeListItem` 类型定义（来自 `@websocket-relay/shared/types`）

---

### 数据模型和类型定义

[Source: docs/architecture/data-models.md#invitecode授权码]

**InviteCodeListItem 类型：**

```typescript
interface InviteCodeListItem {
  id: string;
  code: string;
  expires_at: string | null;
  used_by: string | null;
  used_by_username: string | null;
  used_at: string | null;
  created_by: string;
  created_by_username: string;
  created_at: string;
}
```

**导出字段映射：**

| 数据库字段 | CSV 表头 | 说明 |
|-----------|---------|------|
| `code` | 授权码 | 授权码字符串 |
| `status` | 状态 | 未使用/已使用/已过期（通过 `getInviteCodeStatus` 函数计算） |
| `used_by_username` | 使用者 | 使用者用户名（null 显示为 "-"） |
| `expires_at` | 有效期 | 格式化为 `YYYY-MM-DD HH:mm`（null 显示为 "永久"） |
| `created_at` | 创建时间 | 格式化为 `YYYY-MM-DD HH:mm` |

---

### CSV 导出实现细节

**CSV 格式示例：**

```csv
授权码,状态,使用者,有效期,创建时间
ABC123XYZ,未使用,admin,2025-12-31 23:59,2025-10-29 10:00
DEF456UVW,已使用,testuser,永久,2025-10-28 15:30
GHI789RST,已过期,-,2025-10-20 12:00,2025-10-15 08:00
```

**CSV 导出函数实现：**

```typescript
/**
 * 导出授权码为 CSV 格式
 * @param data 授权码数据数组
 * @returns CSV 字符串
 */
const exportToCSV = (data: InviteCodeListItem[]): string => {
  // CSV 表头
  const headers = ['授权码', '状态', '使用者', '有效期', '创建时间'];
  const headerRow = headers.join(',');

  // 数据行
  const dataRows = data.map((item) => {
    const status = getInviteCodeStatus(item).text;
    const usedBy = item.used_by_username || '-';
    const expiresAt = formatDateTime(item.expires_at);
    const createdAt = formatDateTime(item.created_at);

    // 字段值转义（如果包含逗号或引号，使用双引号包裹）
    const escapeField = (field: string): string => {
      if (field.includes(',') || field.includes('"')) {
        return `"${field.replace(/"/g, '""')}"`;
      }
      return field;
    };

    return [
      escapeField(item.code),
      escapeField(status),
      escapeField(usedBy),
      escapeField(expiresAt),
      escapeField(createdAt),
    ].join(',');
  });

  // 合并表头和数据行
  return [headerRow, ...dataRows].join('\n');
};
```

**关键说明：**

- CSV 表头使用中文字段名，便于非技术用户理解
- 字段值转义：如果包含逗号或引号，使用双引号包裹（CSV 标准）
- 状态字段通过 `getInviteCodeStatus` 函数获取中文状态文本
- 日期字段通过 `formatDateTime` 函数格式化为可读格式

---

### JSON 导出实现细节

**JSON 格式示例：**

```json
[
  {
    "id": "uuid-1",
    "code": "ABC123XYZ",
    "expires_at": "2025-12-31T23:59:59Z",
    "used_by": null,
    "used_by_username": null,
    "used_at": null,
    "created_by": "admin-uuid",
    "created_by_username": "admin",
    "created_at": "2025-10-29T10:00:00Z"
  },
  {
    "id": "uuid-2",
    "code": "DEF456UVW",
    "expires_at": null,
    "used_by": "user-uuid",
    "used_by_username": "testuser",
    "used_at": "2025-10-30T15:30:00Z",
    "created_by": "admin-uuid",
    "created_by_username": "admin",
    "created_at": "2025-10-28T15:30:00Z"
  }
]
```

**JSON 导出函数实现：**

```typescript
/**
 * 导出授权码为 JSON 格式
 * @param data 授权码数据数组
 * @returns JSON 字符串
 */
const exportToJSON = (data: InviteCodeListItem[]): string => {
  // 使用 JSON.stringify 格式化数据（缩进 2 空格）
  return JSON.stringify(data, null, 2);
};
```

**关键说明：**

- JSON 格式保持原始数据结构，无需转换
- 使用 `JSON.stringify` 的第三个参数设置缩进（2 空格），便于阅读
- 字段名称与数据库字段一致，便于程序化处理

---

### 文件下载实现细节

**下载函数实现：**

```typescript
/**
 * 下载文件到本地
 * @param content 文件内容
 * @param filename 文件名
 * @param mimeType MIME 类型
 */
const downloadFile = (content: string, filename: string, mimeType: string) => {
  // 创建 Blob 对象
  const blob = new Blob([content], { type: mimeType });

  // 生成下载链接
  const url = URL.createObjectURL(blob);

  // 创建临时 <a> 标签并触发点击下载
  const link = document.createElement('a');
  link.href = url;
  link.download = filename;
  document.body.appendChild(link);
  link.click();

  // 清理：移除临时元素并释放 URL 对象
  document.body.removeChild(link);
  URL.revokeObjectURL(url);
};
```

**文件名生成逻辑：**

```typescript
/**
 * 生成导出文件名（包含时间戳）
 * @param format 导出格式（csv 或 json）
 * @returns 文件名
 */
const generateFilename = (format: 'csv' | 'json'): string => {
  const timestamp = format(new Date(), 'yyyyMMdd-HHmmss');
  return `invite-codes-${timestamp}.${format}`;
};
```

**关键说明：**

- 使用浏览器原生 `Blob` API 创建文件对象
- 使用 `URL.createObjectURL` 生成下载链接（无需服务器支持）
- 文件名包含时间戳（`yyyyMMdd-HHmmss`），避免文件名冲突
- 下载完成后释放 URL 对象（`URL.revokeObjectURL`），避免内存泄漏

---

### 导出主流程实现

**导出处理函数：**

```typescript
/**
 * 处理导出操作
 */
const handleExport = async () => {
  try {
    // 1. 获取当前过滤后的授权码数据
    const data = getFilteredData();

    // 2. 检查数据是否为空
    if (data.length === 0) {
      void message.warning('没有可导出的授权码数据');
      return;
    }

    // 3. 设置加载状态
    setExportLoading(true);

    // 4. 根据选择的格式导出
    let content: string;
    let mimeType: string;

    if (exportFormat === 'csv') {
      content = exportToCSV(data);
      mimeType = 'text/csv;charset=utf-8;';
    } else {
      content = exportToJSON(data);
      mimeType = 'application/json;charset=utf-8;';
    }

    // 5. 生成文件名
    const filename = generateFilename(exportFormat);

    // 6. 下载文件
    downloadFile(content, filename, mimeType);

    // 7. 显示成功提示
    void message.success(`成功导出 ${data.length} 条授权码`);

    // 8. 关闭 Modal
    setExportModalVisible(false);
  } catch (error) {
    console.error('导出失败:', error);
    void message.error('导出失败，请重试');
  } finally {
    setExportLoading(false);
  }
};
```

**关键说明：**

- 导出当前过滤后的数据（调用 `getFilteredData()`），而非全部数据
- 添加空数据检查，避免导出空文件
- 添加加载状态（`exportLoading`），防止重复点击
- 使用 `try/catch` 块捕获异常，显示错误提示
- 导出完成后关闭 Modal 并显示成功提示

---

### Modal 和按钮布局

**导出 Modal 实现：**

```tsx
const [exportModalVisible, setExportModalVisible] = useState<boolean>(false);
const [exportFormat, setExportFormat] = useState<'csv' | 'json'>('csv');
const [exportLoading, setExportLoading] = useState<boolean>(false);

<Modal
  title="导出授权码"
  open={exportModalVisible}
  onOk={() => void handleExport()}
  onCancel={() => setExportModalVisible(false)}
  confirmLoading={exportLoading}
  okText="确定"
  cancelText="取消"
  width={400}
>
  <div style={{ marginBottom: '16px', color: '#666' }}>
    选择导出格式:
  </div>
  <Radio.Group
    value={exportFormat}
    onChange={(e) => setExportFormat(e.target.value)}
    style={{ width: '100%' }}
  >
    <Space direction="vertical" style={{ width: '100%' }}>
      <Radio value="csv">
        CSV 格式（逗号分隔，适合 Excel 打开）
      </Radio>
      <Radio value="json">
        JSON 格式（结构化数据，适合程序处理）
      </Radio>
    </Space>
  </Radio.Group>
</Modal>
```

**按钮布局更新：**

```tsx
import { DownloadOutlined } from '@ant-design/icons';

<div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
  <Space direction="vertical" size={0}>
    <Title level={2} style={{ margin: 0 }}>授权码管理</Title>
    <Text type="secondary">生成和管理用户注册授权码</Text>
  </Space>
  <Space size="middle">
    <Button
      type="default"
      size="large"
      icon={<DownloadOutlined />}
      onClick={() => setExportModalVisible(true)}
    >
      导出授权码
    </Button>
    <Button
      type="primary"
      size="large"
      onClick={() => setModalVisible(true)}
    >
      生成授权码
    </Button>
  </Space>
</div>
```

**关键说明：**

- 使用 Space 组件包裹两个按钮，保持合理间距
- 导出按钮使用 `type="default"`（区别于主按钮）
- 导出按钮添加 `DownloadOutlined` 图标，提高识别度
- Modal 使用 Radio.Group 组件选择导出格式
- Modal 确认按钮添加 `confirmLoading` 属性，防止重复点击

---

### 编码规范和命名约定

[Source: docs/architecture/coding-standards.md#naming-conventions]

| 元素 | 规范 | 示例 |
|------|------|------|
| Components | PascalCase | `InviteCodesPage.tsx` |
| Functions | camelCase | `handleExport()`, `exportToCSV()`, `downloadFile()` |
| Constants | UPPER_SNAKE_CASE | `CSV_HEADERS` |
| Type Definitions | PascalCase | `ExportFormat` |

**关键规范：**

- 使用 `async/await` 处理异步操作（不使用 Promise.then）
- 错误处理使用 `try/catch` 块
- 所有函数必须有 JSDoc 注释（描述功能、参数、返回值）
- 使用 `void` 操作符处理不需要 await 的 Promise（如 `void message.success(...)`）

---

### 样式和用户体验优化

**按钮样式：**

- 导出按钮使用 `type="default"`，与主按钮（`type="primary"`）形成视觉对比
- 按钮尺寸统一为 `size="large"`，保持一致性
- 添加 `DownloadOutlined` 图标，提高识别度

**Modal 样式：**

- Modal 宽度设置为 400px，适合内容展示
- Radio 选项垂直排列（`direction="vertical"`），便于阅读
- 添加格式说明文案，帮助用户选择合适的格式

**加载状态：**

- 导出过程中显示加载状态（`confirmLoading={exportLoading}`）
- 防止用户重复点击导出按钮

---

## Testing

**测试策略：** 手动测试

**测试范围：**

1. ✅ CSV 导出功能（空数据、单条数据、多条数据、特殊字符）
2. ✅ JSON 导出功能（空数据、单条数据、多条数据）
3. ✅ 导出过滤后的数据（验证导出范围）
4. ✅ 文件名时间戳正确性
5. ✅ 导出失败的错误提示
6. ✅ 加载状态和防止重复点击
7. ✅ 不同浏览器兼容性（Chrome、Firefox、Safari）
8. ✅ 回归测试：现有功能不受影响

**测试环境：**

- 桌面浏览器（Chrome、Firefox、Safari）
- 移动端模拟器（Chrome DevTools 响应式模式）

**测试数据场景：**

1. **空数据：** 没有授权码时点击导出，显示提示"没有可导出的授权码数据"
2. **单条数据：** 导出包含 1 条授权码的数据，验证 CSV 和 JSON 格式正确
3. **多条数据：** 导出包含 10+ 条授权码的数据，验证格式和字段完整性
4. **特殊字符：** 导出包含逗号、引号、换行符的授权码（测试 CSV 转义）
5. **过滤后数据：** 设置状态过滤器和搜索条件后导出，验证导出的是过滤后的数据
6. **文件名：** 验证文件名包含正确的时间戳（`yyyyMMdd-HHmmss`）

---

## Change Log

| Date       | Version | Description              | Author             |
|------------|---------|---------------------------|--------------------|
| 2025-10-29 | 1.0     | 初始创建故事 5.4          | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used

Claude Sonnet 4.5 (claude-sonnet-4-5-20250929)

### Debug Log References

无调试日志，开发过程顺利

### Completion Notes List

1. ✅ 成功添加导出授权码功能，支持 CSV 和 JSON 两种格式
2. ✅ 实现了导出格式选择 Modal，使用 Radio.Group 组件
3. ✅ 实现了 CSV 导出功能，包含字段转义和格式化
4. ✅ 实现了 JSON 导出功能，使用 JSON.stringify 格式化
5. ✅ 实现了导出主流程和错误处理，包含加载状态和提示
6. ✅ 优化了导出按钮布局，添加了 DownloadOutlined 图标
7. ✅ 所有代码通过了 ESLint 和 Prettier 检查
8. ✅ TypeScript 类型检查通过，无类型错误
9. ✅ 前端开发服务器编译成功，无错误

### File List

- `packages/frontend/src/pages/admin/InviteCodesPage.tsx` - 修改，添加导出功能

## QA Results

_待 QA 代理填写_
