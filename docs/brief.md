# Project Brief: WebSocket 中继共享平台

---

## Executive Summary

**WebSocket 中继共享平台** 是一个基于 React 开发的 WebSocket 服务器共享站，解决开发者没有公网 IP 无法部署 WebSocket 应用的问题。

**核心功能：**
- 用户通过授权码注册后，可在 Web 界面一键申请专属的 WebSocket 端点
- 平台部署在具有公网 IP 的服务器上，提供稳定的消息转发服务
- 所有 WebSocket 连接都是直接转发，不涉及业务逻辑处理

**解决的问题：**
开发者在学习或开发 WebSocket 应用时，经常遇到以下困难：
- 家庭宽带没有公网 IP，无法让外部设备连接
- 配置服务器、域名、SSL 证书过于复杂
- 临时测试不想购买云服务器

**核心价值：**
零配置、开箱即用。用户仅需授权码注册，点击创建即可获得可用的 WebSocket URL，无需任何服务器运维知识。

**授权码机制：**
- 管理员按需生成授权码（可设置有效期）
- 一次性使用（注册后自动失效）
- 仅管理员有生成权限，保证服务质量

---

## Problem Statement

### 核心问题

开发者在学习或开发 WebSocket 应用时，经常面临以下困难：

**1. 公网 IP 缺失**
- 家庭宽带通常没有公网 IP，或者被运营商 NAT
- 即使有公网 IP，也可能是动态 IP，不稳定
- 企业内网环境无法开放端口

**2. 配置复杂**
搭建可公开访问的 WebSocket 服务器需要：
- 购买云服务器或 VPS
- 配置防火墙和端口转发
- 申请域名和 SSL 证书（wss:// 需要）
- 配置 Nginx 等反向代理

对于只想快速测试功能的开发者来说，这些步骤过于繁琐。

**3. 现有方案的不足**

- **购买云服务器：** 成本高（最低配置年费 600+），配置时间长（2-8 小时），对临时测试来说过重
- **内网穿透工具：** 需要本地和服务器两端配置，免费版限制多且不稳定
- **公共测试服务：** 只提供 echo 等演示功能，无法用于真实应用场景

### 影响场景

**学习阶段：**
- 学习 WebSocket 时想快速验证代码，但本地 localhost 无法分享给他人
- 想展示学习成果，但没有可访问的 Demo 环境

**开发测试：**
- 开发聊天应用、实时游戏等需要多端测试，但缺少公网环境
- 团队协作时需要共享测试环境

**作品展示：**
- 求职时需要在简历中提供可访问的项目 Demo
- 技术分享时需要实时演示效果

---

## Proposed Solution

### 解决方案概述

通过在公网服务器上部署 WebSocket 转发服务，为用户提供开箱即用的实时通信中继能力。

**系统架构：**

1. **Web 前端（React）**
   - 授权码注册登录
   - 创建和管理 WebSocket 端点
   - 实时查看连接状态和消息流量
   - 复制连接 URL 和查看使用文档

2. **中继服务器**
   - 根据端点 ID 进行消息路由
   - 在多个客户端之间透明转发消息
   - 维护连接状态，处理断线重连
   - 每个用户的端点完全隔离

3. **管理后台**
   - 生成和管理授权码
   - 查看用户和端点统计
   - 监控系统负载和连接状况

**工作原理：**

```
客户端 A (ws://platform.com/ws/{user_endpoint_id})
          ↕
    中继服务器（纯转发）
          ↕
客户端 B (ws://platform.com/ws/{user_endpoint_id})
```

用户只需连接到平台提供的 WebSocket URL，所有消息自动在同一端点的客户端之间转发。

### 核心特点

**1. 零配置**
- Web 界面点击创建 → 获得 URL → 立即使用
- 不需要购买服务器、配置域名、申请证书

**2. 纯转发**
- 服务器不解析消息内容
- 不涉及任何业务逻辑
- 确保最大兼容性和性能

**3. 授权码控制**
- 通过邀请制保证服务质量
- 防止恶意滥用

**4. 实时监控**
- 查看当前连接数
- 监控消息流量
- 帮助快速调试

### 项目目标

**短期目标：**
- 实现基础的 WebSocket 转发功能
- 提供简单易用的 Web 界面
- 支持基本的连接监控

**后续可能扩展：**
- 消息持久化和历史记录
- 更详细的流量分析
- 多种协议支持（Socket.io、MQTT 等）

---

## Target Users

**主要用户：个人开发者**
- 需要快速测试 WebSocket 功能的开发者
- 缺少公网 IP 或不想花时间配置服务器
- 希望分享实时 Demo 给朋友、导师或放在作品集中
- 学习 WebSocket 技术时需要实践环境

**次要用户：小团队和教育场景**
- **小型团队：** 原型开发和客户演示，需要临时的 WebSocket 测试环境
- **学生/教师：** 课堂教学、作业展示，需要简单易用的实验平台

**核心需求：**
- ✅ 零配置快速创建 WebSocket 端点（不超过 1 分钟）
- ✅ 稳定可靠的消息转发（多客户端互通）
- ✅ 基础的连接监控和调试信息
- 📋 清晰的使用文档和代码示例
- 📋 授权码管理（管理员可控制用户准入）

---

## Goals & Success Metrics

### 项目目标

**MVP 阶段目标：**
- 实现核心的 WebSocket 转发功能
- 用户能够通过 Web 界面创建和管理端点
- 提供基础的连接监控
- 授权码系统正常运作

### 成功指标

**功能完成度：**
- ✅ 用户可以用授权码注册
- ✅ 用户可以创建 WebSocket 端点
- ✅ 多个客户端可以通过端点互相通信
- ✅ 可以查看当前连接状态

**用户体验：**
- 从注册到创建端点全流程 < 2 分钟
- 文档清晰，有代码示例
- 界面简洁易用

**系统稳定性：**
- 服务正常运行
- 消息转发延迟低
- 能处理基本的并发连接

---

## MVP Scope

### 核心功能（Must Have）

**1. 用户系统**
- ✅ **授权码注册：** 用户输入授权码完成注册，授权码使用后失效
- ✅ **登录认证：** 基础的用户登录功能（用户名/邮箱 + 密码）
- ✅ **个人中心：** 查看账户信息，管理自己的端点列表

**2. WebSocket 端点管理**
- ✅ **创建端点：** 一键创建专属 WebSocket 端点，自动生成唯一 ID
- ✅ **查看端点：** 显示端点 URL、创建时间、当前连接数
- ✅ **删除端点：** 删除不需要的端点
- ✅ **复制 URL：** 一键复制 WebSocket 连接地址

**3. WebSocket 转发核心**
- ✅ **消息转发：** 同一端点的所有客户端之间自动转发消息
- ✅ **连接管理：** 维护客户端连接，处理断开和重连
- ✅ **端点隔离：** 不同端点的消息完全隔离
- ✅ **广播模式：** 一个客户端发送的消息广播给所有其他连接的客户端

**4. 基础监控**
- ✅ **连接状态：** 实时显示当前在线连接数
- ✅ **消息统计：** 显示消息收发总数
- ✅ **简单日志：** 记录连接/断开事件

**5. 管理后台**
- ✅ **授权码生成：** 管理员可以生成授权码
- ✅ **设置有效期：** 可选设置授权码过期时间
- ✅ **查看状态：** 查看授权码是否已使用
- ✅ **用户列表：** 查看已注册用户和端点统计

**6. 文档与示例**
- ✅ **使用文档：** 说明如何注册、创建端点、连接使用
- ✅ **代码示例：** 提供 JavaScript 客户端连接示例
- ✅ **快速开始：** 5 分钟快速上手指南

---

### 不在 MVP 范围（Out of Scope）

以下功能留待后续版本实现：

- ❌ 消息持久化和历史记录
- ❌ 详细的数据分析和图表
- ❌ 多语言客户端库（Python、Java、Go 等）
- ❌ 消息过滤和转换
- ❌ 私密端点（需要密码才能连接）
- ❌ 团队协作功能
- ❌ API 接口（程序化管理端点）
- ❌ Webhook 通知
- ❌ 多协议支持（Socket.io、MQTT 等）
- ❌ 自定义域名绑定

---

### MVP 成功标准

MVP 被认为完成，当满足以下条件：

**功能验证：**
1. 用户可以用授权码注册并登录
2. 用户可以创建 WebSocket 端点并获得 URL
3. 多个客户端连接到同一端点可以互相通信
4. 管理员可以生成和管理授权码
5. 基础监控数据正确显示

**用户流程验证：**
- 新用户从注册到成功发送第一条消息 < 3 分钟
- 文档清晰，不需要外部帮助即可完成基础操作

**技术验证：**
- 系统可以稳定运行
- 至少支持 10 个并发端点
- 每个端点至少支持 5 个并发连接
- 消息转发延迟 < 100ms

---

### 实现优先级

**P0（第一阶段）：** 核心转发功能
- WebSocket 服务器基础架构
- 消息路由和广播
- 基础的连接管理

**P1（第二阶段）：** 用户界面
- React 前端框架搭建
- 用户注册登录
- 端点创建和管理界面

**P2（第三阶段）：** 管理功能
- 管理后台
- 授权码系统
- 基础监控

**P3（完善阶段）：** 文档和优化
- 使用文档
- 代码示例
- 性能优化和 bug 修复

---

## Technical Considerations

### 技术栈选择

**前端技术栈：**
- **框架：** React 18+
- **UI 库：** Ant Design / Material-UI（选其一）
- **状态管理：** React Context API / Zustand（轻量级）
- **路由：** React Router
- **HTTP 客户端：** Axios
- **WebSocket 客户端：** 原生 WebSocket API

**后端技术栈：**
- **运行时：** Node.js 18+
- **Web 框架：** Express.js
- **WebSocket 库：** ws（原生 WebSocket）
- **数据库：** PostgreSQL / MySQL（持久化数据）
- **ORM：** Prisma / TypeORM
- **认证：** JWT (jsonwebtoken)

**部署与运维：**
- **服务器：** Linux (Ubuntu/Debian)
- **反向代理：** Nginx（处理 SSL 和静态文件）
- **进程管理：** PM2
- **SSL 证书：** Let's Encrypt（免费）

---

### 系统架构

**整体架构设计：**

```
┌─────────────────────────────────────────────────────┐
│                   用户浏览器                          │
│  ┌──────────────┐              ┌─────────────────┐ │
│  │ React 前端   │              │ WebSocket 客户端 │ │
│  │ (管理界面)   │              │  (用户应用)      │ │
│  └──────┬───────┘              └────────┬────────┘ │
└─────────┼────────────────────────────────┼─────────┘
          │                                │
          │ HTTPS                          │ WSS
          │                                │
┌─────────┼────────────────────────────────┼─────────┐
│         ▼                                ▼         │
│  ┌────────────┐                  ┌──────────────┐ │
│  │  Nginx     │                  │   Nginx      │ │
│  │ (反向代理) │                  │ (WebSocket)  │ │
│  └─────┬──────┘                  └──────┬───────┘ │
│        │                                │         │
│        ▼                                ▼         │
│  ┌────────────┐                  ┌──────────────┐ │
│  │ Express    │                  │   WebSocket  │ │
│  │ REST API   │◄─────────────────┤   Server     │ │
│  └─────┬──────┘                  └──────┬───────┘ │
│        │                                │         │
│        ▼                                │         │
│  ┌────────────┐                        │         │
│  │ PostgreSQL │◄───────────────────────┘         │
│  │  数据库    │                                  │
│  └────────────┘                                  │
│                                                   │
│              公网服务器 (Node.js)                 │
└───────────────────────────────────────────────────┘
```

**核心模块：**

1. **用户模块：** 注册、登录、授权码验证
2. **端点模块：** 创建、删除、查询端点
3. **转发模块：** WebSocket 连接管理、消息路由
4. **管理模块：** 授权码生成、用户管理
5. **监控模块：** 统计数据、日志记录

---

### 关键技术决策

**1. 为什么选择原生 WebSocket？**
- ✅ 轻量级，无额外依赖
- ✅ 浏览器原生支持，兼容性好
- ✅ 纯转发场景不需要 Socket.io 的复杂功能
- ⚠️ 缺点：没有自动重连、房间管理等高级功能（可自行实现）

**2. 数据库选择：PostgreSQL vs. MySQL**
- **PostgreSQL：** 功能更丰富，支持 JSON 字段，适合未来扩展
- **MySQL：** 更简单，资源占用少，对 VPS 更友好
- **建议：** 小型部署选 MySQL，后续扩展选 PostgreSQL

**3. 消息路由策略**
- 使用内存 Map 存储端点和连接的映射关系
- 结构：`Map<endpointId, Set<WebSocket>>`
- 消息到达时，查找对应端点的所有连接并广播
- 连接断开时，从 Set 中移除

**4. 身份认证方案**
- REST API 使用 JWT Token（存储在 localStorage）
- WebSocket 连接通过 URL 参数传递 endpointId（无需认证）
- 管理员使用独立的管理员账户和 Token

**5. 并发处理**
- Node.js 单线程事件循环，天然支持高并发 I/O
- 使用 PM2 cluster 模式启动多个进程（利用多核 CPU）
- WebSocket 连接分散到不同进程（需要 Redis 做进程间通信，可后续优化）

---

### 数据库设计（简化版）

**核心表结构：**

```sql
-- 用户表
users
  - id (主键)
  - username (唯一)
  - email (唯一)
  - password_hash
  - is_admin (布尔值)
  - created_at

-- 授权码表
invite_codes
  - id (主键)
  - code (唯一)
  - expires_at (可为空)
  - used_by (外键 → users.id，可为空)
  - used_at (可为空)
  - created_by (外键 → users.id)
  - created_at

-- 端点表
endpoints
  - id (主键)
  - endpoint_id (唯一，用于 URL)
  - user_id (外键 → users.id)
  - name (用户自定义名称)
  - created_at
  - last_active_at

-- 统计表（可选）
endpoint_stats
  - id (主键)
  - endpoint_id (外键)
  - total_connections (累计连接数)
  - total_messages (累计消息数)
  - updated_at
```

---

### 部署架构

**单服务器部署方案：**

```
域名: wss.example.com
  ↓
Nginx (80/443)
  ├── / → React 静态文件
  ├── /api → Express (3000)
  └── /ws → WebSocket Server (3001)

PostgreSQL (5432)
```

**配置要点：**
- Nginx 配置 WebSocket 升级
- Let's Encrypt 自动续期证书
- PM2 守护进程，自动重启
- 日志轮转，防止磁盘占满

---

### 安全考虑

**基础安全措施：**
- ✅ 密码使用 bcrypt 加密存储
- ✅ JWT Token 设置合理过期时间（7 天）
- ✅ HTTPS/WSS 加密传输
- ✅ SQL 注入防护（使用 ORM 参数化查询）
- ✅ XSS 防护（React 默认转义）
- ✅ CORS 配置（限制允许的源）
- ✅ 速率限制（防止暴力破解和 DDoS）

**后续可加强：**
- WebSocket 消息大小限制
- 单用户端点数量限制
- 单端点连接数限制
- IP 黑名单

---

### 性能优化

**初期优化：**
- Nginx 启用 gzip 压缩
- React 生产构建
- 静态资源 CDN（可选）
- 数据库索引优化

**后续优化：**
- Redis 缓存热点数据
- WebSocket 连接池
- 消息队列处理异步任务
- 负载均衡（多服务器部署）

---

## Constraints & Assumptions

### 约束条件

**资源约束：**
- **服务器成本：** 个人项目，初期使用单台服务器（2核4G 配置）
- **带宽限制：** 取决于服务器供应商，需要考虑流量成本
- **开发时间：** 个人开发，利用业余时间，预计 2-3 个月完成 MVP

**技术约束：**
- **单服务器架构：** MVP 阶段不考虑分布式部署
- **数据持久化：** 仅持久化用户和端点信息，消息不持久化
- **并发限制：** 初期支持有限的并发连接（<100）

**功能约束：**
- **仅转发：** 不对消息内容进行解析、过滤或转换
- **无 SLA 保证：** 个人项目，不承诺服务可用性
- **有限支持：** 文档为主，无专职客服

---

### 关键假设

**用户假设：**
- ✅ 用户理解 WebSocket 基础概念
- ✅ 用户有基本的编程能力
- ✅ 用户主要用于开发测试，而非生产环境
- ✅ 通过授权码机制能有效控制用户质量

**技术假设：**
- ✅ Node.js + 原生 WebSocket 足以满足性能需求
- ✅ 单服务器可支撑 MVP 阶段的用户量
- ✅ 消息转发延迟在可接受范围内（<100ms）
- ✅ 不需要复杂的消息持久化和重放功能

**运营假设：**
- ✅ 初期通过个人社交媒体和技术社区推广
- ✅ 授权码控制增长速度，避免服务器过载
- ✅ 用户对免费/低成本服务有一定容忍度
- ✅ 有足够的反馈帮助产品迭代

---

## Risks & Open Questions

### 主要风险

**技术风险：**
- ⚠️ **并发瓶颈：** 单服务器架构可能无法支撑快速增长的用户量
  - **缓解措施：** 通过授权码控制用户增长速度，监控服务器负载

- ⚠️ **服务稳定性：** 个人维护可能无法保证 7x24 稳定运行
  - **缓解措施：** 设置监控告警，PM2 自动重启，定期备份数据

- ⚠️ **安全漏洞：** 可能存在未知的安全问题
  - **缓解措施：** 实施基础安全措施，定期更新依赖，开源接受社区审查

**运营风险：**
- ⚠️ **滥用问题：** 即使有授权码，仍可能被滥用（垃圾消息、恶意流量）
  - **缓解措施：** 设置消息大小限制、频率限制，异常检测机制

- ⚠️ **成本超支：** 流量或用户增长超预期导致服务器成本过高
  - **缓解措施：** 设置流量监控告警，必要时限制单用户配额

**法律风险：**
- ⚠️ **内容责任：** 用户通过平台传输的消息可能涉及违法内容
  - **缓解措施：** 明确服务条款，声明平台仅提供技术服务，不对内容负责

---

### 未决问题

**产品层面：**
1. **是否需要端点密码保护？**
   - 现状：任何知道 URL 的人都可以连接
   - 考虑：部分用户可能需要私密端点

2. **单用户可创建多少个端点？**
   - 需要设置上限防止滥用
   - 建议：MVP 阶段限制为 5 个

3. **端点是否有过期时间？**
   - 长期不活跃的端点是否自动删除
   - 建议：90 天不活跃自动删除

**技术层面：**
1. **数据库选择：PostgreSQL vs. MySQL？**
   - 需要根据实际服务器配置决定
   - 建议：初期 MySQL，后续可迁移

2. **是否需要消息持久化？**
   - MVP 阶段不做，但未来可能需要
   - 需要评估技术复杂度和存储成本

3. **多进程间如何共享 WebSocket 连接？**
   - 使用 PM2 cluster 模式需要 Redis
   - MVP 阶段可以先用单进程

**运营层面：**
1. **如何推广和获取早期用户？**
   - 技术社区发帖、开源项目、个人博客
   - 需要准备宣传材料和 Demo

2. **是否需要用户反馈渠道？**
   - 建议：添加 GitHub Issues 或问卷链接

3. **未来商业化方向？**
   - 暂不考虑，专注 MVP
   - 可能方向：高级功能付费、企业版

---

## Next Steps

### 立即行动（本周）

**1. 技术验证（P0）**
- ✅ 搭建基础开发环境（Node.js + React）
- ✅ 实现最简单的 WebSocket 转发 Demo
- ✅ 验证消息路由逻辑可行性

**2. 项目初始化**
- ✅ 创建 Git 仓库
- ✅ 初始化前后端项目结构
- ✅ 配置基础开发工具（ESLint、Prettier）

---

### 近期计划（2-4 周）

**第一阶段：核心功能开发**
1. 实现 WebSocket 服务器和消息转发
2. 实现基础的端点管理（创建、删除、查询）
3. 设计并实现数据库表结构
4. 完成用户注册登录功能

**第二阶段：界面开发**
1. React 前端框架搭建
2. 实现用户注册登录页面
3. 实现端点管理界面
4. 实现基础监控显示

---

### 中期计划（1-2 个月）

**第三阶段：完善功能**
1. 实现管理后台和授权码系统
2. 添加基础监控和统计
3. 编写使用文档和代码示例
4. 本地测试和 Bug 修复

**第四阶段：部署上线**
1. 购买/准备服务器和域名
2. 配置 Nginx 和 SSL 证书
3. 部署应用并进行压力测试
4. 内测邀请少量用户试用

---

### 长期规划（3 个月后）

**持续迭代：**
- 根据用户反馈优化功能
- 修复 Bug 和性能问题
- 逐步添加增强功能（如消息持久化）
- 评估是否需要扩展服务器

**社区建设：**
- 开源项目，接受社区贡献
- 撰写技术博客分享开发经验
- 在技术社区推广和获取反馈

---

## 项目简报完成 ✅

本项目简报为 **WebSocket 中继共享平台** 提供了从问题分析到技术实现的完整规划。

**关键要点：**
- **核心价值：** 零配置的 WebSocket 转发服务
- **目标用户：** 需要快速测试 WebSocket 的开发者
- **技术方案：** React + Node.js + WebSocket
- **MVP 范围：** 聚焦核心转发功能，授权码控制准入
- **实施计划：** 2-3 个月完成 MVP，分阶段迭代

**下一步：** 开始技术验证和项目初始化！

---

**文档版本：** 1.0
**创建日期：** 2025-10-27
**状态：** 已完成
